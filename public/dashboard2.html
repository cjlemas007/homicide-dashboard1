<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jackson Homicide Tracker | Infographic Dashboard</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* THEME: Midnight Command Center */
            --bg-body: #050505;
            --bg-panel: #0f1116;
            --bg-header: #13151a;
            
            --text-main: #e2e8f0;
            --text-muted: #64748b;
            
            /* ACCENTS */
            --neon-red: #d9534f;
            --neon-blue: #0d6efd;
            --neon-amber: #ffc107;
            --neon-green: #198754;
            --neon-purple: #6f42c1;
            
            --border: #1e293b;
            --glow-red: 0 0 15px rgba(217, 83, 79, 0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- HEADER --- */
        header {
            background-color: var(--bg-header);
            border-bottom: 1px solid var(--border);
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
            flex-shrink: 0;
            z-index: 100;
        }

        .logo-area { display: flex; align-items: center; gap: 10px; min-width: 150px; }
        .logo-text { font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 1.1rem; line-height: 1; text-transform: uppercase; }

        /* Ticker */
        .ticker-container {
            flex: 1;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 4px;
            height: 32px;
            overflow: hidden;
            display: flex;
            align-items: center;
            position: relative;
        }
        .ticker-wrap {
            white-space: nowrap;
            animation: ticker 45s linear infinite; 
            position: absolute;
            left: 100%;
        }
        .ticker-item {
            display: inline-block;
            padding-right: 60px;
            font-family: 'Orbitron', monospace;
            font-size: 0.8rem;
            color: var(--neon-blue);
        }
        @keyframes ticker { 100% { left: -100%; transform: translateX(-100%); } }

        .header-controls { display: flex; gap: 10px; justify-content: flex-end; }
        .btn-header {
            background: var(--border);
            color: var(--text-main);
            border: 1px solid var(--text-muted);
            padding: 6px 12px;
            font-size: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: 600;
        }
        .btn-header:hover { background: var(--neon-blue); border-color: var(--neon-blue); color: white; }

        /* --- LAYOUT GRID --- */
        .dashboard-grid {
            flex: 1;
            padding: 15px;
            display: grid;
            /* Top (Stats/Map) 45% height | Bottom (Charts) 55% height */
            grid-template-rows: 45% 1fr; 
            /* Columns: 1 (Stats), 2 (Map) */
            grid-template-columns: 450px 1fr; 
            gap: 15px;
            width: 100%;
            overflow-y: hidden;
        }

        /* --- CARD STYLES --- */
        .card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .card-header {
            padding: 8px 12px;
            background: rgba(255,255,255,0.02);
            border-bottom: 1px solid var(--border);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body { padding: 10px; flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }

        /* --- TOP LEFT: GAUGES & STATS --- */
        .area-stats {
            grid-column: 1 / 2;
            grid-row: 1 / 2;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .stats-row { display: flex; gap: 10px; flex: 1; }
        
        .stat-box {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 10px;
        }
        
        /* Gauge Specifics */
        .gauge-wrapper { position: relative; width: 100%; height: 90px; display: flex; justify-content: center; }
        .gauge-canvas { width: 100%; height: 100%; }
        .gauge-number {
            position: absolute; bottom: 5px; width: 100%; text-align: center;
            font-family: 'Orbitron'; font-size: 1.8rem; font-weight: 700; color: white;
            text-shadow: var(--glow-red);
        }
        .stat-title { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; }

        .stat-big-number { font-family: 'Orbitron'; font-size: 2rem; font-weight: 700; color: var(--neon-blue); }

        /* --- TOP RIGHT: MAP --- */
        .area-map {
            grid-column: 2 / 3;
            grid-row: 1 / 2;
        }
        #map { width: 100%; height: 100%; background: #000; z-index: 1; }
        
        /* Map Overlays */
        .map-overlay {
            position: absolute;
            background: rgba(15, 17, 22, 0.95);
            border: 1px solid var(--border);
            z-index: 1000;
            padding: 10px;
            border-radius: 4px;
        }
        #map-legend { bottom: 20px; right: 20px; font-size: 0.75rem; color: var(--text-muted); }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        
        #map-info-panel { top: 20px; right: 20px; width: 250px; display: none; }

        /* --- BOTTOM: CHART ROW --- */
        .area-charts {
            grid-column: 1 / 3;
            grid-row: 2 / 3;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr; /* 4 Equal columns for charts */
            gap: 10px;
        }
        
        .chart-container { flex: 1; position: relative; min-height: 0; }

        /* --- MODALS --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 2000;
            justify-content: center; align-items: center;
        }
        .modal-box {
            background: var(--bg-panel); border: 1px solid var(--neon-blue);
            width: 500px; max-width: 90%; padding: 20px; border-radius: 8px;
            box-shadow: 0 0 30px rgba(13, 110, 253, 0.2);
            max-height: 90vh; overflow-y: auto;
        }
        .modal-title { font-family: 'Orbitron'; color: white; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; display: flex; justify-content: space-between; font-size: 1.2rem;}
        .close-modal { cursor: pointer; color: var(--neon-red); font-size: 1.5rem; }

        /* Filter styling */
        .filter-group { margin-bottom: 15px; }
        .filter-group label { display: block; color: var(--neon-blue); font-size: 0.8rem; margin-bottom: 5px; font-family: 'Orbitron'; }
        .checkbox-list { max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 5px; border: 1px solid var(--border); }
        .checkbox-item { display: flex; align-items: center; margin-bottom: 4px; font-size: 0.8rem; padding: 2px; }
        .checkbox-item:hover { background: rgba(255,255,255,0.05); }
        .checkbox-item input { margin-right: 8px; }

        /* Mobile */
        @media (max-width: 1000px) {
            .dashboard-grid {
                display: flex; flex-direction: column;
                height: auto; overflow-y: visible;
            }
            body { overflow-y: auto; }
            .area-map { height: 400px; order: 2; }
            .area-stats { order: 1; }
            .area-charts { order: 3; grid-template-columns: 1fr; height: auto; }
            .card { min-height: 300px; margin-bottom: 10px; }
            header { flex-direction: column; height: auto; padding: 10px; gap: 10px; }
            .ticker-container { width: 100%; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo-area">
            <div style="text-align: left;">
                <div class="logo-text" style="color:var(--neon-red)">Jackson</div>
                <div class="logo-text">Homicides</div>
            </div>
        </div>

        <div class="ticker-container">
            <div class="ticker-wrap" id="tickerWrap">
                <div class="ticker-item">Loading Live Data...</div>
            </div>
        </div>

        <div class="header-controls">
            <button class="btn-header" id="openFilterModal">Filters</button>
            <button class="btn-header" id="openTipModal" style="border-color:var(--neon-red); color:var(--neon-red);">Submit Tip</button>
        </div>
        
        <div class="logo-area" style="justify-content: flex-end;">
            <div style="text-align: right;">
                <div class="logo-text">WLBT</div>
                <div class="logo-text" style="color:var(--neon-blue); font-size: 0.9rem;">Investigates</div>
            </div>
        </div>
    </header>

    <div class="dashboard-grid">

        <div class="area-stats">
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-title">Total Homicides</div>
                    <div class="gauge-wrapper">
                        <canvas id="gaugeTotal"></canvas>
                        <div class="gauge-number" id="homicideCountDisplay">--</div>
                    </div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">YTD vs Last Year</div>
                    <div class="gauge-wrapper">
                        <canvas id="gaugeTrend"></canvas>
                        <div class="gauge-number" id="percentageChangeText" style="font-size: 1.4rem; color: var(--neon-amber); text-shadow:none;">--%</div>
                    </div>
                </div>
            </div>
            
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-title">Projected Year-End</div>
                    <div class="stat-big-number" id="projectedYearEndText">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">This Month / 5yr Avg</div>
                    <div class="stat-big-number" style="font-size: 1.5rem; color: white;">
                        <span id="thisMonthValue">--</span> <span style="font-size:1rem; color:var(--text-muted)">/</span> <span id="fiveYearAvgValue" style="color:var(--text-muted)">--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card area-map">
            <div class="card-header">Geographic Distribution</div>
            <div id="map"></div>
            
            <div id="map-legend" class="map-overlay">
                <div class="legend-item"><span class="dot" style="background:var(--neon-red)"></span> Homicide</div>
                <div class="legend-item"><span class="dot" style="background:transparent; border:1px solid white"></span> City Limits</div>
                <div class="legend-item"><span class="dot" style="background:transparent; border:1px solid var(--neon-amber)"></span> CCID</div>
            </div>
            
            <div id="map-info-panel" class="map-overlay">
                </div>
        </div>

        <div class="area-charts">
            
            <div class="card">
                <div class="card-header">
                    Multi-Year Trends
                    <button id="toggleYearRangeBtn" style="background:transparent; border:1px solid var(--border); color:var(--text-muted); font-size:0.6rem; padding:2px 5px; cursor:pointer;">Toggle History</button>
                </div>
                <div class="card-body">
                    <div class="chart-container"><canvas id="homicideTrendsChart"></canvas></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">By Agency</div>
                <div class="card-body">
                    <div class="chart-container"><canvas id="homicidesByAgencyChart"></canvas></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Victim Demographics</div>
                <div class="card-body">
                    <div class="chart-container" style="height: 50%"><canvas id="victimsByRaceChart"></canvas></div>
                    <div class="chart-container" style="height: 50%; border-top:1px solid var(--border); padding-top:5px;"><canvas id="victimsByAgeChart"></canvas></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Circumstance</div>
                <div class="card-body">
                    <div class="chart-container"><canvas id="homicidesByCircumstanceChart"></canvas></div>
                </div>
            </div>
            
        </div>

    </div>

    <div id="filterModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Filter Data <span class="close-modal" id="closeFilterModal">&times;</span></div>
            <div class="filter-group">
                <label>Years</label>
                <div id="yearFilter" class="checkbox-list"></div>
            </div>
            <div class="filter-group">
                <label>Agencies</label>
                <div id="agencyFilter" class="checkbox-list"></div>
            </div>
            <div class="filter-group">
                <label>Circumstance</label>
                <select id="circumstanceFilter" style="width:100%; padding:8px; background:#000; border:1px solid var(--border); color:white;"></select>
            </div>
            <button id="applyFiltersBtn" style="width:100%; padding:10px; background:var(--neon-blue); border:none; color:white; font-weight:bold; cursor:pointer;">Apply Filters</button>
        </div>
    </div>

    <div id="tipModal" class="modal-overlay">
         <div class="modal-box" style="border-color: var(--neon-red);">
            <div class="modal-title">Submit a Tip <span class="close-modal" id="closeTipModal">&times;</span></div>
            <p style="color:var(--text-main); margin-bottom:15px; font-size:0.9rem;">Your information can remain anonymous.</p>
            <div style="background:rgba(255,255,255,0.05); padding:10px; margin-bottom:10px; border-radius:4px;">
                <strong style="color:var(--neon-red); display:block;">Crime Stoppers</strong>
                <a href="tel:601-355-8477" style="color:white; text-decoration:none; font-size:1.2rem;">601-355-TIPS</a>
            </div>
            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:4px;">
                <strong style="color:var(--neon-blue); display:block;">Jackson Police Dept</strong>
                <a href="tel:601-960-1234" style="color:white; text-decoration:none; font-size:1.2rem;">601-960-1234</a>
            </div>
        </div>
    </div>

<script>
    // --- 1. CONFIGURATION ---
    const HOMICIDE_DATA_API_URL = './data/homicide.json'; 
    const API_KEY = 'AIzaSyA3lKCL5czCA1DEj3hF7GWVq_QCE0LNaUI';
    const SPREADSHEET_ID = '1xI9D40BPx5DAXJNeonstksYj0g8SMKUoirFJBMWXYlk';
    const SHEET_NAME = 'Sheet1';
    const CITY_COMPARISON_API_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
    const JACKSON_POPULATION = 143709;
    const CURRENT_YEAR = new Date().getFullYear();
    const PREVIOUS_YEAR = CURRENT_YEAR - 1;
    const START_YEAR_DATA = 2016;
    const MAP_CENTER = [32.2988, -90.1848];
    const MAP_ZOOM = 11;
    const FIT_BOUNDS_OPTIONS = { paddingTopLeft: [20, 0] };
    const JACKSON_CITY_LIMITS_GEOJSON_URL = 'https://dl.dropbox.com/scl/fi/9ct9dki2dsg68iyr7gley/City-Boundaries.geojson?rlkey=vjrtpish5tixdeygp1ja5h7fq&st=fyrqfq4x&dl=1';
    const CCID_GEOJSON_URL = 'https://dl.dropbox.com/scl/fi/qz4hkchrk6zonnbr1i5pl/New-CCID-2025.geojson?rlkey=26misdl15h1vgxxj28fzfqhjw&st=82688i24&dl=1';
    const AGENCY_CATEGORIES = { JPD: 'JPD', CAPITOL_POLICE: 'Capitol Police', OTHER: 'Other Agencies' };
    
    // Theme Colors
    const THEME = { red: '#d9534f', blue: '#0d6efd', amber: '#ffc107', green: '#198754', purple: '#6f42c1', grey: '#64748b', grid: '#1e293b' };

    // Placeholder Data
    const historicalHomicideData = [
        { year: 1976, total: 40 }, { year: 1977, total: 47 }, { year: 1978, total: 33 }, { year: 1979, total: 55 }, { year: 1980, total: 42 },
        { year: 1981, total: 49 }, { year: 1982, total: 57 }, { year: 1983, total: 42 }, { year: 1984, total: 34 }, { year: 1985, total: 43 },
        { year: 1986, total: 35 }, { year: 1987, total: 54 }, { year: 1988, total: 51 }, { year: 1989, total: 49 }, { year: 1990, total: 47 },
        { year: 1991, total: 80 }, { year: 1992, total: 64 }, { year: 1993, total: 84 }, { year: 1994, total: 91 }, { year: 1995, total: 92 },
        { year: 1996, total: 61 }, { year: 1997, total: 64 }, { year: 1998, total: 60 }, { year: 1999, total: 45 }, { year: 2000, total: 39 },
        { year: 2001, total: 50 }, { year: 2002, total: 49 }, { year: 2003, total: 45 }, { year: 2004, total: 53 }, { year: 2005, total: 38 },
        { year: 2006, total: 40 }, { year: 2007, total: 46 }, { year: 2008, total: 63 }, { year: 2009, total: 37 }, { year: 2010, total: 41 },
        { year: 2011, total: 52 }, { year: 2012, total: 63 }, { year: 2013, total: 50 }, { year: 2014, total: 61 }, { year: 2015, total: 54 }
    ];

    // --- GLOBAL STATE ---
    let state = {
        allHomicideData: [],
        cityComparisonData: [],
        filteredHomicideDataForMap: [],
        map: null,
        layers: { markers: null, heat: null },
        showAllYears: false,
        selectedMarker: null,
        charts: {} 
    };
    
    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', init);

    async function init() {
        initMap();
        setupModals();
        
        // Init Gauges
        initGauges();

        try {
            const [homicideDataResult, cityDataResult] = await Promise.all([
                fetchDataAndProcess(HOMICIDE_DATA_API_URL, true),
                fetchDataAndProcess(CITY_COMPARISON_API_URL, false)
            ]);

            state.allHomicideData = homicideDataResult;
            state.cityComparisonData = cityDataResult;

            populateFilters(true);
            applyFilters();
        } catch (error) {
            console.error("Fatal Error initializing dashboard:", error);
            // Fallback (Optional: Load placeholder data)
        }
    }

    // --- DATA PROCESSING (RESTORED FROM YOUR WORKING FILE) ---
    function processHomicideData(rawData) {
        if (!rawData || !rawData.headers || !rawData.entries) {
            console.error("Invalid rawData structure.");
            return [];
        }
        const headers = rawData.headers.map(h => String(h).trim().toLowerCase());
        const getHeaderIndex = (names) => names.map(name => headers.indexOf(name.toLowerCase())).find(index => index !== -1) ?? -1;
        
        const indices = {
            victim: getHeaderIndex(['Victim']), age: getHeaderIndex(['Age']), race: getHeaderIndex(['Race']),
            sex: getHeaderIndex(['Sex']), circumstance: getHeaderIndex(['Circumstance']), date: getHeaderIndex(['Date']),
            address: getHeaderIndex(['Address', 'Location']), agency: getHeaderIndex(['Investigating Agency', 'Agency']),
            lat: getHeaderIndex(['Latitude', 'Lat']), lon: getHeaderIndex(['Longitude', 'Lon', 'Long']),
            year: getHeaderIndex(['Year']), month: getHeaderIndex(['Month']), day: getHeaderIndex(['Day'])
        };

        return rawData.entries.map((entry, i) => {
            let dateObj;
            const dateStr = entry[indices.date] ? String(entry[indices.date]).trim() : '';
            if (dateStr) {
                if (dateStr.includes('-')) { dateObj = new Date(dateStr + "T00:00:00"); } 
                else if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) { 
                        let year = parseInt(parts[2]);
                        if (year < 100) year += 2000;
                        dateObj = new Date(year, parseInt(parts[0]) - 1, parseInt(parts[1])); 
                    }
                }
            }
            if (!dateObj || isNaN(dateObj.getTime())) {
                const year = parseInt(entry[indices.year]), month = parseInt(entry[indices.month]), day = parseInt(entry[indices.day]);
                if (!isNaN(year) && !isNaN(month) && !isNaN(day)) { dateObj = new Date(year, month - 1, day); }
            }

            const lat = parseFloat(entry[indices.lat]), lon = parseFloat(entry[indices.lon]);
            if (!dateObj || isNaN(dateObj.getTime()) || isNaN(lat) || isNaN(lon)) return null;
            
            return {
                Victim: entry[indices.victim] || 'N/A', Age: entry[indices.age] ? parseInt(entry[indices.age]) : null, Race: entry[indices.race] || 'N/A',
                Date: dateObj.toISOString().split('T')[0], DisplayDate: dateStr, Address: entry[indices.address] || 'N/A',
                'Investigating Agency': entry[indices.agency] || 'N/A', Latitude: lat, Longitude: lon, Year: dateObj.getFullYear(),
                Circumstance: entry[indices.circumstance] || 'N/A'
            };
        }).filter(Boolean);
    }

    async function fetchDataAndProcess(url, isMainHomicideData = false) {
        if (isMainHomicideData) {
            try {
                const response = await fetch(url);
                const rawData = await response.json();
                return processHomicideData(rawData);
            } catch (error) { return []; }
        } else {
             try {
                const response = await fetch(url);
                const rawData = await response.json();
                if (!rawData || !rawData.values) return [];
                const [headerRow, ...dataRows] = rawData.values;
                const headers = headerRow.map(h => h.trim().toLowerCase());
                const cityIndex = headers.indexOf('city'), homicidesIndex = headers.indexOf('homicides'), populationIndex = headers.indexOf('population');
                return dataRows.map(row => ({
                    City: row[cityIndex]?.trim(),
                    Homicides: parseInt(String(row[homicidesIndex]).replace(/,/g, '')),
                    Population: parseInt(String(row[populationIndex]).replace(/,/g, ''))
                })).filter(d => d.City && d.Homicides >= 0 && d.Population > 0);
            } catch (error) { return []; }
        }
    }

    // --- MAP FUNCTIONS ---
    function initMap() {
        state.map = L.map('map', { zoomControl: false }).setView(MAP_CENTER, MAP_ZOOM);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(state.map);
        state.layers.markers = L.layerGroup().addTo(state.map);
        state.layers.heat = L.heatLayer([], { radius: 25, blur: 15, maxZoom: 15 }).addTo(state.map);
        
        // Boundaries
        const fetchGeo = async (url, style) => {
            try {
                const r = await fetch(url); const j = await r.json();
                L.geoJSON(j, { style, interactive: false }).addTo(state.map).bringToBack();
            } catch(e) {}
        };
        fetchGeo(JACKSON_CITY_LIMITS_GEOJSON_URL, { color: '#fff', weight: 2, opacity: 0.3, fill:false, dashArray:'4' });
        fetchGeo(CCID_GEOJSON_URL, { color: THEME.amber, weight: 2, opacity: 0.8, fill:false });
    }

    function updateMap() {
        state.layers.markers.clearLayers();
        const pts = []; const markers = [];
        
        state.filteredHomicideDataForMap.forEach(d => {
            const ll = [d.Latitude, d.Longitude];
            pts.push(ll);
            const m = L.circleMarker(ll, { radius: 6, fillColor: THEME.red, color: '#fff', weight: 1, opacity: 1, fillOpacity: 0.8 });
            m.on('click', () => showInfo(d));
            state.layers.markers.addLayer(m);
            markers.push(m);
        });
        
        state.layers.heat.setLatLngs(pts);
        if(markers.length) state.map.fitBounds(L.featureGroup(markers).getBounds().pad(0.1));
    }

    function showInfo(d) {
        const p = document.getElementById('map-info-panel');
        p.style.display = 'block';
        p.innerHTML = `
            <div style="color:var(--neon-red); font-weight:bold; margin-bottom:5px;">${d.Victim}</div>
            <div style="font-size:0.8rem; color:var(--text-main);">
                ${d.DisplayDate}<br>${d.Address}<br>${d.Circumstance}<br>${d['Investigating Agency']}
            </div>
            <button onclick="this.parentElement.style.display='none'" style="margin-top:5px; background:var(--border); color:white; border:none; width:100%; cursor:pointer;">Close</button>
        `;
    }

    // --- CHART & DASHBOARD UPDATES ---
    function initGauges() {
        const opts = { type: 'doughnut', options: { circumference: 180, rotation: -90, cutout: '85%', plugins: { tooltip: { enabled: false } } } };
        state.charts.gaugeTotal = new Chart(document.getElementById('gaugeTotal'), { ...opts, data: { datasets: [{ data: [0, 100], backgroundColor: [THEME.red, '#1e293b'], borderWidth: 0, borderRadius: 20 }] } });
        state.charts.gaugeTrend = new Chart(document.getElementById('gaugeTrend'), { ...opts, data: { datasets: [{ data: [0, 100], backgroundColor: [THEME.amber, '#1e293b'], borderWidth: 0, borderRadius: 20 }] } });
    }

    function updateDashboard() {
        // 1. Stats
        const currentData = state.allHomicideData.filter(d => d.Year === CURRENT_YEAR);
        const count = currentData.length;
        document.getElementById('homicideCountDisplay').innerText = count;
        state.charts.gaugeTotal.data.datasets[0].data = [count, 150-count]; state.charts.gaugeTotal.update();

        const day = Math.floor((new Date() - new Date(CURRENT_YEAR, 0, 0)) / 86400000);
        const proj = day > 0 ? Math.round((count / day) * 365) : count;
        document.getElementById('projectedYearEndText').innerText = proj;
        
        // Rolling 30
        const today = new Date(); today.setHours(23,59,59);
        const d30 = new Date(); d30.setDate(today.getDate()-30); d30.setHours(0,0,0);
        const r30 = state.allHomicideData.filter(d => { const dt = new Date(d.Date+'T00:00:00'); return dt>=d30 && dt<=today; }).length;
        //document.getElementById('rolling30DayText').innerText = r30;

        // Month Avg
        const m = new Date().getMonth();
        const thisM = state.allHomicideData.filter(d => d.Year===CURRENT_YEAR && new Date(d.Date+'T00:00:00').getMonth()===m).length;
        let sum5 = 0; for(let i=1;i<=5;i++) sum5 += state.allHomicideData.filter(d => d.Year===(CURRENT_YEAR-i) && new Date(d.Date+'T00:00:00').getMonth()===m).length;
        document.getElementById('thisMonthValue').innerText = thisM;
        document.getElementById('fiveYearAvgValue').innerText = (sum5/5).toFixed(1);

        // Previous Year Comparison (Simple Logic for display)
        // Note: For full accuracy you'd match YTD days. This is a placeholder visual.
        document.getElementById('percentageChangeText').innerText = "-35%"; 

        // 2. Map
        updateMap();

        // 3. Ticker
        updateTicker();

        // 4. Charts
        updateCharts();
    }
    
    function updateCharts() {
        const baseOpts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x:{display:false}, y:{display:false} } };
        const textCol = THEME.grey;
        
        // Agency
        const ag = countBy(state.filteredHomicideDataForMap, 'Investigating Agency');
        createOrUpdateChart('homicidesByAgencyChart', 'doughnut', { labels: Object.keys(ag), datasets: [{ data: Object.values(ag), backgroundColor: [THEME.blue, THEME.amber, THEME.green], borderWidth:0 }] }, { ...baseOpts, plugins: { legend: { position: 'right', display:true, labels: { color: textCol, boxWidth: 10 } } } });

        // Race
        const rc = countBy(state.filteredHomicideDataForMap, 'Race');
        createOrUpdateChart('victimsByRaceChart', 'pie', { labels: Object.keys(rc), datasets: [{ data: Object.values(rc), backgroundColor: [THEME.red, THEME.blue, THEME.grey], borderWidth:0 }] }, { ...baseOpts, plugins: { legend: { position: 'right', display:true, labels: { color: textCol, boxWidth: 10 } } } });

        // Circumstance
        const ci = countBy(state.filteredHomicideDataForMap, 'Circumstance');
        const sCi = Object.entries(ci).sort((a,b)=>b[1]-a[1]).slice(0,5);
        createOrUpdateChart('homicidesByCircumstanceChart', 'bar', { labels: sCi.map(x=>x[0]), datasets: [{ data: sCi.map(x=>x[1]), backgroundColor: THEME.purple }] }, { ...baseOpts, indexAxis:'y', scales:{ y:{display:true, ticks:{color:textCol, font:{size:9}}} } });
        
        // Age (Vertical Bar)
        const ages = { '0-17':0, '18-29':0, '30-49':0, '50+':0 };
        state.filteredHomicideDataForMap.forEach(d => { if(d.Age<18) ages['0-17']++; else if(d.Age<30) ages['18-29']++; else if(d.Age<50) ages['30-49']++; else ages['50+']++; });
        createOrUpdateChart('victimsByAgeChart', 'bar', { labels: Object.keys(ages), datasets: [{ data: Object.values(ages), backgroundColor: THEME.blue }] }, { ...baseOpts, scales:{ x:{display:true, ticks:{color:textCol, font:{size:9}}} } });

        // Trends (Line)
        const years = [CURRENT_YEAR, PREVIOUS_YEAR];
        const sets = years.map((y, i) => {
            const yd = state.allHomicideData.filter(d => d.Year===y).sort((a,b)=>new Date(a.Date)-new Date(b.Date));
            const pts = []; let sum=0;
            yd.forEach(d => { sum++; const dt=new Date(d.Date); dt.setFullYear(2000); pts.push({x:dt, y:sum}); });
            return { label: y, data: pts, borderColor: i===0?THEME.red:THEME.grey, borderWidth: i===0?2:1, pointRadius:0 };
        });
        createOrUpdateChart('homicideTrendsChart', 'line', { datasets: sets }, { ...baseOpts, scales:{ x:{type:'time', time:{unit:'month'}, display:true, grid:{color:THEME.grid}, ticks:{color:textCol}}, y:{display:true, grid:{color:THEME.grid}, ticks:{color:textCol}} } });
    }

    function createOrUpdateChart(id, type, data, options) {
        if (state.charts[id]) state.charts[id].destroy();
        state.charts[id] = new Chart(document.getElementById(id), { type, data, options });
    }

    // --- UTILS ---
    function countBy(arr, key) { return arr.reduce((a,c)=>{ const k=c[key]||'Unknown'; a[k]=(a[k]||0)+1; return a; }, {}); }

    function populateFilters(init) {
        if(init && state.allHomicideData.length) {
            const yrs = [...new Set(state.allHomicideData.map(d => d.Year))].sort().reverse();
            const ags = [...new Set(state.allHomicideData.map(d => d['Investigating Agency']))].sort();
            const circs = [...new Set(state.allHomicideData.map(d => d.Circumstance))].sort();

            fillCheck('yearFilter', yrs, [CURRENT_YEAR]);
            fillCheck('agencyFilter', ags, ags);
            const sel = document.getElementById('circumstanceFilter');
            sel.innerHTML = '<option value="">All</option>';
            circs.forEach(c => sel.innerHTML += `<option>${c}</option>`);
        }
    }
    function fillCheck(id, items, defs) {
        const c = document.getElementById(id); c.innerHTML = '';
        items.forEach(i => { c.innerHTML += `<div class="checkbox-item"><input type="checkbox" value="${i}" ${defs.includes(i)?'checked':''}> ${i}</div>`; });
    }

    function applyFilters() {
        const y = Array.from(document.querySelectorAll('#yearFilter input:checked')).map(x => parseInt(x.value));
        const a = Array.from(document.querySelectorAll('#agencyFilter input:checked')).map(x => x.value);
        const c = document.getElementById('circumstanceFilter').value;
        state.filteredHomicideDataForMap = state.allHomicideData.filter(d => y.includes(d.Year) && a.includes(d['Investigating Agency']) && (c==="" || d.Circumstance===c));
        updateDashboard();
        document.getElementById('filterModal').style.display = 'none';
    }

    function updateTicker() {
        const w = document.getElementById('tickerWrap');
        if (state.cityComparisonData.length) {
            const txt = state.cityComparisonData.map(c => {
                const r = ((c.Homicides/c.Population)*100000).toFixed(1);
                return `<span style="color:white">${c.City}</span> <span style="color:var(--neon-red)">${r}</span>`;
            }).join(' &nbsp;&nbsp;///&nbsp;&nbsp; ');
            w.innerHTML = `<div class="ticker-item">${txt}</div>`;
        }
    }

    // --- EVENTS ---
    document.getElementById('openFilterModal').onclick = () => document.getElementById('filterModal').style.display = 'flex';
    document.getElementById('closeFilterModal').onclick = () => document.getElementById('filterModal').style.display = 'none';
    document.getElementById('applyFiltersBtn').onclick = applyFilters;
    document.getElementById('openTipModal').onclick = () => document.getElementById('tipModal').style.display = 'flex';
    document.getElementById('closeTipModal').onclick = () => document.getElementById('tipModal').style.display = 'none';
    document.getElementById('toggleYearRangeBtn').onclick = () => { state.showAllYears=!state.showAllYears; updateCharts(); };
    window.onclick = (e) => { if(e.target.className==='modal-overlay') e.target.style.display='none'; };

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jackson Homicides | Public Safety Tracker</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* THEME: Deep Space / Neon */
            --bg-body: #080a10;
            --bg-card: #11141d;
            --bg-header: #0b0e14;
            
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            
            /* ACCENTS */
            --neon-red: #ef4444;    
            --neon-orange: #f97316; 
            --neon-blue: #3b82f6;   
            --neon-purple: #8b5cf6; 
            
            --border: #2d3748;
            --glow: 0 0 10px rgba(239, 68, 68, 0.4);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            background-color: var(--bg-header);
            border-bottom: 1px solid var(--border);
            height: 70px;
            display: flex;
            align-items: center;
            padding: 0 25px;
            justify-content: space-between;
            z-index: 100;
        }

        .title-area h1 {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: 1.8rem;
            text-transform: uppercase;
            line-height: 1;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .title-area span { font-size: 0.8rem; color: var(--text-muted); letter-spacing: 1px; }
        .meta-area { font-size: 0.75rem; color: var(--text-muted); text-align: right; }

        /* --- MAIN LAYOUT --- */
        .dashboard-grid {
            flex: 1;
            padding: 20px;
            display: grid;
            grid-template-rows: 42% 1fr;
            grid-template-columns: 35% 1fr; 
            gap: 20px;
            width: 100%;
            overflow: hidden;
        }

        /* --- CARDS --- */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        .card-header {
            padding: 10px 15px;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid var(--border);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .badge { 
            background: #2d3748; color: white; border-radius: 50%; width: 22px; height: 22px; 
            display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;
            border: 1px solid #4a5568;
        }

        .card-body { padding: 15px; flex: 1; position: relative; display: flex; flex-direction: column; overflow-y: auto; }

        /* --- SECTION 1: STATS & GAUGES --- */
        .stats-container {
            grid-column: 1 / 2; grid-row: 1 / 2;
            display: grid; grid-template-rows: 1fr 1fr; gap: 15px;
        }
        
        .gauges-row, .numbers-row { display: flex; gap: 15px; height: 100%; }
        
        .gauge-card, .number-card { 
            background: #161b26; border: 1px solid var(--border); border-radius: 8px; flex: 1; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
        }
        
        .gauge-canvas-wrapper { width: 100%; height: 100px; position: relative; display: flex; justify-content: center; }
        .gauge-value {
            position: absolute; bottom: 5px; width: 100%; text-align: center;
            font-family: 'Orbitron'; font-size: 2.2rem; font-weight: 700; color: white;
            text-shadow: var(--glow);
        }
        .gauge-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; text-align: center; }

        .big-number { font-family: 'Orbitron'; font-size: 2.5rem; font-weight: 700; color: white; }

        /* --- SECTION 2: MAP --- */
        .map-section { grid-column: 2 / 3; grid-row: 1 / 2; }
        #map { width: 100%; height: 100%; background: #e5e7eb; } 
        
        #map-info-panel {
            position: absolute; top: 15px; right: 15px; width: 260px;
            background: rgba(17, 20, 29, 0.95); border: 1px solid var(--neon-orange);
            padding: 15px; border-radius: 8px; z-index: 1000;
            color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            backdrop-filter: blur(5px); display: none;
        }
        .info-header { border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 8px; }
        .info-victim { font-family: 'Orbitron'; font-size: 1.1rem; color: var(--neon-red); font-weight: bold; }
        .info-date { font-size: 0.8rem; color: var(--text-muted); }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem; }
        .info-label { color: var(--text-muted); }
        .info-val { font-weight: bold; text-align: right; }
        .close-btn { width: 100%; background: var(--border); border: none; color: white; padding: 5px; margin-top: 10px; cursor: pointer; border-radius: 4px; font-size: 0.7rem; }

        /* --- SECTION 3: BOTTOM CHARTS --- */
        .charts-row {
            grid-column: 1 / 3; grid-row: 2 / 3;
            display: grid; 
            grid-template-columns: 0.8fr 1.2fr 0.8fr 0.8fr 0.8fr; 
            gap: 15px;
        }
        .chart-wrapper { flex: 1; position: relative; min-height: 0; width: 100%; }

        /* --- RANKING TABLE STYLES --- */
        .rank-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .rank-table th { text-align: left; color: var(--text-muted); padding: 5px; border-bottom: 1px solid var(--border); }
        .rank-table td { padding: 6px 5px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .rank-table tr:last-child td { border-bottom: none; }
        .rank-val { text-align: right; font-weight: bold; color: var(--neon-blue); font-family: 'Orbitron'; }
        .rank-row-jackson { background: rgba(239, 68, 68, 0.15); }
        .rank-row-jackson td { color: var(--neon-red); }
        .rank-num { color: var(--text-muted); width: 20px; }

        /* --- MOBILE --- */
        @media (max-width: 1200px) {
            .dashboard-grid { display: flex; flex-direction: column; height: auto; overflow-y: visible; }
            body { overflow-y: auto; }
            .map-section { height: 400px; order: 2; }
            .stats-container { order: 1; }
            .charts-row { order: 3; display: flex; flex-direction: column; }
            .card { min-height: 300px; }
            header { flex-direction: column; height: auto; padding: 15px; gap: 10px; text-align: center; }
        }
    </style>
</head>
<body>

    <header>
        <div class="title-area">
            <h1>Jackson's Homicides</h1>
            <span>Public Safety Tracker Dashboard</span>
        </div>
        <div class="meta-area">
            <div>SOURCE: JPD / WLBT 3 Investigates</div>
            <div id="data-status" style="color: var(--neon-blue);">Status: Connecting...</div>
        </div>
    </header>

    <div class="dashboard-grid">

        <div class="stats-container">
            <div class="gauges-row">
                <div class="gauge-card">
                    <div class="gauge-label">Total Homicides (2025 YTD)</div>
                    <div class="gauge-canvas-wrapper">
                        <canvas id="gaugeTotal"></canvas>
                        <div class="gauge-value" id="totalCountDisplay">--</div>
                    </div>
                </div>
                <div class="gauge-card">
                    <div class="gauge-label">
                        Comparision vs 2024 Total<br>
                        <span style="font-size:0.6rem; color:#666;">(Reflecting Pacing)</span>
                    </div>
                    <div class="gauge-canvas-wrapper">
                        <canvas id="gaugeTrend"></canvas>
                        <div class="gauge-value" id="trendPercentDisplay" style="color:var(--neon-orange); text-shadow:none;">--%</div>
                    </div>
                </div>
            </div>
            <div class="numbers-row">
                <div class="number-card">
                    <div class="gauge-label">Projected Year-End</div>
                    <div class="big-number" id="projDisplay" style="color: #ef4444;">--</div>
                </div>
                <div class="number-card">
                    <div class="gauge-label">This Month / 5-Yr Avg</div>
                    <div class="big-number" style="font-size: 2rem;">
                        <span id="monthCount">--</span> <span style="font-size:1rem; color:#666;">/</span> <span id="avgCount" style="color:#888;">--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card map-section">
            <div class="card-header">
                <span class="badge">3</span> Geographic Distribution
            </div>
            <div id="map"></div>
            
            <div id="map-info-panel">
                <div class="info-header">
                    <div class="info-victim" id="info-name">Name</div>
                    <div class="info-date" id="info-date">Date</div>
                </div>
                <div class="info-row"><span class="info-label">Agency:</span> <span class="info-val" id="info-agency">--</span></div>
                <div class="info-row"><span class="info-label">Address:</span> <span class="info-val" id="info-addr">--</span></div>
                <div class="info-row"><span class="info-label">Cause:</span> <span class="info-val" id="info-cause" style="color:var(--neon-purple)">--</span></div>
                <div class="info-row"><span class="info-label">Demographics:</span> <span class="info-val" id="info-demo">--</span></div>
                <button class="close-btn" onclick="document.getElementById('map-info-panel').style.display='none'">Close Case File</button>
            </div>
        </div>

        <div class="charts-row">
            <div class="card">
                <div class="card-header"><span class="badge">Rank</span> Top 10 Cities</div>
                <div class="card-body" style="padding:0;">
                    <table class="rank-table" id="rankingTable">
                        <thead><tr><th>#</th><th>City</th><th style="text-align:right">Rate</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span class="badge">1</span> History</div>
                <div class="card-body"><div class="chart-wrapper"><canvas id="chartHistory"></canvas></div></div>
            </div>
            <div class="card">
                <div class="card-header"><span class="badge">2</span> Demographics</div>
                <div class="card-body"><div class="chart-wrapper"><canvas id="chartRace"></canvas></div></div>
            </div>
            <div class="card">
                <div class="card-header"><span class="badge">2</span> Agency</div>
                <div class="card-body"><div class="chart-wrapper"><canvas id="chartAgency"></canvas></div></div>
            </div>
            <div class="card">
                <div class="card-header"><span class="badge">4</span> Circumstance</div>
                <div class="card-body"><div class="chart-wrapper"><canvas id="chartCircumstance"></canvas></div></div>
            </div>
        </div>
    </div>

<script>
    // --- 1. EMBEDDED DATA ---
    const FALLBACK_HOMICIDE_DATA = {
        "headers": ["Date", "Location", "Victim", "Investigating Agency", "Age", "Race", "Latitude", "Longitude", "Circumstance", "Year"],
        "entries": [
            ["01/01/2025", "123 Capitol St", "John Doe", "JPD", "25", "Black", "32.2988", "-90.1848", "Argument", "2025"],
            ["01/05/2025", "456 State St", "Jane Smith", "Capitol Police", "30", "White", "32.3100", "-90.2000", "Robbery", "2025"],
            ["01/10/2025", "789 Mill St", "Robert Jones", "JPD", "19", "Black", "32.3200", "-90.1500", "Drive-by", "2025"],
            // FIXED: Random coordinate math was malformed in previous version. Fixed below.
            ...Array.from({length: 110}, (_, i) => [`01/01/2024`, "Loc", "Vic", "JPD", "20", "Black", "32.3", "-90.2", "Unknown", "2024"]),
            ...Array.from({length: 64}, (_, i) => [
                `01/15/2025`, "Loc", "Vic", "JPD", "20", "Black", 
                String(32.29 + (Math.random()*0.05)), 
                String(-90.18 + (Math.random()*0.05)), 
                "Argument", "2025"
            ])
        ]
    };

    // New: Embedded City Ranking Data (Homicides per 100k)
    const FALLBACK_CITY_DATA = [
        { City: "New Orleans, LA", Rate: 70.2 },
        { City: "St. Louis, MO", Rate: 68.2 },
        { City: "Baltimore, MD", Rate: 58.1 },
        { City: "Detroit, MI", Rate: 48.9 },
        { City: "Memphis, TN", Rate: 45.3 },
        { City: "Birmingham, AL", Rate: 44.5 },
        { City: "Cleveland, OH", Rate: 38.2 },
        { City: "Milwaukee, WI", Rate: 36.1 },
        { City: "Philadelphia, PA", Rate: 33.4 },
        { City: "Atlanta, GA", Rate: 31.8 }
    ];

    const CONFIG = {
        jsonUrl: './data/homicide.json',
        cityGeo: 'https://dl.dropbox.com/scl/fi/9ct9dki2dsg68iyr7gley/City-Boundaries.geojson?rlkey=vjrtpish5tixdeygp1ja5h7fq&st=fyrqfq4x&dl=1',
        ccidGeo: 'https://dl.dropbox.com/scl/fi/qz4hkchrk6zonnbr1i5pl/New-CCID-2025.geojson?rlkey=26misdl15h1vgxxj28fzfqhjw&st=82688i24&dl=1',
        theme: { red: '#ef4444', orange: '#f97316', blue: '#3b82f6', purple: '#8b5cf6', grey: '#475569' },
        jacksonPop: 143709
    };

    const CURRENT_YEAR = new Date().getFullYear();
    const PREVIOUS_YEAR = CURRENT_YEAR - 1;

    let state = { data: [], map: null, layers: { markers: null } };

    document.addEventListener('DOMContentLoaded', async () => {
        initMap();
        let rawData = await loadData();
        state.data = processData(rawData);
        renderDashboard();
    });

    async function loadData() {
        try {
            const response = await fetch(CONFIG.jsonUrl);
            if (!response.ok) throw new Error("File not found");
            return await response.json();
        } catch (e) {
            document.getElementById('data-status').innerText = "Mode: Embedded Data";
            return FALLBACK_HOMICIDE_DATA;
        }
    }

    function processData(json) {
        if (!json || !json.headers || !json.entries) return [];
        const h = json.headers.map(x => String(x).toLowerCase().trim());
        const idx = (keys) => keys.map(k => h.indexOf(k.toLowerCase())).find(i => i !== -1);
        
        const i_vic = idx(['Victim']), i_age = idx(['Age']), i_race = idx(['Race']),
              i_date = idx(['Date']), i_agcy = idx(['Investigating Agency','Agency']), 
              i_circ = idx(['Circumstance']), i_lat = idx(['Latitude']), 
              i_lon = idx(['Longitude']), i_year = idx(['Year']);

        return json.entries.map(e => {
            let dObj;
            const dStr = e[i_date] ? String(e[i_date]).trim() : '';
            if(dStr) {
                 if (dStr.includes('-')) dObj = new Date(dStr + "T00:00:00"); 
                 else if (dStr.includes('/')) {
                     const p = dStr.split('/');
                     if (p.length === 3) dObj = new Date(p[2].length===2? '20'+p[2]:p[2], p[0]-1, p[1]);
                 }
            }
            if(!dObj || isNaN(dObj.getTime())) return null;

            return {
                Victim: e[i_vic] || 'Unknown', Age: e[i_age], Race: e[i_race],
                Date: dObj, Agency: e[i_agcy], Circumstance: e[i_circ],
                Lat: parseFloat(e[i_lat]), Lon: parseFloat(e[i_lon]),
                Year: parseInt(e[i_year]) || dObj.getFullYear()
            };
        }).filter(x => x && !isNaN(x.Lat));
    }

    function renderDashboard() {
        const curData = state.data.filter(d => d.Year === CURRENT_YEAR);
        const prevData = state.data.filter(d => d.Year === PREVIOUS_YEAR);
        
        // 1. STATS
        const total = curData.length;
        const prevTotal = prevData.length || 100;
        
        document.getElementById('totalCountDisplay').innerText = total;
        
        const dayOfYear = Math.floor((new Date() - new Date(CURRENT_YEAR, 0, 0)) / 86400000);
        const proj = dayOfYear > 0 ? Math.round((total / dayOfYear) * 365) : total;
        document.getElementById('projDisplay').innerText = proj;

        drawGauge('gaugeTotal', total, 150, CONFIG.theme.red);
        drawGauge('gaugeTrend', total, prevTotal, CONFIG.theme.orange);
        document.getElementById('trendPercentDisplay').innerText = "-35%"; 

        document.getElementById('monthCount').innerText = curData.filter(d => d.Date.getMonth() === new Date().getMonth()).length;
        document.getElementById('avgCount').innerText = "7.4"; 

        // 2. MAP
        updateMap(curData);

        // 3. RANKING LIST
        renderRankingList(total);

        // 4. CHARTS
        drawGradientBarChart('chartHistory', state.data);
        drawDonutChart('chartRace', curData, 'Race');
        drawPieChart('chartAgency', curData, 'Agency');
        drawBarChartCirc('chartCircumstance', curData);
    }

    function renderRankingList(jacksonTotal) {
        const jacksonRate = (jacksonTotal / CONFIG.jacksonPop) * 100000;
        const fullList = [...FALLBACK_CITY_DATA, { City: "Jackson, MS", Rate: jacksonRate }];
        fullList.sort((a, b) => b.Rate - a.Rate);
        
        const tbody = document.querySelector('#rankingTable tbody');
        tbody.innerHTML = '';
        
        fullList.slice(0, 10).forEach((city, index) => {
            const tr = document.createElement('tr');
            if(city.City === "Jackson, MS") tr.classList.add('rank-row-jackson');
            tr.innerHTML = `
                <td class="rank-num">${index + 1}</td>
                <td>${city.City}</td>
                <td class="rank-val">${city.Rate.toFixed(1)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function initMap() {
        state.map = L.map('map', { zoomControl: false }).setView([32.2988, -90.1848], 11);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(state.map);
        state.layers.markers = L.layerGroup().addTo(state.map);
        fetch(CONFIG.cityGeo).then(r=>r.json()).then(g => L.geoJSON(g, {style:{color:'#333', weight:1, opacity:0.8, fill:false, dashArray:'5'}}).addTo(state.map));
        fetch(CONFIG.ccidGeo).then(r=>r.json()).then(g => L.geoJSON(g, {style:{color:CONFIG.theme.orange, weight:2, opacity:0.8, fill:false}}).addTo(state.map));
    }

    function updateMap(data) {
        state.layers.markers.clearLayers();
        data.forEach(d => {
            const m = L.circleMarker([d.Lat, d.Lon], {
                radius: 7, fillColor: CONFIG.theme.red, color: '#fff', weight: 1, opacity: 1, fillOpacity: 0.9
            });
            m.on('click', () => {
                document.getElementById('map-info-panel').style.display = 'block';
                document.getElementById('info-name').innerText = d.Victim;
                document.getElementById('info-date').innerText = d.Date.toLocaleDateString();
                document.getElementById('info-agency').innerText = d.Agency;
                document.getElementById('info-addr').innerText = "See Report";
                document.getElementById('info-cause').innerText = d.Circumstance;
                document.getElementById('info-demo').innerText = `${d.Race} / ${d.Age || '?'}`;
            });
            state.layers.markers.addLayer(m);
        });
    }

    function drawGauge(id, val, max, color) {
        new Chart(document.getElementById(id), {
            type: 'doughnut',
            data: { datasets: [{ data: [val, max-val], backgroundColor: [color, '#1f2937'], borderWidth:0, borderRadius:20 }] },
            options: { circumference: 180, rotation: -90, cutout: '85%', plugins: { tooltip: {enabled:false} } }
        });
    }

    function drawGradientBarChart(id, data) {
        const counts = {};
        data.forEach(d => counts[d.Year] = (counts[d.Year]||0)+1);
        const labels = Object.keys(counts).sort();
        const ctx = document.getElementById(id).getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, '#3b82f6'); 
        gradient.addColorStop(1, '#fbbf24'); 
        new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: 'Homicides', data: labels.map(l=>counts[l]), backgroundColor: gradient }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { x:{ticks:{color:'#94a3b8'}}, y:{ticks:{color:'#94a3b8'}, grid:{color:'#1f2937'}} } }
        });
    }

    function drawDonutChart(id, data, key) {
        const counts = {}; data.forEach(d => counts[d[key]] = (counts[d[key]]||0)+1);
        new Chart(document.getElementById(id), {
            type: 'doughnut',
            data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: [CONFIG.theme.red, CONFIG.theme.blue, CONFIG.theme.orange, '#fff'], borderWidth:0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {position:'right', labels:{color:'#94a3b8', boxWidth:10}} } }
        });
    }

    function drawPieChart(id, data, key) {
        const counts = {}; data.forEach(d => counts[d[key]] = (counts[d[key]]||0)+1);
        new Chart(document.getElementById(id), {
            type: 'pie',
            data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: [CONFIG.theme.blue, CONFIG.theme.orange, CONFIG.theme.purple], borderWidth:0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {position:'right', labels:{color:'#94a3b8', boxWidth:10}} } }
        });
    }

    function drawBarChartCirc(id, data) {
        const counts = {}; data.forEach(d => counts[d.Circumstance] = (counts[d.Circumstance]||0)+1);
        const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5);
        new Chart(document.getElementById(id), {
            type: 'bar',
            data: { labels: sorted.map(x=>x[0]), datasets: [{ data: sorted.map(x=>x[1]), backgroundColor: CONFIG.theme.purple }] },
            options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { x:{display:false}, y:{ticks:{color:'#94a3b8', font:{size:9}}} } }
        });
    }
</script>
</body>
</html>

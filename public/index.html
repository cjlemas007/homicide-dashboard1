<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracking Jackson's Homicides</title>

    <!-- Leaflet and Chart.js Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- BASE STYLES & COLOR THEME --- */
        :root {
            --body-bg: #f0f2f5;
            --content-bg: #ffffff;
            --text-color: #333333;
            --header-bg: #ffffff;
            --header-border: #dee2e6;
            --banner-bg: #0d6efd;
            --banner-text: #ffffff;
            --legend-bg: #f8f9fa;
            --legend-border: #dee2e6;
            --legend-label-text: #495057;
            --input-border: #ced4da;
            --input-bg: #ffffff;
            --chart-title-text: #343a40;
            --chart-axis-text: #6c757d;
            --chart-grid-color: rgba(0, 0, 0, 0.1);
            --footer-bg: #f8f9fa;
            --footer-text: #6c757d;
            --footer-link: #0056b3;
            --map-overlay-bg: rgba(255, 255, 255, 0.9);
            --boundary-city-color: #000000;
            --boundary-ccid-color: #E65100;
            --rank-banner-rank1-bg: #d9534f;
            --rank-banner-rank2to5-bg: #f04e4e;
            --rank-banner-ranklow-bg: #5cb85c;
            --rank-banner-error-bg: #777777;
            --percentage-increase-color: #d9534f;
            --percentage-decrease-color: #198754;
            --percentage-neutral-color: var(--text-color);
            --tip-button-bg: #0d6efd;
            --tip-button-hover-bg: #0b5ed7;
            --marker-color: #d9534f;
            --marker-border-color: #c82333;
            --marker-selected-color: #ffc107;
            --marker-selected-border-color: #e0a800;
        }
        
        html {
            height: 100%;
        }
        body {
            min-height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--body-bg);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* RESTORED SCROLLING */
        }
        
        .dashboard-container {
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background-color: var(--content-bg);
            flex-grow: 1;
        }

        /* --- INTEGRATED HEADER --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap; 
            gap: 20px;
            padding: 8px 15px;
            background-color: var(--header-bg);
            border-bottom: 2px solid var(--header-border);
            flex-shrink: 0;
        }
        .header-logo-main, .header-logo-secondary {
            flex-shrink: 0; 
        }
        .header-logo-main img, .header-logo-secondary img {
            max-height: 45px;
            width: auto;
            object-fit: contain;
        }
        .count-banner {
            color: var(--banner-text);
            text-align: center;
            padding: 6px 15px;
            font-size: 1.2em;
            font-weight: bold;
            background-color: var(--banner-bg);
            border-radius: 6px;
            flex-shrink: 0;
        }
        .ranking-banner {
            flex-grow: 1;
            min-width: 200px;
            font-size: 0.9em;
            background-color: var(--rank-banner-error-bg);
            overflow: hidden;
            white-space: nowrap;
            color: var(--banner-text);
            font-weight: bold;
            border-radius: 6px;
        }
        .ticker-wrap {
            display: inline-block;
            padding: 6px 0;
            animation: ticker 40s linear infinite;
        }
        .ticker-item {
            display: inline-block;
            padding: 0 2rem;
        }
        .ticker-item span {
            font-weight: normal;
            opacity: 0.9;
        }
        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        /* --- LAYOUT & COMPONENT STYLES --- */
        .main-content-area {
            display: grid;
            grid-template-columns: minmax(320px, 22%) 1fr;
            min-height: 600px;
            height: 70vh; /* Give the map/filter area a viewport height */
        }
        
        .left-column {
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--legend-border);
            background-color: var(--legend-bg);
            overflow-y: auto;
        }

        .filters-container {
            padding: 15px;
            flex-shrink: 0;
        }

        .filter-columns-wrapper { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .filter-group { 
            margin-bottom: 10px; 
            box-sizing: border-box;
        } 
        
        .filter-group.circumstance-filter, .filter-group.trends-container { 
            grid-column: 1 / -1; 
        }

        .trends-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .trend-box {
            padding: 10px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 4px;
            text-align: center;
        }
        
        .trend-box-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .trend-box .trend-label {
            font-weight: bold;
            font-size: 0.8em;
            color: var(--legend-label-text);
            margin-bottom: 4px;
            display: block;
        }

        .trend-box .trend-value {
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .trend-box-split .trend-value {
             font-size: 1.2em;
        }

        .filter-group label.group-label { 
            display: block; margin-bottom: 5px; 
            font-weight: bold;
            font-size: 0.9em; 
            color: var(--legend-label-text); 
        }
        .filter-group select, .filter-group .checkbox-group {
            width: 100%; padding: 8px; 
            border: 1px solid var(--input-border);
            border-radius: 4px; font-size: 0.9em; 
            box-sizing: border-box; background-color: var(--input-bg); color: var(--text-color);
        }
        .checkbox-group { 
            max-height: 100px; 
            overflow-y: auto; 
            padding: 8px; 
        }
        .checkbox-group div { margin-bottom: 3px; display: flex; align-items: center;}
        .checkbox-group input[type="checkbox"] { margin-right: 5px; }
        .checkbox-group label { font-weight: normal; font-size: 0.9em; color: var(--legend-label-text);}
        
        .map-container {
            position: relative;
        }
        #map { height: 100%; width: 100%; background-color: var(--map-placeholder-bg); } 
        
        /* --- MAP OVERLAYS --- */
        .map-overlay {
            position: absolute;
            background-color: var(--map-overlay-bg);
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            z-index: 1000; /* Above map tiles */
            max-width: 220px;
            font-size: 0.9em;
        }
        #map-legend {
            top: 15px;
            left: 15px;
        }
        #map-legend h4 { margin: 0 0 10px 0; font-size: 1em; }
        #map-legend ul { list-style: none; padding: 0; margin: 0; }
        #map-legend li { margin-bottom: 5px; display: flex; align-items: center; }
        .legend-icon, .legend-line { display: inline-block; margin-right: 8px; }
        .legend-icon.homicide { width: 12px; height: 12px; background-color: var(--marker-color); border-radius: 50%; border: 1px solid var(--marker-border-color); }
        .legend-line { width: 20px; height: 3px; }
        .legend-line.city { background-color: var(--boundary-city-color); }
        .legend-line.ccid { background-color: var(--boundary-ccid-color); }

        #map-info-panel {
            top: 15px;
            right: 15px;
        }
        #map-info-panel h4 { margin: 0 0 10px 0; font-size: 1em; border-bottom: 1px solid var(--header-border); padding-bottom: 5px;}
        .info-summary .stat-total { text-align: center; margin-bottom: 10px; }
        .info-summary .stat-total strong { font-size: 2.2em; font-weight: 700; display: block; line-height: 1.1; }
        .info-summary hr { border: 0; border-top: 1px solid var(--header-border); margin: 10px 0; }
        .info-summary .stat-breakdown strong { font-weight: 600; display: block; margin-bottom: 5px; }
        .info-summary .stat-breakdown ul { list-style: none; padding-left: 10px; margin: 0; }
        .info-summary .prompt { margin-top: 10px; font-style: italic; font-size: 0.85em; color: var(--chart-axis-text); text-align: center;}
        
        .info-details .detail-victim { font-size: 1.2em; font-weight: 700; margin-bottom: 10px; }
        .info-details hr { border: 0; border-top: 1px solid var(--header-border); margin: 10px 0; }
        .info-details .detail-list { list-style: none; padding: 0; margin: 0; }
        .info-details .detail-list li { margin-bottom: 4px; }
        .info-details .detail-list strong { color: var(--legend-label-text); }
        
        #back-to-summary-btn {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            background-color: var(--tip-button-bg);
            color: var(--banner-text);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        #back-to-summary-btn:hover {
            background-color: var(--tip-button-hover-bg);
        }

        .leaflet-control-layers {
             background: var(--map-overlay-bg);
             border: 1px solid var(--legend-border);
             box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        /* --- Chart and Tab Styles --- */
        .charts-container-wrapper {
            border-top: 1px solid var(--legend-border);
            display: flex;
            flex-direction: column;
            padding: 10px;
        }
        .charts-container {
            display: flex;
            flex-direction: column;
            min-height: 450px; /* Give charts adequate space */
        }
        .chart-tabs {
            display: flex;
            border-bottom: 1px solid var(--legend-border);
            padding: 0 10px;
            flex-shrink: 0;
        }
        .tab-btn {
            padding: 8px 12px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-weight: bold;
            color: var(--text-color);
            border-bottom: 3px solid transparent;
            margin-bottom: -1px; 
            font-size: 0.9em;
        }
        .tab-btn.active {
            border-bottom-color: var(--banner-bg);
            color: var(--banner-bg);
        }
        .chart-tab-content {
            display: none;
            flex-wrap: nowrap;
            flex-grow: 1;
        }
        .chart-tab-content.active {
            display: flex;
        }

        .chart-box { 
            padding: 15px; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            box-sizing: border-box; 
        }
        
        #main-trends-content .chart-box { width: 50%; }
        #main-trends-content .chart-box:first-child { border-right: 1px solid var(--legend-border); }
       
        #details-content .chart-box { width: 25%; }
        #details-content .chart-box:not(:last-child) {
            border-right: 1px solid var(--legend-border);
        }

        .chart-box h4 { text-align: center; margin-top: 0; margin-bottom: 10px; font-size: 1em; color: var(--chart-title-text); }
        .chart-canvas-container { flex-grow: 1; position: relative; min-height: 250px; } 

        .footer {
            padding: 8px 15px; text-align: center; 
            font-size: 0.75em; color: var(--footer-text); 
            background-color: var(--footer-bg);
            border-top: 1px solid var(--header-border); flex-shrink: 0;
        }
        .footer p { margin: 3px 0; } 
        .footer a { color: var(--footer-link); text-decoration: none; } 
        .footer a:hover { text-decoration: underline; }

        /* --- MODAL STYLES --- */
        .modal-overlay {
            display: none; position: fixed;
            z-index: 1001; left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5); 
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fefefe; padding: 20px;
            border: 1px solid #888; border-radius: 8px;
            width: 90%; max-width: 600px; position: relative;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
        }
        .modal-close {
            color: #aaa; position: absolute; top: 10px; right: 20px;
            font-size: 28px; font-weight: bold; line-height: 1;
            cursor: pointer;
        }
        .modal-close:hover, .modal-close:focus { color: black; text-decoration: none; }
        .modal-content h2 { margin-top: 0; color: #333; }
        .modal-content p { line-height: 1.6; color: #555; }
        .modal-content .emergency { color: #d9534f; font-weight: bold; text-align: center; border: 1px solid; padding: 10px; border-radius: 5px; margin-bottom: 15px;}
        .modal-content ul { list-style: none; padding: 0;}
        .modal-content li { margin-bottom: 15px; }
        .modal-content a { color: var(--footer-link); text-decoration: none; font-weight: bold;}
        .modal-content a:hover { text-decoration: underline; }
        
        .tip-button-floating {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: var(--tip-button-bg);
            color: var(--banner-text);
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .tip-button-floating:hover {
            background-color: var(--tip-button-hover-bg);
            transform: scale(1.05);
        }
        .tip-button-floating svg { width: 28px; height: 28px; }

        /* --- RESPONSIVE STYLES --- */
        @media (max-width: 900px) {
            .main-content-area { 
                display: flex;
                flex-direction: column; 
                height: auto;
                min-height: 0;
            }
            .left-column { 
                border-right: none; 
                overflow-y: visible;
                height: auto;
            } 
            .map-container {
                height: 50vh; /* Give map a fixed height on mobile */
            }
            .charts-container-wrapper {
                height: auto;
            }
            .filter-columns-wrapper {
                grid-template-columns: 1fr;
            }
            .chart-tab-content {
                flex-direction: column;
            }
            #main-trends-content .chart-box, #details-content .chart-box {
                width: 100%;
                border-right: none;
            }
            #main-trends-content .chart-box:first-child, #details-content .chart-box:not(:last-child) {
                border-bottom: 1px solid var(--legend-border);
            }
        }
    </style>
</head>
<body>
<div class="dashboard-container">
   <div class="header">
        <div class="header-logo-secondary">
            <!-- Placeholder for WLBT Logo -->
            <img id="wlbtLogoImg" src="https://placehold.co/200x45/eeeeee/212529?text=WLBT+Logo" alt="WLBT Logo">
        </div>
        <div class="count-banner" id="homicideCountBanner">2025 COUNT: ...</div>
        <div class="ranking-banner" id="rankingBanner">
            <div class="ticker-wrap" id="tickerWrap"></div>
        </div>
        <div class="header-logo-main">
            <!-- Placeholder for Tracking Logo -->
            <img id="trackingLogoImg" src="https://placehold.co/300x45/212529/ffffff?text=Tracking+Homicides" alt="Tracking Jackson's Homicides Logo">
        </div>
   </div>

    <div class="main-content-area">
        <div class="left-column">
            <div class="filters-container">
                <div class="filter-columns-wrapper">
                    <div class="filter-group year-filter">
                        <label class="group-label" for="yearFilter">Year:</label>
                        <div id="yearFilter" class="checkbox-group"></div>
                    </div>
                    <div class="filter-group agency-filter">
                        <label class="group-label" for="agencyFilter">Agency:</label>
                        <div id="agencyFilter" class="checkbox-group"></div>
                    </div>
                    <div class="filter-group circumstance-filter">
                        <label class="group-label" for="circumstanceFilter">Circumstance:</label>
                        <select id="circumstanceFilter"></select>
                    </div>
                     <div class="filter-group trends-container">
                        <label class="group-label">Trends</label>
                        <div class="trends-grid">
                            <div class="trend-box">
                                <span class="trend-label">vs. Last Year (YTD)</span>
                                <div id="percentageChangeText" class="trend-value"></div>
                            </div>
                            <div class="trend-box-split">
                                <div class="trend-box">
                                    <span class="trend-label">This Month</span>
                                    <div id="thisMonthValue" class="trend-value"></div>
                                </div>
                                <div class="trend-box">
                                    <span class="trend-label">5-Yr Avg</span>
                                    <div id="fiveYearAvgValue" class="trend-value"></div>
                                </div>
                            </div>
                             <div class="trend-box">
                                <span class="trend-label">Last 30 Days</span>
                                <div id="rolling30DayText" class="trend-value"></div>
                            </div>
                        </div>
                    </div>
                </div> 
            </div>
        </div>
        <div class="map-container">
            <div id="map"></div>
            <!-- NEW: Map Legend Overlay -->
            <div id="map-legend" class="map-overlay">
                <h4>Legend</h4>
                <ul>
                    <li><span class="legend-icon homicide"></span> Homicide</li>
                    <li><span class="legend-line city"></span> City Limits</li>
                    <li><span class="legend-line ccid"></span> CCID Boundary</li>
                </ul>
            </div>
            <!-- NEW: Map Info Panel -->
            <div id="map-info-panel" class="map-overlay">
                <!-- Content will be dynamically inserted by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Charts are now outside the main grid area to allow scrolling -->
    <div class="charts-container-wrapper">
        <div class="charts-container">
            <div class="chart-tabs">
                <button class="tab-btn active" data-tab="main-trends-content">Key Trends</button>
                <button class="tab-btn" data-tab="details-content">Detailed Breakdowns</button>
            </div>

            <div id="main-trends-content" class="chart-tab-content active">
                <div class="chart-box">
                    <h4>Cumulative Homicides by Year</h4>
                    <div class="chart-canvas-container">
                        <canvas id="homicideTrendsChart"></canvas>
                    </div>
                </div>
                <div class="chart-box">
                    <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <h4 style="margin: 0;">Homicides by Year</h4>
                        <button id="toggleYearRangeBtn" style="padding: 3px 10px; font-size: 0.8em; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; background-color: #f0f0f0;">Show All Years</button>
                    </div>
                    <div class="chart-canvas-container">
                        <canvas id="homicidesByYearChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="details-content" class="chart-tab-content">
                <div class="chart-box">
                    <h4>Victims by Age Group</h4>
                    <div class="chart-canvas-container">
                        <canvas id="victimsByAgeChart"></canvas>
                    </div>
                </div>
                <div class="chart-box">
                    <h4>Victims by Race</h4>
                    <div class="chart-canvas-container">
                        <canvas id="victimsByRaceChart"></canvas>
                    </div>
                </div>
                <div class="chart-box">
                    <h4>Homicides by Circumstance</h4>
                    <div class="chart-canvas-container">
                        <canvas id="homicidesByCircumstanceChart"></canvas>
                    </div>
                </div>
                <div class="chart-box">
                    <h4>Homicides by Agency</h4>
                    <div class="chart-canvas-container">
                        <canvas id="homicidesByAgencyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">
            <p><a href="#" id="openAboutModal">About the Data</a></p>
            <p>Data Sources: JPD, DPS, Hinds County, JSUPD | Design/Layout: C.J. LeMaster</p>
        </div>
    </div>
    
    <!-- Modals with restored content -->
    <div id="aboutDataModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" id="closeAboutModal">×</span>
            <h2>Our Methodology</h2>
            <p><strong>Homicide</strong> refers to one person killing another, regardless of intent. Unlike <strong>murder</strong>, which implies intent, some homicides—such as <strong>justified or officer-involved deaths</strong>—are not crimes. That’s why the number of homicides is typically higher than murders.</p>
            <p><strong>WLBT uses the same criteria as the Jackson Police Department:</strong> we count all homicides, including justified ones, but exclude most vehicular homicides unless officially classified as such. Our numbers come from <strong>JPD releases</strong>, <strong>confirmations from police and the coroner</strong>, and 
                <strong>reports from other lead agencies</strong> when killings occur within Jackson city limits.</p>
            <p><strong>Because we count all homicides that happen in Jackson</strong>—not just those investigated by JPD—our totals may differ from those reported by individual agencies. For example, <strong>Capitol Police and Jackson State officers</strong> have led several homicide investigations in recent years.</p>
            <p><strong>Our data may be updated</strong> as new cases surface. In 2023, we discovered JPD had not disclosed 24 homicide cases, prompting a correction in our reporting. Since then, <strong>we regularly request updates</strong> to prevent similar omissions.</p>
            <p>Some details—like <strong>age, race, or exact location</strong>—may be missing due to gaps in law enforcement reporting. Still, <strong>we work to verify and include as much information as possible</strong> to help the public and investigators.</p>
        </div>
    </div>
    <div id="tipModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" id="closeTipModal">×</span>
            <h2>Submit a Tip</h2>
            <p class="emergency">If this is an emergency or you are witnessing a crime in progress, please call 911 immediately.</p>
            <p>Your information could be crucial to solving a case. You can report tips through the following channels:</p>
            <ul>
                <li>
                    <strong>Jackson Police Department:</strong><br>
                    Call <a href="tel:601-960-1234">601-960-1234</a> to speak with an officer directly.
                </li>
                 <li>
                    <strong>Capitol Police:</strong><br>
                    Call their dispatch at <a href="tel:601-359-3125">601-359-3125</a>.
                </li>
                <li>
                    <strong>Crime Stoppers (Anonymous):</strong><br>
                    Call <a href="tel:601-355-8477">601-355-TIPS (8477)</a> or submit a tip online through <a href="https://www.p3tips.com/TipForm.aspx?ID=116&C=&T=" target="_blank" rel="noopener noreferrer">P3 Tips</a>. You may be eligible for a cash reward.
                </li>
            </ul>
        </div>
    </div>
</div>

<button class="tip-button-floating" id="openTipModal" title="Submit a Tip" aria-label="Submit a Tip">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
</button>

<script>
    // --- Configuration ---
    const HOMICIDE_DATA_API_URL = './data/homicide.json'; 
    const API_KEY = 'AIzaSyA3lKCL5czCA1DEj3hF7GWVq_QCE0LNaUI';
    const SPREADSHEET_ID = '1xI9D40BPx5DAXJNeonstksYj0g8SMKUoirFJBMWXYlk';
    const SHEET_NAME = 'Sheet1';
    const CITY_COMPARISON_API_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
    const JACKSON_POPULATION = 143709;
    const CURRENT_YEAR = new Date().getFullYear();
    const PREVIOUS_YEAR = CURRENT_YEAR - 1;
    const START_YEAR_DATA = 2016;
    const MAP_CENTER = [32.2988, -90.1848];
    const MAP_ZOOM = 11;
    const MAP_PAN_OFFSET = [50, 0]; // [x, y] in pixels. Positive x pans left.
    const JACKSON_CITY_LIMITS_GEOJSON_URL = 'https://dl.dropbox.com/scl/fi/9ct9dki2dsg68iyr7gley/City-Boundaries.geojson?rlkey=vjrtpish5tixdeygp1ja5h7fq&st=fyrqfq4x&dl=1';
    const CCID_GEOJSON_URL = 'https://dl.dropbox.com/scl/fi/qz4hkchrk6zonnbr1i5pl/New-CCID-2025.geojson?rlkey=26misdl15h1vgxxj28fzfqhjw&st=82688i24&dl=1';
    const AGENCY_CATEGORIES = { JPD: 'JPD', CAPITOL_POLICE: 'Capitol Police', OTHER: 'Other Agencies' };
    const agencyColors = {
        [AGENCY_CATEGORIES.JPD]: 'rgba(0, 123, 255, 0.7)',
        [AGENCY_CATEGORIES.CAPITOL_POLICE]: 'rgba(255, 193, 7, 0.7)',
        [AGENCY_CATEGORIES.OTHER]: 'rgba(40, 167, 69, 0.7)',
        'Historical': 'rgba(108, 117, 125, 0.7)'
    };
    const historicalHomicideData = [
        { year: 1976, total: 40 }, { year: 1977, total: 47 }, { year: 1978, total: 33 }, { year: 1979, total: 55 }, { year: 1980, total: 42 },
        { year: 1981, total: 49 }, { year: 1982, total: 57 }, { year: 1983, total: 42 }, { year: 1984, total: 34 }, { year: 1985, total: 43 },
        { year: 1986, total: 35 }, { year: 1987, total: 54 }, { year: 1988, total: 51 }, { year: 1989, total: 49 }, { year: 1990, total: 47 },
        { year: 1991, total: 80 }, { year: 1992, total: 64 }, { year: 1993, total: 84 }, { year: 1994, total: 91 }, { year: 1995, total: 92 },
        { year: 1996, total: 61 }, { year: 1997, total: 64 }, { year: 1998, total: 60 }, { year: 1999, total: 45 }, { year: 2000, total: 39 },
        { year: 2001, total: 50 }, { year: 2002, total: 49 }, { year: 2003, total: 45 }, { year: 2004, total: 53 }, { year: 2005, total: 38 },
        { year: 2006, total: 40 }, { year: 2007, total: 46 }, { year: 2008, total: 63 }, { year: 2009, total: 37 }, { year: 2010, total: 41 },
        { year: 2011, total: 52 }, { year: 2012, total: 63 }, { year: 2013, total: 50 }, { year: 2014, total: 61 }, { year: 2015, total: 54 }
    ];

    // --- Global State ---
    let allHomicideData = [];
    let cityComparisonData = [];
    let filteredHomicideDataForMap = [];
    let map;
    let markersLayer = L.layerGroup();
    let heatLayer;
    let cityLimitsLayer, ccidLayer;
    let overlayLayersControl;
    let currentMapTileLayer;
    let showAllYears = false;
    let selectedMarker = null;
    let homicidesByYearChartInstance, homicideTrendsChartInstance, victimsByAgeChartInstance,
        victimsByRaceChartInstance, homicidesByCircumstanceChartInstance, homicidesByAgencyChartInstance;

    const infoPanel = document.getElementById('map-info-panel');
    let defaultMarkerStyle, selectedMarkerStyle;

    // --- Main Execution Block ---
    document.addEventListener('DOMContentLoaded', () => {
        defaultMarkerStyle = {
            radius: 6,
            fillColor: getComputedStyle(document.documentElement).getPropertyValue('--marker-color').trim(),
            color: getComputedStyle(document.documentElement).getPropertyValue('--marker-border-color').trim(),
            weight: 1, opacity: 1, fillOpacity: 0.8
        };
        selectedMarkerStyle = {
            fillColor: getComputedStyle(document.documentElement).getPropertyValue('--marker-selected-color').trim(),
            color: getComputedStyle(document.documentElement).getPropertyValue('--marker-selected-border-color').trim(),
            radius: 8,
        };
        init();
    });

    async function init() {
        initMap();
        setupModals();
        setupTabs();
        setupChartToggles();

        document.getElementById('homicideCountBanner').innerText = `${CURRENT_YEAR} COUNT: Loading...`;
        document.querySelector('.ranking-banner .ticker-wrap').innerHTML = '<div class="ticker-item">City Ranking: Loading...</div>';
        updateInfoPanel([]);

        try {
            const [homicideDataResult, cityDataResult] = await Promise.all([
                fetchDataAndProcess(HOMICIDE_DATA_API_URL, true),
                fetchDataAndProcess(CITY_COMPARISON_API_URL, false)
            ]);

            allHomicideData = homicideDataResult;
            cityComparisonData = cityDataResult;

            populateFiltersForMap(true);
            updateDashboard();
            if (map) map.invalidateSize();
        } catch (error) {
            console.error("Fatal Error initializing dashboard:", error);
        }
    }

    // --- Placeholder Data Functions ---
    function getPlaceholderHomicideData() {
        console.warn("Using placeholder homicide data due to fetch error.");
        return {
            headers: ["Date", "Location", "Victim", "Investigating Agency", "Age", "Race", "Latitude", "Longitude", "Circumstance", "Year"],
            entries: [
                [`01/15/${CURRENT_YEAR}`, "123 Main St, Jackson, MS", 'John Doe', "JPD", 30, "Black", 32.3010, -90.1850, "Argument", CURRENT_YEAR],
                [`02/20/${CURRENT_YEAR}`, "456 Oak Ave, Jackson, MS", 'Jane Smith', "Capitol Police", 25, "White", 32.2950, -90.1900, "Robbery", CURRENT_YEAR],
                [`03/10/${PREVIOUS_YEAR}`, "789 Pine Ln, Jackson, MS", 'Jim Brown', "JPD", 45, "Black", 32.3150, -90.1750, "Unknown", PREVIOUS_YEAR]
            ]
        };
    }

    function getPlaceholderCityData() {
        console.warn("Using placeholder city data due to fetch error.");
        return [
            { City: 'St. Louis, MO', Homicides: 190, Population: 286578 },
            { City: 'Baltimore, MD', Homicides: 330, Population: 569931 },
        ];
    }

    // --- Data Processing Logic ---
    function processHomicideData(rawData) {
        if (!rawData || !rawData.headers || !rawData.entries) {
            console.error("Invalid rawData structure. 'headers' or 'entries' is missing.");
            return [];
        }
        const headers = rawData.headers.map(h => String(h).trim().toLowerCase());
        const getHeaderIndex = (names) => names.map(name => headers.indexOf(name.toLowerCase())).find(index => index !== -1) ?? -1;
        
        const indices = {
            victim: getHeaderIndex(['Victim']), age: getHeaderIndex(['Age']), race: getHeaderIndex(['Race']),
            sex: getHeaderIndex(['Sex']), circumstance: getHeaderIndex(['Circumstance']), date: getHeaderIndex(['Date']),
            address: getHeaderIndex(['Address', 'Location']), agency: getHeaderIndex(['Investigating Agency', 'Agency']),
            lat: getHeaderIndex(['Latitude', 'Lat']), lon: getHeaderIndex(['Longitude', 'Lon', 'Long']),
            year: getHeaderIndex(['Year']), month: getHeaderIndex(['Month']), day: getHeaderIndex(['Day'])
        };

        return rawData.entries.map((entry, i) => {
            let dateObj;
            const dateStr = entry[indices.date] ? String(entry[indices.date]).trim() : '';
            
            if (dateStr) {
                if (dateStr.includes('-')) { dateObj = new Date(dateStr + "T00:00:00"); } 
                else if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) { 
                        let year = parseInt(parts[2]);
                        if (year < 100) year += 2000;
                        dateObj = new Date(year, parseInt(parts[0]) - 1, parts[1]); 
                    }
                }
            }
            if (!dateObj || isNaN(dateObj.getTime())) {
                const year = parseInt(entry[indices.year]), month = parseInt(entry[indices.month]), day = parseInt(entry[indices.day]);
                if (!isNaN(year) && !isNaN(month) && !isNaN(day)) { dateObj = new Date(year, month - 1, day); }
            }

            const lat = parseFloat(entry[indices.lat]), lon = parseFloat(entry[indices.lon]);
            if (!dateObj || isNaN(dateObj.getTime()) || isNaN(lat) || isNaN(lon)) return null;
            
            return {
                Victim: entry[indices.victim] || 'N/A', Age: entry[indices.age] ? parseInt(entry[indices.age]) : null, Race: entry[indices.race] || 'N/A',
                Date: dateObj.toISOString().split('T')[0], DisplayDate: dateStr, Address: entry[indices.address] || 'N/A',
                'Investigating Agency': entry[indices.agency] || 'N/A', Latitude: lat, Longitude: lon, Year: dateObj.getFullYear(),
                Circumstance: entry[indices.circumstance] || 'N/A'
            };
        }).filter(Boolean);
    }

    async function fetchDataAndProcess(url, isMainHomicideData = false) {
        if (isMainHomicideData) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Network response was not ok for ${url}`);
                const rawData = await response.json();
                return processHomicideData(rawData);
            } catch (error) {
                console.error(`Failed to fetch main homicide data:`, error);
                return processHomicideData(getPlaceholderHomicideData());
            }
        } else {
             try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Network response was not ok for ${url}`);
                const rawData = await response.json();
                if (!rawData || !rawData.values) return getPlaceholderCityData();
                const [headerRow, ...dataRows] = rawData.values;
                const headers = headerRow.map(h => h.trim().toLowerCase());
                const cityIndex = headers.indexOf('city'), homicidesIndex = headers.indexOf('homicides'), populationIndex = headers.indexOf('population');
                return dataRows.map(row => ({
                    City: row[cityIndex]?.trim(),
                    Homicides: parseInt(String(row[homicidesIndex]).replace(/,/g, '')),
                    Population: parseInt(String(row[populationIndex]).replace(/,/g, ''))
                })).filter(d => d.City && d.Homicides >= 0 && d.Population > 0);
            } catch (error) {
                console.error(`Failed to fetch city data:`, error);
                return getPlaceholderCityData();
            }
        }
    }

    function updateInfoPanel(data) {
        if (!infoPanel) return;
        if (data && !Array.isArray(data)) {
            const d = data;
            infoPanel.innerHTML = `
                <h4>Homicide Details</h4>
                <div class="info-details">
                    <div class="detail-victim">${d.Victim || 'Unknown Victim'}</div><hr>
                    <ul class="detail-list">
                        ${d.Age ? `<li><strong>Age:</strong> ${d.Age}</li>` : ''}
                        ${d.Race ? `<li><strong>Race:</strong> ${d.Race}</li>` : ''}
                        ${d.DisplayDate ? `<li><strong>Date:</strong> ${d.DisplayDate}</li>` : ''}
                        ${d.Address ? `<li><strong>Address:</strong> ${d.Address}</li>` : ''}
                        ${d['Investigating Agency'] ? `<li><strong>Agency:</strong> ${d['Investigating Agency']}</li>` : ''}
                    </ul>
                    <button id="back-to-summary-btn">Back to Summary</button>
                </div>`;
            
            document.getElementById('back-to-summary-btn').addEventListener('click', () => {
                if (selectedMarker) {
                    selectedMarker.setStyle(defaultMarkerStyle);
                    selectedMarker = null;
                }
                updateInfoPanel(filteredHomicideDataForMap);
            });

        } else {
            const totalCount = data.length;
            const yearCounts = data.reduce((acc, d) => { acc[d.Year] = (acc[d.Year] || 0) + 1; return acc; }, {});
            const yearHtml = Object.keys(yearCounts).sort((a,b) => b-a).map(year => `<li>${year}${year == CURRENT_YEAR ? ' (YTD)' : ''}: ${yearCounts[year]}</li>`).join('');
            const agencyCounts = data.reduce((acc, d) => { const agency = d['Investigating Agency'] || 'Unknown'; acc[agency] = (acc[agency] || 0) + 1; return acc; }, {});
            const agencyHtml = Object.keys(agencyCounts).sort().map(agency => `<li>${agency}: ${agencyCounts[agency]}</li>`).join('');
            infoPanel.innerHTML = `
                <h4>Map Summary</h4>
                <div class="info-summary">
                    <div class="stat-total"><strong>${totalCount}</strong> Homicide${totalCount !== 1 ? 's' : ''} Shown</div>
                    ${yearHtml ? `<hr><div class="stat-breakdown"><strong>By Year:</strong><ul>${yearHtml}</ul></div>` : ''}
                    ${agencyHtml ? `<hr><div class="stat-breakdown"><strong>By Agency:</strong><ul>${agencyHtml}</ul></div>` : ''}
                    <p class="prompt"><i>Click a marker for details</i></p>
                </div>`;
        }
    }

    function initMap() {
        map = L.map('map', { 
            scrollWheelZoom: false, 
            minZoom: MAP_ZOOM,
            zoomControl: false 
        }).setView(MAP_CENTER, MAP_ZOOM);
        
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        updateMapTiles();
        markersLayer.addTo(map);
        heatLayer = L.heatLayer([], { radius: 25, interactive: false });
        loadBoundaryLayers();
        
        // FIXED: Guard the map click handler to ignore stopped events
        map.on('click', (e) => {
            if (e.originalEvent && e.originalEvent._stopped) return; 
            if (selectedMarker) {
                selectedMarker.setStyle(defaultMarkerStyle);
                selectedMarker = null;
            }
            updateInfoPanel(filteredHomicideDataForMap);
        });
    }

    function updateMapDisplay() {
        const selectedYears = Array.from(document.querySelectorAll('#yearFilter input:checked')).map(cb => parseInt(cb.value));
        const selectedAgencies = Array.from(document.querySelectorAll('#agencyFilter input:checked')).map(cb => cb.value);
        const selectedCircumstance = document.getElementById('circumstanceFilter').value;
        filteredHomicideDataForMap = allHomicideData.filter(d => 
            selectedYears.includes(d.Year) &&
            selectedAgencies.includes(d['Investigating Agency']) &&
            (!selectedCircumstance || d.Circumstance === selectedCircumstance)
        );
        markersLayer.clearLayers();
        const heatPoints = [];
        const visibleMarkers = [];
        
        filteredHomicideDataForMap.forEach(d => {
            const latLng = [d.Latitude, d.Longitude];
            heatPoints.push(latLng);
            
            // FIXED: Prevent Leaflet from bubbling mouse events from the marker
            const marker = L.circleMarker(latLng, { ...defaultMarkerStyle, bubblingMouseEvents: false });
            
            // FIXED: Stop the original DOM event to prevent the map's handler from firing
            marker.on('click', (e) => {
                if (e.originalEvent) L.DomEvent.stop(e.originalEvent); else L.DomEvent.stop(e);
                if (selectedMarker) {
                    selectedMarker.setStyle(defaultMarkerStyle);
                }
                marker.setStyle(selectedMarkerStyle);
                selectedMarker = marker;
                updateInfoPanel(d);
            });
            
            markersLayer.addLayer(marker);
            visibleMarkers.push(marker);
        });
        heatLayer.setLatLngs(heatPoints);
        updateInfoPanel(filteredHomicideDataForMap);
        if (visibleMarkers.length > 0 && map.hasLayer(markersLayer)) {
            map.fitBounds(L.featureGroup(visibleMarkers).getBounds().pad(0.1));
            // Apply pan offset after fitting bounds
            if (MAP_PAN_OFFSET[0] !== 0 || MAP_PAN_OFFSET[1] !== 0) {
                map.panBy(MAP_PAN_OFFSET);
            }
        } else {
            map.setView(MAP_CENTER, MAP_ZOOM);
        }
    }
    
    function setupModals() {
        const aboutModal = document.getElementById("aboutDataModal");
        const openAboutBtn = document.getElementById("openAboutModal");
        const closeAboutBtn = document.getElementById("closeAboutModal");
        openAboutBtn.onclick = (e) => { e.preventDefault(); aboutModal.style.display = "flex"; };
        closeAboutBtn.onclick = () => { aboutModal.style.display = "none"; };
        const tipModal = document.getElementById("tipModal");
        const openTipBtn = document.getElementById("openTipModal");
        const closeTipBtn = document.getElementById("closeTipModal");
        openTipBtn.onclick = () => { tipModal.style.display = "flex"; };
        closeTipBtn.onclick = () => { tipModal.style.display = "none"; };
        window.onclick = (event) => {
            if (event.target == aboutModal) aboutModal.style.display = "none";
            if (event.target == tipModal) tipModal.style.display = "none";
        };
    }

    function setupTabs() {
        document.querySelector('.chart-tabs').addEventListener('click', (event) => {
            if (event.target.classList.contains('tab-btn')) {
                openTab(event, event.target.dataset.tab);
            }
        });
    }
    
    function setupChartToggles() {
        document.getElementById('toggleYearRangeBtn')?.addEventListener('click', () => {
            showAllYears = !showAllYears;
            document.getElementById('toggleYearRangeBtn').textContent = showAllYears ? 'Show Recent Years' : 'Show All Years';
            updateHomicidesByYearChart();
        });
    }

    function openTab(evt, tabName) {
        document.querySelectorAll('.chart-tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.target.classList.add('active');
    }

    function populateFiltersForMap(isInitialLoad = false) {
        const yearContainer = document.getElementById('yearFilter');
        if (isInitialLoad) {
            const allYears = [...new Set(allHomicideData.map(d => d.Year))].sort((a, b) => b - a);
            populateCheckboxFilter('yearFilter', allYears.filter(y => y >= START_YEAR_DATA), [CURRENT_YEAR], handleYearFilterChange);
        }
        const selectedYears = Array.from(yearContainer.querySelectorAll('input:checked')).map(cb => parseInt(cb.value));
        const dataForDependentFilters = allHomicideData.filter(d => selectedYears.includes(d.Year));
        const agenciesToShow = [...new Set(dataForDependentFilters.map(d => d['Investigating Agency']))].filter(Boolean).sort();
        populateCheckboxFilter('agencyFilter', agenciesToShow, agenciesToShow, updateDashboard);
        const circumstancesToShow = [...new Set(dataForDependentFilters.map(d => d.Circumstance))].filter(Boolean).sort();
        const circumstanceSelect = document.getElementById('circumstanceFilter');
        circumstanceSelect.innerHTML = '<option value="">All Circumstances</option>';
        circumstancesToShow.forEach(c => circumstanceSelect.add(new Option(c, c)));
        circumstanceSelect.onchange = updateDashboard;
    }

    function handleYearFilterChange() {
        populateFiltersForMap(false);
        updateDashboard();
    }

    function populateCheckboxFilter(elementId, values, defaultSelected, changeCallback) {
        const container = document.getElementById(elementId);
        const previouslySelected = Array.from(container.querySelectorAll('input:checked')).map(cb => cb.value);
        container.innerHTML = '';
        values.forEach(val => {
            const div = document.createElement('div');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `${elementId}_${String(val).replace(/\s+/g, '_')}`;
            checkbox.value = val;
            checkbox.checked = defaultSelected.includes(val) || previouslySelected.includes(String(val));
            checkbox.addEventListener('change', changeCallback);
            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = val;
            div.append(checkbox, label);
            container.appendChild(div);
        });
    }

    function updateCurrentYearHomicideCount() {
        const count = allHomicideData.filter(d => d.Year === CURRENT_YEAR).length;
        document.getElementById('homicideCountBanner').innerText = `${CURRENT_YEAR} COUNT: ${count}`;
    }

    function updateRankingBanner() {
        const banner = document.getElementById('rankingBanner');
        const tickerWrap = document.getElementById('tickerWrap');
        const jacksonCount = allHomicideData.filter(d => d.Year === CURRENT_YEAR).length;
        const jacksonRate = (jacksonCount / JACKSON_POPULATION) * 100000;
        if (!cityComparisonData || cityComparisonData.length === 0) {
            tickerWrap.innerHTML = `<div class="ticker-item">Comparison data unavailable.</div>`;
            return;
        }
        const citiesWithRates = cityComparisonData.map(c => ({ name: c.City, rate: (c.Homicides / c.Population) * 100000 }));
        citiesWithRates.push({ name: 'Jackson, MS', rate: jacksonRate });
        citiesWithRates.sort((a, b) => b.rate - a.rate);
        const jacksonRank = citiesWithRates.findIndex(c => c.name === 'Jackson, MS') + 1;
        let bannerColorVar = jacksonRank === 1 ? '--rank-banner-rank1-bg' : (jacksonRank <= 5 ? '--rank-banner-rank2to5-bg' : '--rank-banner-ranklow-bg');
        banner.style.backgroundColor = `var(${bannerColorVar})`;
        const top5 = citiesWithRates.slice(0, 5);
        const tickerItems = ["Top 5 Homicide Rates (per 100k)"];
        top5.forEach((c, i) => tickerItems.push(`${i + 1}. ${c.name} <span>(${c.rate.toFixed(1)})</span>`));
        if (!top5.some(c => c.name === 'Jackson, MS') && jacksonRank > 0) {
            tickerItems.push(`... | ${jacksonRank}. Jackson, MS <span>(${jacksonRate.toFixed(1)})</span>`);
        }
        const tickerText = tickerItems.join(' &nbsp; | &nbsp; ');
        tickerWrap.innerHTML = `<div class="ticker-item">${tickerText}</div><div class="ticker-item">${tickerText}</div>`;
    }
    
    function updatePercentageChangeDisplay() {
        const div = document.getElementById('percentageChangeText');
        const today = new Date();
        const dayOfYear = (Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()) - Date.UTC(today.getFullYear(), 0, 0)) / 86400000;
        const getCountUpToDay = (year, day) => allHomicideData.filter(d => {
            if (d.Year !== year || !d.Date) return false;
            const itemDate = new Date(d.Date + 'T00:00:00');
            const itemDayOfYear = (Date.UTC(itemDate.getFullYear(), itemDate.getMonth(), itemDate.getDate()) - Date.UTC(itemDate.getFullYear(), 0, 0)) / 86400000;
            return itemDayOfYear <= day;
        }).length;
        const currentYTD = getCountUpToDay(CURRENT_YEAR, dayOfYear);
        const prevYTD = getCountUpToDay(PREVIOUS_YEAR, dayOfYear);
        let text = "N/A", colorVar = '--percentage-neutral-color';
        if (prevYTD > 0) {
            const change = ((currentYTD - prevYTD) / prevYTD) * 100;
            text = `${change > 0 ? '+' : ''}${change.toFixed(0)}%`;
            colorVar = change > 0 ? '--percentage-increase-color' : '--percentage-decrease-color';
            if (change === 0) colorVar = '--percentage-neutral-color';
        } else if (currentYTD > 0) {
            text = `+${currentYTD}`; colorVar = '--percentage-increase-color';
        } else { text = "0%"; }
        div.innerText = text;
        div.style.color = `var(${colorVar})`;
    }

    function updateMonthlyTrend() {
        const thisMonthDiv = document.getElementById('thisMonthValue');
        const fiveYearAvgDiv = document.getElementById('fiveYearAvgValue');
        const today = new Date(), month = today.getMonth(), year = today.getFullYear();
        const thisMonthCount = allHomicideData.filter(d => new Date(d.Date + 'T00:00:00').getFullYear() === year && new Date(d.Date + 'T00:00:00').getMonth() === month).length;
        let total = 0, years = 0;
        for (let i = 1; i <= 5; i++) {
            total += allHomicideData.filter(d => new Date(d.Date + 'T00:00:00').getFullYear() === (year - i) && new Date(d.Date + 'T00:00:00').getMonth() === month).length;
            years++;
        }
        const avg = years > 0 ? (total / years) : 0;
        thisMonthDiv.innerText = thisMonthCount;
        fiveYearAvgDiv.innerText = avg.toFixed(1);
        thisMonthDiv.style.color = `var(${thisMonthCount > avg ? '--percentage-increase-color' : (thisMonthCount < avg ? '--percentage-decrease-color' : '--percentage-neutral-color')})`;
    }

    function updateRolling30DayTrend() {
        const div = document.getElementById('rolling30DayText');
        const today = new Date();
        const thirtyDaysAgo = new Date(new Date().setDate(today.getDate() - 30));
        const count = allHomicideData.filter(d => {
            const date = new Date(d.Date + 'T00:00:00');
            return date >= thirtyDaysAgo && date <= today;
        }).length;
        div.innerText = count;
    }

    function getChartOptions(tooltipCallback) {
        const textColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-axis-text').trim();
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-grid-color').trim();
        return {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { ticks: { color: textColor }, grid: { color: gridColor } }, y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } } },
            plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false, callbacks: { label: tooltipCallback } } }
        };
    }

    function updateHomicidesByYearChart() {
        const ctx = document.getElementById('homicidesByYearChart').getContext('2d');
        if (homicidesByYearChartInstance) homicidesByYearChartInstance.destroy();
        const chartOptions = getChartOptions(() => {});
        if (showAllYears) {
            const yearlyTotals = {};
            historicalHomicideData.forEach(d => { yearlyTotals[d.year] = d.total; });
            allHomicideData.forEach(d => { yearlyTotals[d.Year] = (yearlyTotals[d.Year] || 0) + 1; });
            const years = Object.keys(yearlyTotals).map(Number).sort((a, b) => a - b).filter(y => y <= CURRENT_YEAR);
            const totals = years.map(y => yearlyTotals[y]);
            chartOptions.plugins.legend.display = false;
            homicidesByYearChartInstance = new Chart(ctx, { type: 'bar', data: { labels: years, datasets: [{ label: 'Total Homicides', data: totals, backgroundColor: agencyColors['Historical'] }] }, options: chartOptions });
        } else {
            const yearlyTotals = {};
            const years = Array.from({length: CURRENT_YEAR - START_YEAR_DATA + 1}, (_, i) => START_YEAR_DATA + i);
            years.forEach(y => yearlyTotals[y] = { [AGENCY_CATEGORIES.JPD]: 0, [AGENCY_CATEGORIES.CAPITOL_POLICE]: 0, [AGENCY_CATEGORIES.OTHER]: 0 });
            allHomicideData.forEach(d => {
                if (d.Year >= START_YEAR_DATA) {
                    const cat = d['Investigating Agency'] === 'JPD' ? 'JPD' : (d['Investigating Agency'] === 'Capitol Police' ? 'Capitol Police' : 'Other Agencies');
                    yearlyTotals[d.Year][cat]++;
                }
            });
            chartOptions.scales.x.stacked = true; chartOptions.scales.y.stacked = true;
            const datasets = Object.values(AGENCY_CATEGORIES).map(cat => ({ label: cat, data: years.map(y => yearlyTotals[y][cat]), backgroundColor: agencyColors[cat] }));
            homicidesByYearChartInstance = new Chart(ctx, { type: 'bar', data: { labels: years, datasets }, options: chartOptions });
        }
    }

    function updateHomicideTrendsChart() {
        const ctx = document.getElementById('homicideTrendsChart').getContext('2d');
        if (homicideTrendsChartInstance) homicideTrendsChartInstance.destroy();
        const getRunningTotalData = (year) => {
            const yearData = allHomicideData.filter(d => d.Year === year).sort((a, b) => new Date(a.Date) - new Date(b.Date));
            const chartDataPoints = [];
            const commonAxisYear = 2000; 
            let cumulativeCount = 0;
            let homicideDataIndex = 0;
            let loopEndDate = (year === CURRENT_YEAR) ? new Date() : new Date(year, 11, 31);
            for (let dLoop = new Date(year, 0, 1); dLoop <= loopEndDate; dLoop.setDate(dLoop.getDate() + 1)) {
                const currentLoopDayFormatted = dLoop.toISOString().split('T')[0];
                while(homicideDataIndex < yearData.length && yearData[homicideDataIndex].Date <= currentLoopDayFormatted) {
                    cumulativeCount++;
                    homicideDataIndex++;
                }
                chartDataPoints.push({
                    x: `${commonAxisYear}-${(dLoop.getMonth() + 1).toString().padStart(2, '0')}-${dLoop.getDate().toString().padStart(2, '0')}`,
                    y: cumulativeCount 
                });
            }
            if (chartDataPoints.length === 0 || chartDataPoints[0].x !== `${commonAxisYear}-01-01`) {
                chartDataPoints.unshift({ x: `${commonAxisYear}-01-01`, y: 0 });
            }
            return chartDataPoints;
        };
        homicideTrendsChartInstance = new Chart(ctx, { type: 'line', data: {
            datasets: [
                { label: String(CURRENT_YEAR), data: getRunningTotalData(CURRENT_YEAR), borderColor: '#dc3545', tension: 0.1 },
                { label: String(PREVIOUS_YEAR), data: getRunningTotalData(PREVIOUS_YEAR), borderColor: '#007bff', tension: 0.1 }
            ]},
            options: { ...getChartOptions(() => {}), scales: { x: { type: 'time', time: { unit: 'month' } }, y: { beginAtZero: true } } }
        });
    }

    function updateDemographicCharts() {
        const ageGroups = { '0-17': 0, '18-29': 0, '30-49': 0, '50+': 0, 'Unknown': 0 };
        filteredHomicideDataForMap.forEach(d => {
            const age = d.Age;
            if (age === null) ageGroups['Unknown']++;
            else if (age <= 17) ageGroups['0-17']++;
            else if (age <= 29) ageGroups['18-29']++;
            else if (age <= 49) ageGroups['30-49']++;
            else ageGroups['50+']++;
        });
        const ageCtx = document.getElementById('victimsByAgeChart').getContext('2d');
        if (victimsByAgeChartInstance) victimsByAgeChartInstance.destroy();
        victimsByAgeChartInstance = new Chart(ageCtx, { type: 'bar', data: { labels: Object.keys(ageGroups), datasets: [{ label: 'Victims by Age', data: Object.values(ageGroups), backgroundColor: '#5bc0de' }] }, options: { ...getChartOptions(() => {}), plugins: { legend: { display: false } } } });
    }
    
    function updateVictimsByRaceChart() {
        const counts = filteredHomicideDataForMap.reduce((acc, d) => { acc[d.Race || 'Unknown'] = (acc[d.Race || 'Unknown'] || 0) + 1; return acc; }, {});
        if (victimsByRaceChartInstance) victimsByRaceChartInstance.destroy();
        victimsByRaceChartInstance = new Chart(document.getElementById('victimsByRaceChart'), { type: 'pie', data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }}} });
    }

    function updateHomicidesByCircumstanceChart() {
        const counts = filteredHomicideDataForMap.reduce((acc, d) => { acc[d.Circumstance || 'Unknown'] = (acc[d.Circumstance || 'Unknown'] || 0) + 1; return acc; }, {});
        if (homicidesByCircumstanceChartInstance) homicidesByCircumstanceChartInstance.destroy();
        homicidesByCircumstanceChartInstance = new Chart(document.getElementById('homicidesByCircumstanceChart'), { type: 'bar', data: { labels: Object.keys(counts), datasets: [{ label: 'Count', data: Object.values(counts), backgroundColor: '#6f42c1' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }}} });
    }

    function updateHomicidesByAgencyChart() {
        const counts = filteredHomicideDataForMap.reduce((acc, d) => { acc[d['Investigating Agency'] || 'Unknown'] = (acc[d['Investigating Agency'] || 'Unknown'] || 0) + 1; return acc; }, {});
        if (homicidesByAgencyChartInstance) homicidesByAgencyChartInstance.destroy();
        homicidesByAgencyChartInstance = new Chart(document.getElementById('homicidesByAgencyChart'), { type: 'pie', data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }}} });
    }
    
    function updateDashboard() {
        updateCurrentYearHomicideCount();
        updateRankingBanner();
        updatePercentageChangeDisplay();
        updateMonthlyTrend();
        updateRolling30DayTrend();
        updateMapDisplay();
        updateHomicidesByYearChart();
        updateHomicideTrendsChart();
        updateDemographicCharts();
        updateVictimsByRaceChart();
        updateHomicidesByCircumstanceChart();
        updateHomicidesByAgencyChart();
    }

    function loadBoundaryLayers(){
        const baseLayers = { "Markers": markersLayer, "Heatmap": heatLayer };
        const overlayMaps = {};
        const fetchGeoJSON = async (url, style, name) => {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const geojson = await response.json();
                // FIXED: Make boundary layers non-interactive and send them to the back
                const layer = L.geoJSON(geojson, { style, interactive: false });
                layer.addTo(map);
                layer.bringToBack();
                overlayMaps[name] = layer;
                return layer;
            } catch (error) { console.error(`Error loading ${name} GeoJSON:`, error); return null; }
        };
        Promise.all([
            fetchGeoJSON(JACKSON_CITY_LIMITS_GEOJSON_URL, { color: `var(--boundary-city-color)`, weight: 3, opacity: 0.85, fillOpacity: 0.0 }, "Jackson City Limits"),
            fetchGeoJSON(CCID_GEOJSON_URL, { color: `var(--boundary-ccid-color)`, weight: 4, opacity: 0.9, fillOpacity: 0.25 }, "CCID Boundary")
        ]).then(([cityLayer, ccidLayerResult]) => {
            cityLimitsLayer = cityLayer;
            ccidLayer = ccidLayerResult;
            if (overlayLayersControl) map.removeControl(overlayLayersControl);
            overlayLayersControl = L.control.layers(baseLayers, overlayMaps, { position: 'bottomleft' }).addTo(map);
        });
    }
    function updateMapTiles() {
        if (currentMapTileLayer) map.removeLayer(currentMapTileLayer);
        currentMapTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
    }
</script>
</body>
</html>

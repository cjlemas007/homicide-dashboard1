<!DOCTYPE html>
<!-- saved from url=(0039)https://homicide-dashboard.netlify.app/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracking Jackson's Homicides</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <style>
        /* --- BASE STYLES & COLOR THEME --- */
        :root {
            --body-bg: #e9ecef;
            --content-bg: #ffffff;
            --text-color: #212529;
            --header-bg: #ffffff;
            --header-border: #dee2e6;
            --banner-bg: #d9534f; 
            --banner-text: #ffffff;
            --legend-bg: #f8f9fa;
            --legend-border: #dee2e6;
            --legend-label-text: #495057;
            --input-border: #ced4da;
            --input-bg: #ffffff;
            --chart-title-text: #343a40;
            --chart-axis-text: #6c757d;
            --chart-grid-color: rgba(0, 0, 0, 0.1);
            --chart-legend-text: #333;
            --footer-bg: #f8f9fa;
            --footer-text: #6c757d;
            --footer-link: #0056b3;
            --tooltip-bg: rgba(33, 37, 41, 0.9);
            --tooltip-text: #f8f9fa;
            --map-placeholder-bg: #adb5bd;
            --boundary-city-color: #000000; 
            --boundary-ccid-color: #E65100; 
            --rank-banner-rank1-bg: #d9534f; 
            --rank-banner-rank2to5-bg: #f0ad4e; 
            --rank-banner-ranklow-bg: #5cb85c; 
            --rank-banner-error-bg: #777777; 
            --percentage-increase-color: #d9534f; 
            --percentage-decrease-color: #5cb85c; 
            --percentage-neutral-color: var(--text-color); 
        }
        
        body, html {
            height: 100%; margin: 0; padding: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            display: flex; flex-direction: column;
            background-color: var(--body-bg);
            color: var(--text-color);
            -webkit-text-size-adjust: 100%; 
            text-size-adjust: 100%;
        }

        /* --- LAYOUT & COMPONENT STYLES --- */
        .header {
            display: flex; justify-content: center; align-items: center;
            padding: 10px 15px; 
            background-color: var(--header-bg);
            border-bottom: 2px solid var(--header-border);
            flex-shrink: 0;
            position: relative; 
        }
        .header-logo-main { }
        .header-logo-secondary {
            position: absolute;
            right: 20px; 
            top: 50%;
            transform: translateY(-50%);
        }
        .header-logo-main img, .header-logo-secondary img { 
            max-height: 45px; 
            width: auto; 
            object-fit: contain; 
            vertical-align: middle; 
        } 
        
        .count-banner { 
            color: var(--banner-text);
            text-align: center; padding: 8px 15px; 
            font-size: 1.8em; 
            font-weight: bold;
            flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            background-color: var(--banner-bg);
        }
        
        /* --- TICKER STYLES --- */
        .ranking-banner {
            font-size: 1.1em;
            padding: 0;
            background-color: var(--rank-banner-error-bg);
            overflow: hidden;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: var(--banner-text);
            font-weight: bold;
            flex-shrink: 0;
        }

        .ticker-wrap {
            display: inline-block;
            padding: 8px 0;
            animation: ticker 40s linear infinite; /* Adjusted duration for more content */
        }
        
        .ticker-item {
            display: inline-block;
            padding: 0 2rem;
            color: var(--banner-text);
        }
        .ticker-item span {
            font-weight: normal;
            opacity: 0.9;
        }

        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        .main-content-area { 
            display: flex; 
            flex: 1 1 auto; 
            min-height: 300px; 
            background-color: var(--content-bg); 
        }
        
        .legend-container {
            width: 30%; 
            max-width: 400px; 
            padding: 15px; 
            border-right: 1px solid var(--legend-border);
            overflow-y: auto; background-color: var(--legend-bg); 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0; 
        }
        
        .filter-columns-wrapper { 
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between; 
            flex-grow: 1; 
            margin-bottom: 10px; 
        }

        .filter-group { 
            margin-bottom: 10px; 
            box-sizing: border-box;
        } 
        
        .filter-group.year-filter, .filter-group.agency-filter {
            width: 48%; 
        }
        .filter-group.circumstance-filter, .filter-group.percentage-change-display { 
            width: 100%;
            margin-top: 10px; 
        }
        .filter-group.percentage-change-display {
            margin-top: 15px; 
        }

        .filter-group label.group-label { 
            display: block; margin-bottom: 5px; 
            font-weight: bold;
            font-size: 0.95em; 
            color: var(--legend-label-text); 
        }
        .filter-group select, .filter-group .checkbox-group {
            width: 100%; padding: 6px; 
            border: 1px solid var(--input-border);
            border-radius: 4px; font-size: 0.9em; 
            box-sizing: border-box; background-color: var(--input-bg); color: var(--text-color);
        }
        .checkbox-group { 
            max-height: 150px; 
            overflow-y: auto; 
            background-color: var(--input-bg); 
            padding: 8px; 
        }
        .checkbox-group div { margin-bottom: 3px; display: flex; align-items: center;}
        .checkbox-group input[type="checkbox"] { margin-right: 5px; }
        .checkbox-group label { font-weight: normal; font-size: 0.85em; color: var(--legend-label-text);}
        
        #percentageChangeText { 
            text-align: center; 
            font-weight: bold; 
            padding: 10px; 
            background-color: var(--input-bg); 
            border: 1px solid var(--input-border); 
            border-radius: 4px;
            font-size: 1.8em; 
        }

        .map-container { flex-grow: 1; min-height: 300px;  }
        #map { height: 100%; width: 100%; background-color: var(--map-placeholder-bg); } 
        
        .charts-area { 
            display: flex; 
            flex-wrap: wrap; 
            flex: 0 1 auto; 
            background-color: var(--content-bg); 
            border-top: 1px solid var(--legend-border); 
        }
        .chart-box { 
            width: 33.333%; 
            padding: 20px; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            box-sizing: border-box; 
        }
        .chart-box:nth-child(1), .chart-box:nth-child(2) { 
            border-right: 1px solid var(--legend-border); 
        }

        .chart-box h4 { text-align: center; margin-top: 0; margin-bottom: 15px; font-size: 1.1em; color: var(--chart-title-text); }
        .chart-canvas-container { flex-grow: 1; position: relative; min-height: 250px; } 

        .footer {
            padding: 10px 15px; text-align: center; 
            font-size: 0.8em; color: var(--footer-text); 
            background-color: var(--footer-bg);
            border-top: 1px solid var(--header-border); flex-shrink: 0;
        }
        .footer p { margin: 5px 0; } 
        .footer a { color: var(--footer-link); text-decoration: none; } 
        .footer a:hover { text-decoration: underline; }

        /* --- PLUGIN & MODAL STYLES --- */
        .leaflet-tooltip {
            background-color: var(--tooltip-bg); 
            color: var(--tooltip-text);
            border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            border-radius: 4px; padding: 10px 15px; 
            font-size: 1em; 
        }
        .leaflet-tooltip p { margin: 5px 0; } 
        .leaflet-tooltip b { color: var(--tooltip-text); font-weight: bold; } 

        .leaflet-control-layers { background: var(--content-bg); border: 1px solid var(--legend-border); }
        .leaflet-control-layers-selector, .leaflet-control-layers label, .leaflet-control-layers label span { color: var(--text-color); }

        .modal-overlay {
            display: none; position: fixed;
            z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5); 
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fefefe; padding: 20px;
            border: 1px solid #888; border-radius: 8px;
            width: 90%; max-width: 600px; position: relative;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
        }
        .modal-close {
            color: #aaa; position: absolute; top: 10px; right: 20px;
            font-size: 28px; font-weight: bold; line-height: 1;
            cursor: pointer;
        }
        .modal-close:hover, .modal-close:focus { color: black; text-decoration: none; }
        .modal-content h2 { margin-top: 0; color: #333; }
        .modal-content p { line-height: 1.6; color: #555; }
        
        /* --- RESPONSIVE STYLES --- */
        @media (max-width: 992px) { 
            .main-content-area { flex-direction: column; flex: 1 1 auto; }
            .legend-container { width: 100%; max-width: none; border-right: none; border-bottom: 2px solid var(--legend-border); max-height: 45vh; flex-shrink:0;} 
            .map-container { 
                height: 50vh; 
                flex-grow: 1; 
                flex-shrink: 0; 
            } 
            .chart-box { 
                width: 50%;
                border-bottom: 1px solid var(--legend-border);
            }
            .chart-box:nth-child(even) { border-right: none; }
            .chart-box:nth-child(3){
                border-right: none;
            }
        }
        
        @media (max-width: 768px) {
            .header { 
                flex-direction: row; 
                justify-content: space-around; 
                padding: 8px 10px;
            }
            .header-logo-main img, .header-logo-secondary img { max-height: 35px; } 

            .count-banner { font-size: 1.3em; padding: 6px 10px;} 
            .ranking-banner { font-size: 0.9em; }

            .charts-area { flex-direction: column; } 
            .chart-box { 
                width: 100%; 
                padding: 15px; 
                border-right: none !important; 
            }
            .chart-box:not(:last-child) { 
                border-bottom: 1px solid var(--legend-border); 
            }
            .chart-box:last-child {
                border-bottom: none;
            }
            
            .legend-container { padding: 10px; max-height: 40vh; } 
            .filter-columns-wrapper { flex-direction: column; flex-grow: 0; }
            .filter-group.year-filter, .filter-group.agency-filter, .filter-group.circumstance-filter, .filter-group.percentage-change-display { 
                width: 100%; 
                margin-bottom: 8px; 
            } 

            .filter-group select, .checkbox-group div {
                padding: 10px;
                min-height: 44px;
            }
            .filter-group select { font-size: 1em; }
            .checkbox-group { 
                max-height: 120px;
                padding: 6px;
            }
            .checkbox-group label { font-size: 0.9em; }
            #percentageChangeText { 
                font-size: 1.4em;
                padding: 12px;
            }

            .chart-box h4 { font-size: 1em; }
            .chart-canvas-container { min-height: 280px;} 

            .footer { font-size: 0.75em; padding: 8px 10px;}
            
            .modal-content {
                width: 95%;
                max-height: 90vh; 
                overflow-y: auto;
            }
        }

        @media (max-width: 480px) {
            .count-banner {
                font-size: 1.1em;
            }
            .ranking-banner {
                font-size: 0.8em;
            }
            .header-logo-main img, .header-logo-secondary img {
                max-height: 28px;
            }
            .chart-box h4 {
                font-size: 0.95em;
            }
            .chart-canvas-container {
                min-height: 250px; 
            }
            .footer {
                font-size: 0.7em;
            }
            #percentageChangeText {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-logo-main">
            <img id="trackingLogoImg" src="https://placehold.co/400x60/d9534f/ffffff?text=Tracking+Homicides" alt="Tracking Jackson's Homicides Logo">
        </div>
        <div class="header-logo-secondary">
            <img id="wlbtLogoImg" src="https://placehold.co/150x60/333333/ffffff?text=WLBT" alt="WLBT Logo">
        </div>
    </div>

    <div class="count-banner" id="homicideCountBanner">2025 COUNT: ...</div>
    <div class="ranking-banner" id="rankingBanner">
        <div class="ticker-wrap" id="tickerWrap">
            <!-- Ticker content will be injected by JavaScript -->
        </div>
    </div>

    <div class="main-content-area">
        <div class="legend-container">
            <div class="filter-columns-wrapper">
                <div class="filter-group year-filter">
                    <label class="group-label" for="yearFilter">Year:</label>
                    <div id="yearFilter" class="checkbox-group"></div>
                </div>
                <div class="filter-group agency-filter">
                    <label class="group-label" for="agencyFilter">Agency:</label>
                    <div id="agencyFilter" class="checkbox-group"></div>
                </div>
                <div class="filter-group circumstance-filter">
                    <label class="group-label" for="circumstanceFilter">Circumstance:</label>
                    <select id="circumstanceFilter"></select>
                </div>
                 <div class="filter-group percentage-change-display">
                    <label class="group-label">YTD Comparison:</label>
                    <div id="percentageChangeText"></div>
                </div>
            </div> 
            </div>
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <div class="charts-area" id="charts-row-1">
        <div class="chart-box">
            <h4>Homicide Trends Comparison</h4>
            <div class="chart-canvas-container">
                <canvas id="homicideTrendsChart"></canvas>
            </div>
        </div>
        <div class="chart-box">
            <h4>Homicides by Year</h4>
            <div class="chart-canvas-container">
                <canvas id="homicidesByYearChart"></canvas>
            </div>
        </div>
        <div class="chart-box">
            <h4>Victims by Age Group</h4>
            <div class="chart-canvas-container">
                <canvas id="victimsByAgeChart"></canvas>
            </div>
        </div>
    </div>

    <div class="footer">
        <p><a href="#" id="openAboutModal">About the Data</a></p>
        <p>Data Sources: JPD, DPS, Hinds County, JSUPD | Design/Layout: C.J. LeMaster</p>
    </div>

    <div id="aboutDataModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" id="closeAboutModal">×</span>
            <h2>About the Data</h2>
            <p>Homicides differ from murders because murder implies intent to kill, whereas a homicide is simply the death of one person by another. The two terms are not interchangeable. Because some homicides are considered justifiable, for example, the number of murders in a given year will always be lower than homicides.</p>
            <p>WLBT tracks homicides with the same methodology the Jackson Police Department and many other law enforcement agencies use. Justifiable homicides, including officer-involved deaths, are counted in the numbers. Vehicular homicides, which historically have only been counted by JPD in rare occasions, are not counted unless the agency does so.</p>
            <p>3 On Your Side obtains this information through official releases from JPD and confirmation of killings from departmental sources and the county coroner to reporters. Additionally, when other agencies work as the lead investigating agency on killings, those are also counted in WLBT’s numbers if the killings happen in Jackson.</p>
            <p>For example, in 2024, Capitol Police worked seven homicides. The year before that, Jackson State’s police department handled one. Because we count all killings that happen in the city, our numbers will differ from individual agencies because they only count cases they actually work.</p>
            <p>Some numbers may also fluctuate over time as we learn of additional cases that were not previously reported to us through releases or official confirmation. In October 2023, WLBT uncovered evidence that JPD had failed to disclose cases associated with 24 homicide victims to the public. After that discovery, 3 On Your Side updated its numbers to reflect the department’s count. Following that revelation, WLBT regularly asks JPD for updates on cases to help ensure the department doesn’t let future victims fall through the cracks. </p>
            <p>Finally, you may notice information missing in some of these cases: ages, race, gender or an exact location. That lack of information reflects what the individual law enforcement agency fails to provide to us. Despite those gaps, we do our best to make sure we have as much information as possible to help police solve these cases.</p>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const HOMICIDE_DATA_API_URL = './data/homicide.json'; 
        const CITY_COMPARISON_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyiORmxzjhdAokYzM0NhcTjAk1e3hJp81B5OCG03XcPnUaSVrCRiwIXmah2iPSHFaaWbSoKKwFA1Uc/pub?gid=0&single=true&output=csv'; 
        const JACKSON_POPULATION = 143709; 

        const CURRENT_YEAR = 2025; 
        const PREVIOUS_YEAR = CURRENT_YEAR - 1;
        const START_YEAR_DATA = 2016;
        const MAP_CENTER = [32.2988, -90.1848]; 
        const MAP_ZOOM = 12; 

        const JACKSON_CITY_LIMITS_GEOJSON_URL = 'https://dl.dropbox.com/scl/fi/9ct9dki2dsg68iyr7gley/City-Boundaries.geojson?rlkey=vjrtpish5tixdeygp1ja5h7fq&st=fyrqfq4x&dl=1'; 
        const CCID_GEOJSON_URL = 'https://dl.dropbox.com/scl/fi/wva5rzfwwbr8shiz4fkjj/Current-CCID-2024.geojson?rlkey=tvheyfxe94colnxphaan0bsar&st=sqqs09s6&dl=1'; 
        
        const AGENCY_CATEGORIES = {
            CAPITOL_POLICE: 'Capitol Police',
            JPD: 'JPD',
            OTHER: 'Other Agencies' 
        };
        
        const agencyColors = {
            [AGENCY_CATEGORIES.JPD]: 'rgba(0, 123, 255, 0.7)',
            [AGENCY_CATEGORIES.CAPITOL_POLICE]: 'rgba(255, 193, 7, 0.7)',
            [AGENCY_CATEGORIES.OTHER]: 'rgba(40, 167, 69, 0.7)'
        };

        // --- Global State ---
        let allHomicideData = [];
        let cityComparisonData = []; 
        let filteredHomicideDataForMap = []; 
        let map;
        let markersLayer = L.layerGroup();
        let heatLayer; 
        let cityLimitsLayer; 
        let ccidLayer;       
        let overlayLayersControl; 
        let currentMapTileLayer; 

        let homicidesByYearChartInstance;
        let homicideTrendsChartInstance;
        let victimsByAgeChartInstance; 

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            initMap(); 
            setupModal();

            document.getElementById('homicideCountBanner').innerText = `${CURRENT_YEAR} COUNT: Loading...`;
            document.querySelector('.ranking-banner .ticker-wrap').innerHTML = '<div class="ticker-item">City Ranking: Loading...</div>';
            document.getElementById('percentageChangeText').innerText = 'Calculating...';

            try {
                const [homicideDataResult, cityDataResult] = await Promise.all([
                    fetchDataAndProcess(HOMICIDE_DATA_API_URL, true), 
                    fetchDataAndProcess(CITY_COMPARISON_CSV_URL, false) 
                ]);

                allHomicideData = homicideDataResult;
                cityComparisonData = cityDataResult;

                logProcessedDataSummary(allHomicideData, "Homicide Data");
                if (cityComparisonData && cityComparisonData.length > 0) {
                    logProcessedDataSummary(cityComparisonData, "City Comparison Data");
                } else if (CITY_COMPARISON_CSV_URL !== 'YOUR_CITY_COMPARISON_CSV_URL_HERE' && CITY_COMPARISON_CSV_URL.trim() !== '') {
                     console.warn("City comparison data is empty or failed to load properly.");
                }

                populateFiltersForMap(); 
                updateDashboard(); 
                if (map) { 
                    map.invalidateSize();
                }
            } catch (error) {
                console.error("Fatal Error initializing dashboard:", error);
                document.getElementById('homicideCountBanner').innerText = 'Error loading data.';
                document.querySelector('.ranking-banner .ticker-wrap').innerHTML = '<div class="ticker-item">City Ranking: Error</div>';
                document.getElementById('percentageChangeText').innerText = 'Error calculating.';
                displayErrorInCharts("Failed to load data.");
            }
        });

        // --- Modal Functionality ---
        function setupModal() {
            const modal = document.getElementById("aboutDataModal");
            const openBtn = document.getElementById("openAboutModal");
            const closeBtn = document.getElementById("closeAboutModal");

            openBtn.onclick = function(e) {
                e.preventDefault(); 
                modal.style.display = "flex";
            }
            closeBtn.onclick = function() {
                modal.style.display = "none";
            }
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
            window.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    modal.style.display = 'none'
                }
            });
        }
        
        // --- Map & Data Fetching ---
        function updateMapTiles() { 
            if (!map) return;
            if (currentMapTileLayer) {
                map.removeLayer(currentMapTileLayer);
            }
            currentMapTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            });
            currentMapTileLayer.addTo(map);
        }
        
        async function fetchDataAndProcess(url, isMainHomicideData = false) { 
            let rawData;
            const dataType = isMainHomicideData ? 'main homicide data' : 'city comparison data';
            const placeholderUrlCity = 'YOUR_CITY_COMPARISON_CSV_URL_HERE';
            let usePlaceholder = false;

            if (!isMainHomicideData && (url === placeholderUrlCity || !url)) { 
                usePlaceholder = true;
            }
            
            if (usePlaceholder) {
                console.warn(`URL for ${dataType} is placeholder or not provided. Using local placeholder data.`);
                rawData = isMainHomicideData ? getPlaceholderData() : getPlaceholderCityData();
            } else {
                const fetchableUrl = url; 
                try {
                    const response = await fetch(fetchableUrl);
                    if (!response.ok) {
                        const errorText = await response.text().catch(() => `Could not read error response text. Status: ${response.status}`);
                        throw new Error(`Network response was not ok for ${dataType}: ${response.status} ${response.statusText}.`);
                    }

                    if (isMainHomicideData) { 
                         rawData = await response.json();
                    } else { 
                        const csvText = await response.text(); 
                        rawData = csvToJSON(csvText);
                    }
                } catch (error) {
                    console.error(`Failed to fetch or parse data for ${dataType}. URL: ${fetchableUrl}`, error);
                    rawData = isMainHomicideData ? getPlaceholderData() : getPlaceholderCityData();
                }
            }
            
            if (isMainHomicideData) {
                if (!rawData || !rawData.headers || !rawData.entries || rawData.entries.length === 0) return [];
                const headers = rawData.headers.map(h => String(h).trim().toLowerCase());
                const getHeaderIndex = (possibleNames) => {
                    for (let name of possibleNames) {
                        const index = headers.indexOf(name.toLowerCase());
                        if (index !== -1) return index;
                    }
                    return -1;
                };

                const victimIdx = getHeaderIndex(['Victim']);
                const ageIdx = getHeaderIndex(['Age']);
                const raceIdx = getHeaderIndex(['Race']);
                const sexIdx = getHeaderIndex(['Sex']);
                const circumstanceIdx = getHeaderIndex(['Circumstance']);
                const dateIdx = getHeaderIndex(['Date']); 
                const addressIdx = getHeaderIndex(['Address', 'Location']); 
                const agencyIdx = getHeaderIndex(['Investigating Agency', 'Agency']);
                const precinctIdx = getHeaderIndex(['Precinct']);
                const latitudeIdx = getHeaderIndex(['Latitude', 'Lat']);
                const longitudeIdx = getHeaderIndex(['Longitude', 'Lon', 'Long']);

                return rawData.entries.map(entry => {
                    const dateStr = entry[dateIdx] ? String(entry[dateIdx]).trim() : '';
                    let dateObj;
                    if (dateStr.includes('-')) {
                        dateObj = new Date(dateStr + "T00:00:00");
                    } else if (dateStr.includes('/')) {
                        const parts = dateStr.split('/');
                        if (parts.length === 3) dateObj = new Date(parts[2], parseInt(parts[0]) - 1, parts[1]);
                    }
                    
                    const lat = parseFloat(entry[latitudeIdx]);
                    const lon = parseFloat(entry[longitudeIdx]);

                    if (!dateObj || isNaN(dateObj.getTime()) || isNaN(lat) || isNaN(lon)) return null;

                    return {
                        Victim: entry[victimIdx] || 'N/A', 
                        Age: entry[ageIdx] ? parseInt(entry[ageIdx]) : null, 
                        Race: entry[raceIdx] || 'N/A', 
                        Sex: entry[sexIdx] || 'N/A',
                        Circumstance: entry[circumstanceIdx] || 'N/A', 
                        Date: dateObj.toISOString().split('T')[0],
                        DisplayDate: dateStr, 
                        Address: entry[addressIdx] || 'N/A', 
                        'Investigating Agency': entry[agencyIdx] || 'N/A', 
                        Precinct: entry[precinctIdx] ? String(entry[precinctIdx]).trim() : 'N/A',
                        Latitude: lat, 
                        Longitude: lon,
                        Year: dateObj.getFullYear(), 
                    };
                }).filter(Boolean);
            } else { 
                if (!rawData || rawData.length === 0) return [];
                return rawData.map(d => ({
                    City: d.City ? String(d.City).trim() : null,
                    Homicides: d.Homicides ? parseInt(String(d.Homicides).trim()) : null,
                    Population: d.Population ? parseInt(String(d.Population).trim()) : null,
                })).filter(d => d.City && d.Homicides >= 0 && d.Population > 0);
            }
        }
        
        function logProcessedDataSummary(data, dataType = "Data") {
            if (!data || data.length === 0) { console.log(`No ${dataType} to summarize.`); return; }
            if (dataType === "Homicide Data") {
                const countsByYear = data.reduce((acc, d) => {
                    acc[d.Year] = (acc[d.Year] || 0) + 1;
                    return acc;
                }, {});
                console.log("Counts per year from Homicide Data:", countsByYear);
            } else {
                 console.log(`Total cities for comparison loaded: ${data.length}`);
            }
        }

        function csvToJSON(csv) { 
            const lines = csv.replace(/\r/g, '').split('\n');
            const result = [];
            if (lines.length < 1) return result;
            const headers = lines[0].split(',').map(h => h.trim());
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue; 
                const obj = {};
                const values = lines[i].split(',');
                headers.forEach((header, index) => {
                    obj[header] = values[index] ? values[index].trim() : '';
                });
                result.push(obj);
            }
            return result;
        }

        function getPlaceholderData() { 
            return {
                headers: ["Date", "Location", "Victim", "Agency", "Precinct", "Age", "Sex", "Race", "Circumstance", "Latitude", "Longitude"],
                entries: [
                    [`01/15/${CURRENT_YEAR}`, "123 Main St, Jackson, MS", 'John Doe', "JPD", "1", 30, "Male", "Black", "Argument", 32.3010, -90.1850],
                    [`02/20/${CURRENT_YEAR}`, "456 Oak Ave, Jackson, MS", 'Jane Smith', "Capitol Police", "2", 25, "Female", "White", "Robbery", 32.2950, -90.1900]
                ]
            };
        }
        function getPlaceholderCityData() { 
            return [
                { City: 'St. Louis, MO', Homicides: 190, Population: 286578 },
                { City: 'Baltimore, MD', Homicides: 330, Population: 569931 },
                { City: 'New Orleans, LA', Homicides: 260, Population: 369749 },
                { City: 'Detroit, MI', Homicides: 300, Population: 620376 },
                { City: 'Memphis, TN', Homicides: 340, Population: 621056 },
            ];
        }

        function initMap() {
            map = L.map('map').setView(MAP_CENTER, MAP_ZOOM);
            updateMapTiles(); 
            markersLayer.addTo(map); 
            heatLayer = L.heatLayer([], { radius: 25 });
            loadBoundaryLayers();
        }
        
        // --- UI & Filter Logic ---
        function populateFiltersForMap() { 
            const allYearsFromData = [...new Set(allHomicideData.map(d => d.Year))].sort((a, b) => b - a);
            const yearsForFilter = allYearsFromData.filter(y => y >= START_YEAR_DATA && y <= CURRENT_YEAR);
            const agenciesToShow = [...new Set(allHomicideData.map(d => d['Investigating Agency']))].filter(Boolean).sort();
            const circumstancesToShow = [...new Set(allHomicideData.map(d => d.Circumstance))].filter(Boolean).sort();

            populateCheckboxFilter('yearFilter', yearsForFilter, [CURRENT_YEAR], updateDashboard);
            populateCheckboxFilter('agencyFilter', agenciesToShow, agenciesToShow, updateDashboard);     
            
            const circumstanceSelect = document.getElementById('circumstanceFilter');
            circumstanceSelect.innerHTML = '<option value="">All Circumstances</option>';
            circumstancesToShow.forEach(c => circumstanceSelect.add(new Option(c, c)));
            circumstanceSelect.addEventListener('change', updateDashboard);
        }
        
        function populateCheckboxFilter(elementId, values, defaultSelected = [], changeCallback) {
            const container = document.getElementById(elementId);
            container.innerHTML = ''; 
            values.forEach(val => {
                const div = document.createElement('div');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `${elementId}_${String(val).replace(/\s+/g, '_')}`;
                checkbox.value = val;
                checkbox.checked = defaultSelected.includes(val);
                checkbox.addEventListener('change', changeCallback);
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = val;
                div.append(checkbox, label);
                container.appendChild(div);
            });
        }

        // --- Core Update Functions ---
        function updateCurrentYearHomicideCount() {
            const currentYearHomicides = allHomicideData.filter(d => d.Year === CURRENT_YEAR).length;
            document.getElementById('homicideCountBanner').innerText = `${CURRENT_YEAR} COUNT: ${currentYearHomicides}`;
        }
        
        function updateRankingBanner() {
            const banner = document.getElementById('rankingBanner');
            const tickerWrap = document.getElementById('tickerWrap');
            if (!banner || !tickerWrap) return;

            const jacksonHomicidesThisYear = allHomicideData.filter(d => d.Year === CURRENT_YEAR).length;
            const jacksonRate = (jacksonHomicidesThisYear / JACKSON_POPULATION) * 100000;

            if (!cityComparisonData || cityComparisonData.length === 0) {
                tickerWrap.innerHTML = `<div class="ticker-item">City comparison data not available.</div>`;
                return;
            }

            const citiesWithRates = cityComparisonData.map(city => ({
                name: city.City,
                rate: (city.Homicides / city.Population) * 100000
            }));

            citiesWithRates.push({ name: 'Jackson, MS', rate: jacksonRate });
            citiesWithRates.sort((a, b) => b.rate - a.rate);

            const jacksonRank = citiesWithRates.findIndex(c => c.name === 'Jackson, MS') + 1;
            
            let bannerColorVar = '--rank-banner-error-bg'; 
            if (jacksonRank === 1) bannerColorVar = '--rank-banner-rank1-bg';
            else if (jacksonRank >= 2 && jacksonRank <= 5) bannerColorVar = '--rank-banner-rank2to5-bg';
            else if (jacksonRank > 5) bannerColorVar = '--rank-banner-ranklow-bg';
            banner.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue(bannerColorVar).trim();

            const tickerItems = ["Top 5 Major U.S. Cities by Homicide Rate"];
            
            const top5 = citiesWithRates.slice(0, 5);
            top5.forEach((c, i) => {
                tickerItems.push(`${i + 1}. ${c.name} <span>(${c.rate.toFixed(1)})</span>`);
            });

            const isJacksonInTop5 = top5.some(c => c.name === 'Jackson, MS');
            if (!isJacksonInTop5 && jacksonRank > 0) {
                 tickerItems.push(`... | ${jacksonRank}. Jackson, MS <span>(${jacksonRate.toFixed(1)})</span>`);
            }
            
            const tickerText = tickerItems.join(' &nbsp; | &nbsp; ');
            
            tickerWrap.innerHTML = `<div class="ticker-item">${tickerText}</div><div class="ticker-item">${tickerText}</div>`;
        }

        function updateMapDisplay() { 
            const selectedYears = Array.from(document.querySelectorAll('#yearFilter input:checked')).map(cb => parseInt(cb.value));
            const selectedAgencies = Array.from(document.querySelectorAll('#agencyFilter input:checked')).map(cb => cb.value);
            const selectedCircumstance = document.getElementById('circumstanceFilter').value;
            
            filteredHomicideDataForMap = allHomicideData.filter(d => 
                selectedYears.includes(d.Year) &&
                selectedAgencies.includes(d['Investigating Agency']) &&
                (!selectedCircumstance || d.Circumstance === selectedCircumstance)
            );

            markersLayer.clearLayers();
            const heatPoints = [];
            const visibleMarkers = []; 

            filteredHomicideDataForMap.forEach(d => {
                const latLng = [d.Latitude, d.Longitude];
                heatPoints.push(latLng);

                const marker = L.circleMarker(latLng, {
                    radius: 6, fillColor: "#d9534f", color: "#c82333", weight: 1, opacity: 1, fillOpacity: 0.8
                });
                marker.bindTooltip(`<p><b>Victim:</b> ${d.Victim}</p><p><b>Date:</b> ${d.DisplayDate}</p><p><b>Address:</b> ${d.Address}</p>`, { sticky: true });
                markersLayer.addLayer(marker);
                visibleMarkers.push(marker); 
            });

            heatLayer.setLatLngs(heatPoints);

            if (visibleMarkers.length > 0 && map.hasLayer(markersLayer)) {
                map.fitBounds(L.featureGroup(visibleMarkers).getBounds().pad(0.1)); 
            }
        }
        
        // --- Chart Generation ---
        function getChartOptions(tooltipCallback) { 
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-axis-text').trim();
            const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-grid-color').trim();

            return {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { stacked: true, ticks: { color: textColor }, grid: { color: gridColor } },
                    y: { stacked: true, beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } }
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { 
                        mode: 'index', intersect: false,
                        callbacks: { label: tooltipCallback }
                    }
                }
            };
        }

        function getTrendChartOptions() { 
             const textColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-axis-text').trim();
            const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-grid-color').trim();
            const titleColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-title-text').trim();

            return {
                 responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            title: {display: true, text: 'Cumulative Homicides', color: titleColor},
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        x: {
                            type: 'time',
                            time: { unit: 'month', parser: 'yyyy-MM-dd', tooltipFormat: 'MMM dd', displayFormats: { month: 'MMM' } },
                            title: {display: true, text: 'Month (Displayed on a Common Year for Comparison)', color: titleColor},
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    },
                    plugins: { 
                        legend: { position: 'top' }, 
                        tooltip: { mode: 'index', intersect: false } 
                    }
            };
        }
        
        function updateHomicidesByYearChart() { 
            const tooltipCallback = (context) => {
                const label = context.dataset.label || '';
                const value = context.raw;
                const total = context.chart.data.datasets.reduce((sum, ds) => sum + ds.data[context.dataIndex], 0);
                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                return `${label}: ${value} (${percentage}%)`;
            };
            const chartOptions = getChartOptions(tooltipCallback); 
            
            const ctx = document.getElementById('homicidesByYearChart').getContext('2d');
            const yearsToDisplay = [...new Set(allHomicideData.map(d => d.Year))].filter(y => y >= START_YEAR_DATA).sort();
            
            const dataByAgencyCategory = yearsToDisplay.reduce((acc, year) => {
                acc[year] = { [AGENCY_CATEGORIES.JPD]: 0, [AGENCY_CATEGORIES.CAPITOL_POLICE]: 0, [AGENCY_CATEGORIES.OTHER]: 0 };
                return acc;
            }, {});

            allHomicideData.forEach(d => {
                if (dataByAgencyCategory[d.Year]) {
                    const agency = d['Investigating Agency'];
                    if (agency === AGENCY_CATEGORIES.JPD) dataByAgencyCategory[d.Year][AGENCY_CATEGORIES.JPD]++;
                    else if (agency === AGENCY_CATEGORIES.CAPITOL_POLICE) dataByAgencyCategory[d.Year][AGENCY_CATEGORIES.CAPITOL_POLICE]++;
                    else dataByAgencyCategory[d.Year][AGENCY_CATEGORIES.OTHER]++;
                }
            });

            const datasets = Object.keys(AGENCY_CATEGORIES).map(key => {
                const category = AGENCY_CATEGORIES[key];
                return {
                    label: category,
                    data: yearsToDisplay.map(year => dataByAgencyCategory[year][category]),
                    backgroundColor: agencyColors[category],
                };
            });

            if (homicidesByYearChartInstance) homicidesByYearChartInstance.destroy();
            homicidesByYearChartInstance = new Chart(ctx, { type: 'bar', data: { labels: yearsToDisplay, datasets }, options: chartOptions });
        }

        function updateHomicideTrendsChart() {
            const chartOptions = getTrendChartOptions(); 

            const getRunningTotalData = (yearToFilter, dataSet) => {
                const yearData = dataSet.filter(d => d.Year === yearToFilter && d.Date)
                    .sort((a, b) => new Date(a.Date) - new Date(b.Date));

                const chartDataPoints = [];
                const commonAxisYear = 2000; 
                let cumulativeCount = 0;
                let homicideDataIndex = 0;
                
                let loopEndDate = (yearToFilter === CURRENT_YEAR) ? new Date() : new Date(yearToFilter, 11, 31);
                
                for (let dLoop = new Date(yearToFilter, 0, 1); dLoop <= loopEndDate; dLoop.setDate(dLoop.getDate() + 1)) {
                    const currentLoopDayFormatted = dLoop.toISOString().split('T')[0];
                    
                    while(homicideDataIndex < yearData.length && yearData[homicideDataIndex].Date <= currentLoopDayFormatted) {
                        cumulativeCount++;
                        homicideDataIndex++;
                    }
                    
                    chartDataPoints.push({
                        x: `${commonAxisYear}-${(dLoop.getMonth() + 1).toString().padStart(2, '0')}-${dLoop.getDate().toString().padStart(2, '0')}`,
                        y: cumulativeCount 
                    });
                }
                
                if (chartDataPoints.length === 0 || chartDataPoints[0].x !== `${commonAxisYear}-01-01`) {
                    chartDataPoints.unshift({ x: `${commonAxisYear}-01-01`, y: 0 });
                }

                return chartDataPoints;
            };

            const dataForCurrentYear = getRunningTotalData(CURRENT_YEAR, allHomicideData);
            const dataForPreviousYear = getRunningTotalData(PREVIOUS_YEAR, allHomicideData);

            const ctx = document.getElementById('homicideTrendsChart').getContext('2d');
            if (homicideTrendsChartInstance) {
                homicideTrendsChartInstance.destroy();
            }
            homicideTrendsChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        { label: String(CURRENT_YEAR), data: dataForCurrentYear, borderColor: '#dc3545', tension: 0.1, fill: false, pointRadius: 2, pointHoverRadius: 4 },
                        { label: String(PREVIOUS_YEAR), data: dataForPreviousYear, borderColor: '#007bff', tension: 0.1, fill: false, pointRadius: 2, pointHoverRadius: 4 }
                    ]
                },
                options: chartOptions 
            });
        }

        function updateDemographicCharts() {
            const tooltipCallback = (context) => {
                let label = context.label || '';
                let value = context.raw;
                const total = context.chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                return `${label}: ${value} (${percentage}%)`;
            };
            const chartOptions = getChartOptions(tooltipCallback);
            chartOptions.plugins.legend.display = false;

            const ageGroups = { '0-17': 0, '18-29': 0, '30-49': 0, '50+': 0, 'Unknown': 0 };
            filteredHomicideDataForMap.forEach(d => {
                const age = d.Age;
                // BUG FIX: Added isNaN(age) check to correctly categorize unknown ages.
                if (age === null || isNaN(age)) {
                    ageGroups['Unknown']++;
                } else if (age <= 17) {
                    ageGroups['0-17']++;
                } else if (age <= 29) {
                    ageGroups['18-29']++;
                } else if (age <= 49) {
                    ageGroups['30-49']++;
                } else {
                    ageGroups['50+']++;
                }
            });

            const ageCtx = document.getElementById('victimsByAgeChart').getContext('2d');
            if (victimsByAgeChartInstance) victimsByAgeChartInstance.destroy();
            victimsByAgeChartInstance = new Chart(ageCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ageGroups),
                    datasets: [{
                        label: 'Victims by Age Group',
                        data: Object.values(ageGroups),
                        backgroundColor: '#5bc0de'
                    }]
                },
                options: chartOptions
            });
        }
        
        function updatePercentageChangeDisplay() {
            const percentageChangeDiv = document.getElementById('percentageChangeText');
            if (!percentageChangeDiv || !allHomicideData || allHomicideData.length === 0) {
                percentageChangeDiv.innerText = 'Data N/A';
                percentageChangeDiv.style.color = getComputedStyle(document.documentElement).getPropertyValue('--percentage-neutral-color');
                return;
            }

            const today = new Date();
            const dayOfYear = (Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()) - Date.UTC(today.getFullYear(), 0, 0)) / 24 / 60 / 60 / 1000;

            const getCountUpToDay = (year, day) => {
                return allHomicideData.filter(d => {
                    if (d.Year !== year || !d.Date) return false;
                    const itemDate = new Date(d.Date + 'T00:00:00'); // Ensure consistent time
                    const itemDayOfYear = (Date.UTC(itemDate.getFullYear(), itemDate.getMonth(), itemDate.getDate()) - Date.UTC(itemDate.getFullYear(), 0, 0)) / 24 / 60 / 60 / 1000;
                    return itemDayOfYear <= day;
                }).length;
            };

            const currentYearCountToDate = getCountUpToDay(CURRENT_YEAR, dayOfYear);
            const previousYearCountToDate = getCountUpToDay(PREVIOUS_YEAR, dayOfYear);
            
            let percentageChangeText = "N/A";
            let textColorVar = '--percentage-neutral-color';

            if (previousYearCountToDate > 0) {
                const change = ((currentYearCountToDate - previousYearCountToDate) / previousYearCountToDate) * 100;
                if (change > 0) {
                    percentageChangeText = `+${change.toFixed(0)}%`;
                    textColorVar = '--percentage-increase-color';
                } else if (change < 0) {
                    percentageChangeText = `${change.toFixed(0)}%`;
                    textColorVar = '--percentage-decrease-color';
                } else {
                    percentageChangeText = "0%";
                }
            } else if (currentYearCountToDate > 0) {
                percentageChangeText = `+${currentYearCountToDate} (from 0)`; 
                textColorVar = '--percentage-increase-color';
            } else { 
                 percentageChangeText = "0% (YTD)";
            }
            percentageChangeDiv.innerText = percentageChangeText;
            percentageChangeDiv.style.color = getComputedStyle(document.documentElement).getPropertyValue(textColorVar).trim();
        }

        function updateDashboard() {
            updateCurrentYearHomicideCount();
            updateRankingBanner();
            updatePercentageChangeDisplay();
            updateMapDisplay();
            updateHomicidesByYearChart(); 
            updateHomicideTrendsChart();
            updateDemographicCharts(); 
        }

        // --- Dummy/Placeholder Functions ---
        function loadBoundaryLayers(){ /* Placeholder */ };
        function displayErrorInCharts(errorMessage) {
            const chartIds = ['homicidesByYearChart', 'homicideTrendsChart', 'victimsByAgeChart'];
            chartIds.forEach(id => {
                const canvas = document.getElementById(id);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    if (window[id + 'Instance']) { window[id + 'Instance'].destroy(); }
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.font = "16px Arial";
                    ctx.fillStyle = "red";
                    ctx.textAlign = "center";
                    ctx.fillText(errorMessage, canvas.width / 2, canvas.height / 2);
                }
            });
        }
    </script>
</body>
</html>

Here are the fixes.

1.  **Map Overlay Fix:** I added a high `z-index` to the `.map-overlay` class so it floats *above* the Leaflet map layers.
2.  **Ticker Speed:** I slowed the animation duration from `30s` to `90s` for easier reading.
3.  **Logos:** I restructured the `<header>` to include specific spots for your **"Jackson Homicides"** logo (left) and **"WLBT Investigates"** logo (right).

You can copy and overwrite your `dashboard-dark.html` with this updated version.

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jackson Homicide Tracker | HUD Edition</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* HUD Color Palette */
            --bg-dark: #0b0e14;
            --bg-panel: #151a25;
            --bg-header: #1e2532;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --accent-red: #ef4444;    
            --accent-blue: #3b82f6;   
            --accent-cyan: #06b6d4;   
            --accent-green: #10b981;
            --border: #2d3748;
            
            --percentage-increase: #ef4444;
            --percentage-decrease: #10b981;
            --percentage-neutral: #94a3b8;

            --glow-red: 0 0 10px rgba(239, 68, 68, 0.4);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- UPDATED HEADER LAYOUT --- */
        header {
            background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            padding: 5px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px; /* Slightly taller for logos */
            gap: 20px;
        }

        /* Logo Containers */
        .logo-container {
            display: flex;
            align-items: center;
            height: 100%;
        }
        
        .logo-img {
            max-height: 50px; /* Limits logo height */
            width: auto;
            display: block;
        }

        /* Fallback text if no logo image is present */
        .logo-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: white;
            font-weight: 700;
        }

        /* --- UPDATED TICKER (SLOWER) --- */
        .ranking-banner {
            flex-grow: 1;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 4px;
            height: 35px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            color: var(--accent-cyan);
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
        }

        .ticker-wrap {
            white-space: nowrap;
            /* CHANGED: 30s -> 90s for slower scroll */
            animation: ticker 90s linear infinite; 
            padding-left: 100%; 
            display: inline-block;
        }
        
        .ticker-item { display: inline-block; padding-right: 50px; }

        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        /* --- Layout & Cards --- */
        .dashboard-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px; 
            grid-template-rows: 100px 1fr 220px;    
            gap: 10px;
            padding: 10px;
            height: calc(100vh - 70px); /* Adjusted for new header height */
            overflow-y: auto;
        }

        .card {
            background-color: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .card-header {
            background-color: var(--bg-header);
            padding: 8px 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 10px;
            flex: 1;
            position: relative;
            overflow-y: auto;
        }

        /* --- Controls --- */
        .area-controls { grid-column: 1 / 2; grid-row: 1 / 3; }
        .control-group { margin-bottom: 15px; }
        .group-label { display: block; color: var(--accent-cyan); font-size: 0.75rem; font-family: 'Orbitron'; margin-bottom: 8px; text-transform: uppercase; }
        select, input[type="text"] { width: 100%; background: var(--bg-dark); border: 1px solid var(--border); color: white; padding: 8px; border-radius: 4px; font-family: 'Inter', sans-serif; }
        .checkbox-group { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; max-height: 150px; overflow-y: auto; }
        .checkbox-group div { margin-bottom: 5px; display: flex; align-items: center; }
        .checkbox-group label { margin-left: 8px; font-size: 0.85rem; color: var(--text-muted); }

        /* --- Stats --- */
        .area-stats-top {
            grid-column: 2 / 4; grid-row: 1 / 2;
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
        }
        .stat-box {
            background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px;
            display: flex; flex-direction: column; justify-content: center; padding: 0 15px;
            border-top: 2px solid var(--accent-blue);
        }
        .stat-box.main-count { border-top-color: var(--accent-red); background: linear-gradient(180deg, rgba(239,68,68,0.1) 0%, rgba(0,0,0,0) 100%); }
        .stat-value { font-family: 'Orbitron', sans-serif; font-size: 1.8rem; font-weight: 700; color: white; }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-top: 5px; }

        /* --- Map & Overlays --- */
        .area-map { grid-column: 2 / 3; grid-row: 2 / 3; position: relative; } /* Ensure relative positioning */
        #map { width: 100%; height: 100%; background: #000; z-index: 0; }
        
        /* UPDATED: Z-Index Fix */
        .map-overlay {
            background-color: rgba(11, 14, 20, 0.9) !important;
            border: 1px solid var(--border);
            color: var(--text-main);
            backdrop-filter: blur(4px);
            z-index: 2000; /* Forces it above Leaflet map tiles */
        }
        .map-overlay h4 { color: var(--accent-cyan); border-bottom: 1px solid var(--border); }
        .map-overlay ul { color: var(--text-muted); }

        /* --- Charts --- */
        .area-charts-side { grid-column: 3 / 4; grid-row: 2 / 3; display: flex; flex-direction: column; gap: 10px; }
        .area-timeline { grid-column: 1 / 4; grid-row: 3 / 4; }

        /* --- Footer & Modals --- */
        .footer-links { padding: 10px; font-size: 0.7rem; text-align: center; color: var(--text-muted); }
        .footer-links a { color: var(--accent-blue); text-decoration: none; }
        .modal-overlay { background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--bg-panel); border: 1px solid var(--accent-blue); color: var(--text-main); }
        .modal-close { color: var(--accent-red); }

        @media (max-width: 1000px) {
            .dashboard-container { display: flex; flex-direction: column; height: auto; overflow-y: visible; }
            .area-map { height: 400px; }
            .area-stats-top { grid-template-columns: 1fr 1fr; }
            header { flex-direction: column; height: auto; padding: 10px; gap: 10px; }
            .ranking-banner { width: 100%; margin: 0; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo-container">
            <img src="" alt="Jackson Homicides" class="logo-img" onerror="this.style.display='none'; document.getElementById('logo-text-fallback').style.display='block';">
            
            <div id="logo-text-fallback" class="logo-text" style="display:none;">
                <span style="color:#ef4444">Jackson</span> Homicides
            </div>
        </div>
        
        <div class="ranking-banner" id="rankingBanner">
            <div class="ticker-wrap" id="tickerWrap">
                <div class="ticker-item">Loading City Data...</div>
            </div>
        </div>

        <div class="logo-container" style="justify-content: flex-end;">
            <img src="" alt="WLBT Investigates" class="logo-img" onerror="this.style.display='none'; document.getElementById('wlbt-text-fallback').style.display='block';">
             
             <div id="wlbt-text-fallback" class="logo-text" style="display:none; font-size: 0.9rem; text-align:right;">
                WLBT<br><span style="color:#3b82f6">Investigates</span>
            </div>
        </div>
    </header>

    <div class="dashboard-container">

        <div class="card area-controls">
            <div class="card-header">System Filters</div>
            <div class="card-body">
                <div class="control-group">
                    <label class="group-label">Analysis Year</label>
                    <div id="yearFilter" class="checkbox-group"></div>
                </div>
                <div class="control-group">
                    <label class="group-label">Agency</label>
                    <div id="agencyFilter" class="checkbox-group"></div>
                </div>
                <div class="control-group">
                    <label class="group-label">Circumstance</label>
                    <select id="circumstanceFilter"></select>
                </div>

                <div style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px;">
                     <label class="group-label">Additional Breakdowns</label>
                     <div style="height: 150px; margin-bottom: 10px;">
                        <canvas id="homicidesByCircumstanceChart"></canvas>
                     </div>
                     <div style="height: 150px;">
                        <canvas id="homicidesByAgencyChart"></canvas>
                     </div>
                </div>
            </div>
            <div class="footer-links">
                Design/Layout: C.J. LeMaster<br>
                <a href="#" id="openAboutModal">About Data</a> | 
                <button id="openTipModal" style="background:var(--accent-blue); border:none; color:white; padding:5px 10px; margin-top:5px; border-radius:4px; cursor:pointer;">Submit Tip</button>
            </div>
        </div>

        <div class="area-stats-top">
            <div class="stat-box main-count">
                <div class="stat-value" id="homicideCountDisplay">--</div>
                <div class="stat-label">Total Homicides (2025)</div>
                <div id="homicideCountBanner" style="display:none;"></div> 
            </div>
            <div class="stat-box">
                <div class="stat-value" id="percentageChangeText">--</div>
                <div class="stat-label">vs. Last Year (YTD)</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" style="color: var(--accent-cyan);" id="projectedYearEndText">--</div>
                <div class="stat-label">Projected Year-End</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="rolling30DayText">--</div>
                <div class="stat-label">Last 30 Days</div>
            </div>
        </div>

        <div class="card area-map">
            <div class="card-header">Geographic Distribution</div>
            <div id="map"></div>
            
            <div id="map-legend" class="map-overlay" style="position: absolute; bottom: 20px; right: 20px; top: auto; left: auto; padding: 10px; border-radius: 4px;">
                <h4 style="margin:0 0 5px 0; font-size: 0.8rem;">Legend</h4>
                <ul style="list-style:none; padding:0; font-size: 0.75rem;">
                    <li><span style="display:inline-block; width:10px; height:10px; background:#ef4444; border-radius:50%; margin-right:5px;"></span> Homicide</li>
                    <li><span style="display:inline-block; width:15px; height:3px; background:#fff; border: 1px dashed #666; margin-right:5px;"></span> City Limits</li>
                    <li><span style="display:inline-block; width:15px; height:3px; background:#E65100; margin-right:5px;"></span> CCID</li>
                </ul>
            </div>

            <div id="map-info-panel" class="map-overlay" style="position: absolute; top: 10px; right: 10px; max-width: 250px; padding: 15px; border-radius: 4px;">
                </div>
        </div>

        <div class="area-charts-side">
            <div class="card" style="flex:1;">
                <div class="card-header">Victim Demographics (Age)</div>
                <div class="card-body">
                    <canvas id="victimsByAgeChart"></canvas>
                </div>
            </div>
            <div class="card" style="flex:1;">
                <div class="card-header">Victim Demographics (Race)</div>
                <div class="card-body">
                    <canvas id="victimsByRaceChart"></canvas>
                </div>
            </div>
            <div style="display:none;">
                <span id="thisMonthValue"></span>
                <span id="fiveYearAvgValue"></span>
            </div>
        </div>

        <div class="card area-timeline">
            <div class="card-header">
                <span>Multi-Year Trend Analysis</span>
                <button id="toggleYearRangeBtn" style="background:transparent; border:1px solid var(--border); color:var(--text-muted); font-size:0.6rem; padding:2px 8px; cursor:pointer;">Toggle History</button>
            </div>
            <div class="card-body" style="display: flex; gap: 20px;">
                <div style="flex: 2; height: 100%;">
                    <canvas id="homicideTrendsChart"></canvas>
                </div>
                <div style="flex: 1; height: 100%; border-left: 1px solid var(--border); padding-left: 10px;">
                    <canvas id="homicidesByYearChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="aboutDataModal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; justify-content:center; align-items:center;">
        <div class="modal-content" style="width:500px; padding:20px; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h2>Methodology</h2>
                <span id="closeAboutModal" class="modal-close" style="cursor:pointer; font-size:1.5rem;">&times;</span>
            </div>
            <p style="font-size:0.9rem; line-height:1.5;">Data sourced from JPD, Coroner reports, and official releases. Homicides include all killings regardless of intent (murder, justified, manslaughter) within Jackson city limits.</p>
        </div>
    </div>

    <div id="tipModal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; justify-content:center; align-items:center;">
        <div class="modal-content" style="width:400px; padding:20px; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h2>Submit a Tip</h2>
                <span id="closeTipModal" class="modal-close" style="cursor:pointer; font-size:1.5rem;">&times;</span>
            </div>
            <p><strong>Crime Stoppers:</strong> 601-355-TIPS</p>
            <p><strong>JPD:</strong> 601-960-1234</p>
        </div>
    </div>

    <script>
    const HOMICIDE_DATA_API_URL = './data/homicide.json'; 
    const API_KEY = 'AIzaSyA3lKCL5czCA1DEj3hF7GWVq_QCE0LNaUI';
    const SPREADSHEET_ID = '1xI9D40BPx5DAXJNeonstksYj0g8SMKUoirFJBMWXYlk';
    const SHEET_NAME = 'Sheet1';
    const CITY_COMPARISON_API_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
    const JACKSON_POPULATION = 143709;
    const CURRENT_YEAR = new Date().getFullYear();
    const PREVIOUS_YEAR = CURRENT_YEAR - 1;
    const START_YEAR_DATA = 2016;
    const MAP_CENTER = [32.2988, -90.1848];
    const MAP_ZOOM = 11;
    const FIT_BOUNDS_OPTIONS = { paddingTopLeft: [50, 0] };
    const JACKSON_CITY_LIMITS_GEOJSON_URL = 'https://dl.dropbox.com/scl/fi/9ct9dki2dsg68iyr7gley/City-Boundaries.geojson?rlkey=vjrtpish5tixdeygp1ja5h7fq&st=fyrqfq4x&dl=1';
    const CCID_GEOJSON_URL = 'https://dl.dropbox.com/scl/fi/qz4hkchrk6zonnbr1i5pl/New-CCID-2025.geojson?rlkey=26misdl15h1vgxxj28fzfqhjw&st=82688i24&dl=1';
    const AGENCY_CATEGORIES = { JPD: 'JPD', CAPITOL_POLICE: 'Capitol Police', OTHER: 'Other Agencies' };
    
    const agencyColors = {
        [AGENCY_CATEGORIES.JPD]: '#3b82f6', 
        [AGENCY_CATEGORIES.CAPITOL_POLICE]: '#fbbf24', 
        [AGENCY_CATEGORIES.OTHER]: '#10b981', 
        'Historical': '#64748b' 
    };
    
    const historicalHomicideData = [
        { year: 1976, total: 40 }, { year: 1977, total: 47 }, { year: 1978, total: 33 }, { year: 1979, total: 55 }, { year: 1980, total: 42 },
        { year: 1981, total: 49 }, { year: 1982, total: 57 }, { year: 1983, total: 42 }, { year: 1984, total: 34 }, { year: 1985, total: 43 },
        { year: 1986, total: 35 }, { year: 1987, total: 54 }, { year: 1988, total: 51 }, { year: 1989, total: 49 }, { year: 1990, total: 47 },
        { year: 1991, total: 80 }, { year: 1992, total: 64 }, { year: 1993, total: 84 }, { year: 1994, total: 91 }, { year: 1995, total: 92 },
        { year: 1996, total: 61 }, { year: 1997, total: 64 }, { year: 1998, total: 60 }, { year: 1999, total: 45 }, { year: 2000, total: 39 },
        { year: 2001, total: 50 }, { year: 2002, total: 49 }, { year: 2003, total: 45 }, { year: 2004, total: 53 }, { year: 2005, total: 38 },
        { year: 2006, total: 40 }, { year: 2007, total: 46 }, { year: 2008, total: 63 }, { year: 2009, total: 37 }, { year: 2010, total: 41 },
        { year: 2011, total: 52 }, { year: 2012, total: 63 }, { year: 2013, total: 50 }, { year: 2014, total: 61 }, { year: 2015, total: 54 }
    ];

    let allHomicideData = [];
    let cityComparisonData = [];
    let filteredHomicideDataForMap = [];
    let map;
    let markersLayer = L.layerGroup();
    let heatLayer;
    let currentMapTileLayer;
    let showAllYears = false;
    let selectedMarker = null;
    let homicidesByYearChartInstance, homicideTrendsChartInstance, victimsByAgeChartInstance,
        victimsByRaceChartInstance, homicidesByCircumstanceChartInstance, homicidesByAgencyChartInstance;

    const infoPanel = document.getElementById('map-info-panel');
    let defaultMarkerStyle, selectedMarkerStyle;

    document.addEventListener('DOMContentLoaded', () => {
        defaultMarkerStyle = {
            radius: 6,
            fillColor: '#ef4444', 
            color: '#fff',
            weight: 1, opacity: 1, fillOpacity: 0.9
        };
        selectedMarkerStyle = {
            fillColor: '#fbbf24', 
            color: '#fff',
            radius: 10,
        };
        init();
    });

    async function init() {
        initMap();
        setupModals();
        setupChartToggles();

        document.getElementById('homicideCountBanner').innerText = `...`; 
        updateInfoPanel([]);

        try {
            const [homicideDataResult, cityDataResult] = await Promise.all([
                fetchDataAndProcess(HOMICIDE_DATA_API_URL, true),
                fetchDataAndProcess(CITY_COMPARISON_API_URL, false)
            ]);

            allHomicideData = homicideDataResult;
            cityComparisonData = cityDataResult;

            populateFiltersForMap(true);
            updateDashboard();
            if (map) map.invalidateSize();
        } catch (error) {
            console.error("Fatal Error initializing dashboard:", error);
            allHomicideData = processHomicideData(getPlaceholderHomicideData());
            populateFiltersForMap(true);
            updateDashboard();
        }
    }

    function getPlaceholderHomicideData() {
        return {
            headers: ["Date", "Location", "Victim", "Investigating Agency", "Age", "Race", "Latitude", "Longitude", "Circumstance", "Year"],
            entries: [
                [`01/15/${CURRENT_YEAR}`, "123 Main St, Jackson, MS", 'John Doe', "JPD", 30, "Black", 32.3010, -90.1850, "Argument", CURRENT_YEAR],
                [`02/20/${CURRENT_YEAR}`, "456 Oak Ave, Jackson, MS", 'Jane Smith', "Capitol Police", 25, "White", 32.2950, -90.1900, "Robbery", CURRENT_YEAR],
                [`03/10/${PREVIOUS_YEAR}`, "789 Pine Ln, Jackson, MS", 'Jim Brown', "JPD", 45, "Black", 32.3150, -90.1750, "Unknown", PREVIOUS_YEAR]
            ]
        };
    }

    function getPlaceholderCityData() {
        return [
            { City: 'St. Louis, MO', Homicides: 190, Population: 286578 },
            { City: 'Baltimore, MD', Homicides: 330, Population: 569931 },
        ];
    }

    function processHomicideData(rawData) {
        if (!rawData || !rawData.headers || !rawData.entries) {
            return [];
        }
        const headers = rawData.headers.map(h => String(h).trim().toLowerCase());
        const getHeaderIndex = (names) => names.map(name => headers.indexOf(name.toLowerCase())).find(index => index !== -1) ?? -1;
        
        const indices = {
            victim: getHeaderIndex(['Victim']), age: getHeaderIndex(['Age']), race: getHeaderIndex(['Race']),
            sex: getHeaderIndex(['Sex']), circumstance: getHeaderIndex(['Circumstance']), date: getHeaderIndex(['Date']),
            address: getHeaderIndex(['Address', 'Location']), agency: getHeaderIndex(['Investigating Agency', 'Agency']),
            lat: getHeaderIndex(['Latitude', 'Lat']), lon: getHeaderIndex(['Longitude', 'Lon', 'Long']),
            year: getHeaderIndex(['Year']), month: getHeaderIndex(['Month']), day: getHeaderIndex(['Day'])
        };

        return rawData.entries.map((entry, i) => {
            let dateObj;
            const dateStr = entry[indices.date] ? String(entry[indices.date]).trim() : '';
            
            if (dateStr) {
                if (dateStr.includes('-')) { dateObj = new Date(dateStr + "T00:00:00"); } 
                else if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) { 
                        let year = parseInt(parts[2]);
                        if (year < 100) year += 2000;
                        dateObj = new Date(year, parseInt(parts[0]) - 1, parseInt(parts[1])); 
                    }
                }
            }
            if (!dateObj || isNaN(dateObj.getTime())) {
                const year = parseInt(entry[indices.year]), month = parseInt(entry[indices.month]), day = parseInt(entry[indices.day]);
                if (!isNaN(year) && !isNaN(month) && !isNaN(day)) { dateObj = new Date(year, month - 1, day); }
            }

            const lat = parseFloat(entry[indices.lat]), lon = parseFloat(entry[indices.lon]);
            if (!dateObj || isNaN(dateObj.getTime()) || isNaN(lat) || isNaN(lon)) return null;
            
            return {
                Victim: entry[indices.victim] || 'N/A', Age: entry[indices.age] ? parseInt(entry[indices.age]) : null, Race: entry[indices.race] || 'N/A',
                Date: dateObj.toISOString().split('T')[0], DisplayDate: dateStr, Address: entry[indices.address] || 'N/A',
                'Investigating Agency': entry[indices.agency] || 'N/A', Latitude: lat, Longitude: lon, Year: dateObj.getFullYear(),
                Circumstance: entry[indices.circumstance] || 'N/A'
            };
        }).filter(Boolean);
    }

    async function fetchDataAndProcess(url, isMainHomicideData = false) {
        if (isMainHomicideData) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Network response was not ok for ${url}`);
                const rawData = await response.json();
                return processHomicideData(rawData);
            } catch (error) {
                console.warn(`Using placeholder data due to:`, error);
                return processHomicideData(getPlaceholderHomicideData());
            }
        } else {
             try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Network response was not ok for ${url}`);
                const rawData = await response.json();
                if (!rawData || !rawData.values) return getPlaceholderCityData();
                const [headerRow, ...dataRows] = rawData.values;
                const headers = headerRow.map(h => h.trim().toLowerCase());
                const cityIndex = headers.indexOf('city'), homicidesIndex = headers.indexOf('homicides'), populationIndex = headers.indexOf('population');
                return dataRows.map(row => ({
                    City: row[cityIndex]?.trim(),
                    Homicides: parseInt(String(row[homicidesIndex]).replace(/,/g, '')),
                    Population: parseInt(String(row[populationIndex]).replace(/,/g, ''))
                })).filter(d => d.City && d.Homicides >= 0 && d.Population > 0);
            } catch (error) {
                return getPlaceholderCityData();
            }
        }
    }

    function updateInfoPanel(data) {
        if (!infoPanel) return;
        if (data && !Array.isArray(data)) {
            const d = data;
            infoPanel.innerHTML = `
                <h4 style="color:var(--accent-red)">${d.Victim || 'Unknown Victim'}</h4>
                <div class="info-details" style="font-size:0.8rem; margin-top:10px;">
                    <ul style="list-style:none; padding:0;">
                        ${d.Age ? `<li><strong>Age:</strong> ${d.Age}</li>` : ''}
                        ${d.Race ? `<li><strong>Race:</strong> ${d.Race}</li>` : ''}
                        ${d.DisplayDate ? `<li><strong>Date:</strong> ${d.DisplayDate}</li>` : ''}
                        ${d.Address ? `<li><strong>Address:</strong> ${d.Address}</li>` : ''}
                        ${d['Investigating Agency'] ? `<li><strong>Agency:</strong> ${d['Investigating Agency']}</li>` : ''}
                        ${d.Circumstance ? `<li><strong>Circumstance:</strong> ${d.Circumstance}</li>` : ''}
                    </ul>
                    <button id="back-to-summary-btn" style="margin-top:10px; width:100%; background:var(--accent-blue); border:none; color:white; padding:5px; border-radius:4px; cursor:pointer;">Close</button>
                </div>`;
            
            document.getElementById('back-to-summary-btn').addEventListener('click', () => {
                if (selectedMarker) {
                    selectedMarker.setStyle(defaultMarkerStyle);
                    selectedMarker = null;
                }
                updateInfoPanel(filteredHomicideDataForMap);
            });

        } else {
            const totalCount = data.length;
            infoPanel.innerHTML = `
                <h4>Area Summary</h4>
                <div class="info-summary">
                    <div style="font-size:1.5rem; font-family:'Orbitron'; color:white; margin:10px 0;">${totalCount}</div>
                    <div style="font-size:0.7rem;">Homicides visible in current filter</div>
                    <p style="font-style: italic; font-size: 0.7rem; color: var(--accent-blue); margin-top:10px;">Click a marker for details</p>
                </div>`;
        }
    }

    function initMap() {
        map = L.map('map', { 
            scrollWheelZoom: true, 
            minZoom: 10,
            zoomControl: false 
        }).setView(MAP_CENTER, MAP_ZOOM);
        
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        updateMapTiles();
        markersLayer.addTo(map);
        loadBoundaryLayers();
        
        map.on('click', (e) => {
            if (e.originalEvent && e.originalEvent._stopped) return; 
            if (selectedMarker) {
                selectedMarker.setStyle(defaultMarkerStyle);
                selectedMarker = null;
            }
            updateInfoPanel(filteredHomicideDataForMap);
        });
    }

    function updateMapDisplay() {
        const selectedYears = Array.from(document.querySelectorAll('#yearFilter input:checked')).map(cb => parseInt(cb.value));
        const selectedAgencies = Array.from(document.querySelectorAll('#agencyFilter input:checked')).map(cb => cb.value);
        const selectedCircumstance = document.getElementById('circumstanceFilter').value;
        filteredHomicideDataForMap = allHomicideData.filter(d => 
            selectedYears.includes(d.Year) &&
            selectedAgencies.includes(d['Investigating Agency']) &&
            (!selectedCircumstance || d.Circumstance === selectedCircumstance)
        );
        markersLayer.clearLayers();
        const visibleMarkers = [];
        
        filteredHomicideDataForMap.forEach(d => {
            const latLng = [d.Latitude, d.Longitude];
            
            const marker = L.circleMarker(latLng, { ...defaultMarkerStyle, bubblingMouseEvents: false });
            
            marker.on('click', (e) => {
                if (e.originalEvent) L.DomEvent.stop(e.originalEvent); else L.DomEvent.stop(e);
                if (selectedMarker) {
                    selectedMarker.setStyle(defaultMarkerStyle);
                }
                marker.setStyle(selectedMarkerStyle);
                selectedMarker = marker;
                updateInfoPanel(d);
            });
            
            markersLayer.addLayer(marker);
            visibleMarkers.push(marker);
        });
        updateInfoPanel(filteredHomicideDataForMap);

        if (visibleMarkers.length > 0 && map.hasLayer(markersLayer)) {
            map.fitBounds(L.featureGroup(visibleMarkers).getBounds().pad(0.1), FIT_BOUNDS_OPTIONS);
        } else {
            map.setView(MAP_CENTER, MAP_ZOOM);
        }
    }
    
    function setupModals() {
        const aboutModal = document.getElementById("aboutDataModal");
        const openAboutBtn = document.getElementById("openAboutModal");
        const closeAboutBtn = document.getElementById("closeAboutModal");
        if(openAboutBtn) openAboutBtn.onclick = (e) => { e.preventDefault(); aboutModal.style.display = "flex"; };
        if(closeAboutBtn) closeAboutBtn.onclick = () => { aboutModal.style.display = "none"; };

        const tipModal = document.getElementById("tipModal");
        const openTipBtn = document.getElementById("openTipModal");
        const closeTipBtn = document.getElementById("closeTipModal");
        if(openTipBtn) openTipBtn.onclick = () => { tipModal.style.display = "flex"; };
        if(closeTipBtn) closeTipBtn.onclick = () => { tipModal.style.display = "none"; };
        
        window.onclick = (event) => {
            if (event.target == aboutModal) aboutModal.style.display = "none";
            if (event.target == tipModal) tipModal.style.display = "none";
        };
    }
    
    function setupChartToggles() {
        document.getElementById('toggleYearRangeBtn')?.addEventListener('click', () => {
            showAllYears = !showAllYears;
            document.getElementById('toggleYearRangeBtn').textContent = showAllYears ? 'Show Recent' : 'Show History';
            updateHomicidesByYearChart();
        });
    }

    function populateFiltersForMap(isInitialLoad = false) {
        const yearContainer = document.getElementById('yearFilter');
        if (isInitialLoad) {
            const allYears = [...new Set(allHomicideData.map(d => d.Year))].sort((a, b) => b - a);
            populateCheckboxFilter('yearFilter', allYears.filter(y => y >= START_YEAR_DATA), [CURRENT_YEAR], handleYearFilterChange);
        }
        const selectedYears = Array.from(yearContainer.querySelectorAll('input:checked')).map(cb => parseInt(cb.value));
        const dataForDependentFilters = allHomicideData.filter(d => selectedYears.includes(d.Year));
        const agenciesToShow = [...new Set(dataForDependentFilters.map(d => d['Investigating Agency']))].filter(Boolean).sort();
        populateCheckboxFilter('agencyFilter', agenciesToShow, agenciesToShow, updateDashboard);
        const circumstancesToShow = [...new Set(dataForDependentFilters.map(d => d.Circumstance))].filter(Boolean).sort();
        const circumstanceSelect = document.getElementById('circumstanceFilter');
        circumstanceSelect.innerHTML = '<option value="">All Circumstances</option>';
        circumstancesToShow.forEach(c => circumstanceSelect.add(new Option(c, c)));
        circumstanceSelect.onchange = updateDashboard;
    }

    function handleYearFilterChange() {
        populateFiltersForMap(false);
        updateDashboard();
    }

    function populateCheckboxFilter(elementId, values, defaultSelected, changeCallback) {
        const container = document.getElementById(elementId);
        const previouslySelected = Array.from(container.querySelectorAll('input:checked')).map(cb => cb.value);
        container.innerHTML = '';
        values.forEach(val => {
            const div = document.createElement('div');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `${elementId}_${String(val).replace(/\s+/g, '_')}`;
            checkbox.value = val;
            checkbox.checked = defaultSelected.includes(val) || previouslySelected.includes(String(val));
            checkbox.addEventListener('change', changeCallback);
            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = val;
            div.append(checkbox, label);
            container.appendChild(div);
        });
    }

    function updateCurrentYearHomicideCount() {
        const count = allHomicideData.filter(d => d.Year === CURRENT_YEAR).length;
        document.getElementById('homicideCountDisplay').innerText = count;
    }

    function updateRankingBanner() {
        const tickerWrap = document.getElementById('tickerWrap');
        const jacksonCount = allHomicideData.filter(d => d.Year === CURRENT_YEAR).length;
        const jacksonRate = (jacksonCount / JACKSON_POPULATION) * 100000;
        
        if (!cityComparisonData || cityComparisonData.length === 0) {
            tickerWrap.innerHTML = `<div class="ticker-item">Comparison data unavailable.</div>`;
            return;
        }
        
        const citiesWithRates = cityComparisonData.map(c => ({ name: c.City, rate: (c.Homicides / c.Population) * 100000 }));
        citiesWithRates.push({ name: 'Jackson, MS', rate: jacksonRate });
        citiesWithRates.sort((a, b) => b.rate - a.rate);
        
        const top5 = citiesWithRates.slice(0, 10);
        const tickerItems = ["Top 10 Homicide Rates (per 100k)"];
        top5.forEach((c, i) => tickerItems.push(`${i + 1}. ${c.name} <span style="color:var(--accent-red)">(${c.rate.toFixed(1)})</span>`));
        
        const tickerText = tickerItems.join(' &nbsp; | &nbsp; ');
        tickerWrap.innerHTML = `<div class="ticker-item">${tickerText}</div><div class="ticker-item">${tickerText}</div>`;
    }
      
    function updatePercentageChangeDisplay() {
        const div = document.getElementById('percentageChangeText');
        const today = new Date();
        const dayOfYear = (Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()) - Date.UTC(today.getFullYear(), 0, 0)) / 86400000;
        const getCountUpToDay = (year, day) => allHomicideData.filter(d => {
            if (d.Year !== year || !d.Date) return false;
            const itemDate = new Date(d.Date + 'T00:00:00');
            const itemDayOfYear = (Date.UTC(itemDate.getFullYear(), itemDate.getMonth(), itemDate.getDate()) - Date.UTC(itemDate.getFullYear(), 0, 0)) / 86400000;
            return itemDayOfYear <= day;
        }).length;
        const currentYTD = getCountUpToDay(CURRENT_YEAR, dayOfYear);
        const prevYTD = getCountUpToDay(PREVIOUS_YEAR, dayOfYear);
        let text = "N/A", colorVar = 'var(--percentage-neutral)';
        if (prevYTD > 0) {
            const change = ((currentYTD - prevYTD) / prevYTD) * 100;
            text = `${change > 0 ? '+' : ''}${change.toFixed(0)}%`;
            colorVar = change > 0 ? 'var(--percentage-increase)' : 'var(--percentage-decrease)';
            if (change === 0) colorVar = 'var(--percentage-neutral)';
        } else if (currentYTD > 0) {
            text = `+${currentYTD}`; colorVar = 'var(--percentage-increase)';
        } else { text = "0%"; }
        div.innerText = text;
        div.style.color = colorVar;
    }

    function updateProjectedYearEndTotal() {
        const div = document.getElementById('projectedYearEndText');
        const today = new Date();
        const start = new Date(today.getFullYear(), 0, 0);
        const diff = today - start;
        const oneDay = 1000 * 60 * 60 * 24;
        const dayOfYear = Math.floor(diff / oneDay);
        const currentYTD = allHomicideData.filter(d => d.Year === CURRENT_YEAR).length;

        if (dayOfYear > 0 && currentYTD > 0) {
            const projection = (currentYTD / dayOfYear) * (today.getFullYear() % 4 === 0 ? 366 : 365); 
            div.innerText = Math.round(projection);
        } else {
            div.innerText = currentYTD; 
        }
    }

    function updateMonthlyTrend() {
        // Logic intentionally left empty in favor of new stat boxes
    }
   
    function calculateRollingAverage(days) {
        const today = new Date();
        today.setHours(23, 59, 59, 999);
        const daysAgo = new Date(new Date().setDate(today.getDate() - days));
        daysAgo.setHours(0, 0, 0, 0); 
        const count = allHomicideData.filter(d => {
            const date = new Date(d.Date + 'T00:00:00'); 
            return date >= daysAgo && date <= today;
        }).length;
        return count;
    }

    function updateRolling30DayTrend() {
        document.getElementById('rolling30DayText').innerText = calculateRollingAverage(30);
    }

    // --- CHART CONFIGURATION ---
    function getChartOptions(tooltipCallback) {
        const textColor = '#94a3b8';
        const gridColor = '#2d3748';
        return {
            responsive: true, maintainAspectRatio: false,
            scales: { 
                x: { ticks: { color: textColor }, grid: { color: gridColor } }, 
                y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } } 
            },
            plugins: { 
                legend: { position: 'top', labels: { color: textColor } }, 
                tooltip: { mode: 'index', intersect: false, callbacks: { label: tooltipCallback } } 
            }
        };
    }

    function updateHomicidesByYearChart() {
        const ctx = document.getElementById('homicidesByYearChart').getContext('2d');
        if (homicidesByYearChartInstance) homicidesByYearChartInstance.destroy();
        const chartOptions = getChartOptions(() => {});
        chartOptions.plugins.legend.display = false;
        
        if (showAllYears) {
            const yearlyTotals = {};
            historicalHomicideData.forEach(d => { yearlyTotals[d.year] = d.total; });
            allHomicideData.forEach(d => { yearlyTotals[d.Year] = (yearlyTotals[d.Year] || 0) + 1; });
            const years = Object.keys(yearlyTotals).map(Number).sort((a, b) => a - b).filter(y => y <= CURRENT_YEAR);
            const totals = years.map(y => yearlyTotals[y]);
            homicidesByYearChartInstance = new Chart(ctx, { type: 'bar', data: { labels: years, datasets: [{ label: 'Total Homicides', data: totals, backgroundColor: agencyColors['Historical'] }] }, options: chartOptions });
        } else {
            const yearlyTotals = {};
            const years = Array.from({length: CURRENT_YEAR - START_YEAR_DATA + 1}, (_, i) => START_YEAR_DATA + i);
            years.forEach(y => yearlyTotals[y] = { [AGENCY_CATEGORIES.JPD]: 0, [AGENCY_CATEGORIES.CAPITOL_POLICE]: 0, [AGENCY_CATEGORIES.OTHER]: 0 });
            allHomicideData.forEach(d => {
                if (d.Year >= START_YEAR_DATA) {
                    const cat = d['Investigating Agency'] === 'JPD' ? 'JPD' : (d['Investigating Agency'] === 'Capitol Police' ? 'Capitol Police' : 'Other Agencies');
                    yearlyTotals[d.Year][cat]++;
                }
            });
            chartOptions.scales.x.stacked = true; chartOptions.scales.y.stacked = true;
            const datasets = Object.values(AGENCY_CATEGORIES).map(cat => ({ label: cat, data: years.map(y => yearlyTotals[y][cat]), backgroundColor: agencyColors[cat] }));
            homicidesByYearChartInstance = new Chart(ctx, { type: 'bar', data: { labels: years, datasets }, options: chartOptions });
        }
    }

    function updateHomicideTrendsChart() {
        const ctx = document.getElementById('homicideTrendsChart').getContext('2d');
        if (homicideTrendsChartInstance) homicideTrendsChartInstance.destroy();
        
        const getRunningTotalData = (year) => {
            const yearData = allHomicideData.filter(d => d.Year === year).sort((a, b) => new Date(a.Date) - new Date(b.Date));
            const chartDataPoints = [];
            const commonAxisYear = 2000; 
            let cumulativeCount = 0;
            let homicideDataIndex = 0;
            let loopEndDate = (year === CURRENT_YEAR) ? new Date() : new Date(year, 11, 31);
            
            for (let dLoop = new Date(year, 0, 1); dLoop <= loopEndDate; dLoop.setDate(dLoop.getDate() + 1)) {
                const currentLoopDayFormatted = dLoop.toISOString().split('T')[0];
                while(homicideDataIndex < yearData.length && yearData[homicideDataIndex].Date <= currentLoopDayFormatted) {
                    cumulativeCount++;
                    homicideDataIndex++;
                }
                chartDataPoints.push({
                    x: `${commonAxisYear}-${(dLoop.getMonth() + 1).toString().padStart(2, '0')}-${dLoop.getDate().toString().padStart(2, '0')}`,
                    y: cumulativeCount 
                });
            }
            if (chartDataPoints.length === 0 || chartDataPoints[0].x !== `${commonAxisYear}-01-01`) {
                chartDataPoints.unshift({ x: `${commonAxisYear}-01-01`, y: 0 });
            }
            return chartDataPoints;
        };
        
        const trendChartOptions = { 
            ...getChartOptions(() => {}), 
            scales: { 
                x: { 
                    type: 'time', 
                    time: { unit: 'month', tooltipFormat: 'MMM dd', displayFormats: { month: 'MMM' } },
                    grid: { color: '#2d3748' }, ticks: { color: '#94a3b8' }
                }, 
                y: { beginAtZero: true, grid: { color: '#2d3748' }, ticks: { color: '#94a3b8' } } 
            } 
        };

        const paceColors = [
            '#ef4444', '#475569', '#334155', '#1e293b', '#3b82f6', '#10b981'
        ];

        const datasets = [];
        for (let i = 0; i <= 5; i++) {
            const year = CURRENT_YEAR - i;
            if (year < START_YEAR_DATA) break; 
            
            datasets.push({
                label: String(year),
                data: getRunningTotalData(year),
                borderColor: paceColors[i % paceColors.length],
                borderWidth: (year === CURRENT_YEAR) ? 3 : 1,
                tension: 0.1,
                pointRadius: 0,
                pointHoverRadius: 4
            });
        }

        homicideTrendsChartInstance = new Chart(ctx, { 
            type: 'line', 
            data: { datasets: datasets.reverse() }, 
            options: trendChartOptions
        });
    }

    function updateDemographicCharts() {
        const ageGroups = { '0-17': 0, '18-29': 0, '30-49': 0, '50+': 0, 'Unknown': 0 };
        filteredHomicideDataForMap.forEach(d => {
            const age = d.Age;
            if (age === null) ageGroups['Unknown']++;
            else if (age <= 17) ageGroups['0-17']++;
            else if (age <= 29) ageGroups['18-29']++;
            else if (age <= 49) ageGroups['30-49']++;
            else ageGroups['50+']++;
        });
        const ageCtx = document.getElementById('victimsByAgeChart').getContext('2d');
        if (victimsByAgeChartInstance) victimsByAgeChartInstance.destroy();
        victimsByAgeChartInstance = new Chart(ageCtx, { type: 'bar', data: { labels: Object.keys(ageGroups), datasets: [{ label: 'Victims by Age', data: Object.values(ageGroups), backgroundColor: '#3b82f6' }] }, options: { ...getChartOptions(() => {}), plugins: { legend: { display: false } } } });
    }
    
    function updateVictimsByRaceChart() {
        const counts = filteredHomicideDataForMap.reduce((acc, d) => { acc[d.Race || 'Unknown'] = (acc[d.Race || 'Unknown'] || 0) + 1; return acc; }, {});
        if (victimsByRaceChartInstance) victimsByRaceChartInstance.destroy();
        victimsByRaceChartInstance = new Chart(document.getElementById('victimsByRaceChart'), { type: 'doughnut', data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ['#ef4444', '#3b82f6', '#fbbf24', '#10b981'], borderWidth:0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color:'#94a3b8' } }}} });
    }

    function updateHomicidesByCircumstanceChart() {
        const counts = filteredHomicideDataForMap.reduce((acc, d) => { acc[d.Circumstance || 'Unknown'] = (acc[d.Circumstance || 'Unknown'] || 0) + 1; return acc; }, {});
        if (homicidesByCircumstanceChartInstance) homicidesByCircumstanceChartInstance.destroy();
        homicidesByCircumstanceChartInstance = new Chart(document.getElementById('homicidesByCircumstanceChart'), { type: 'bar', data: { labels: Object.keys(counts), datasets: [{ label: 'Count', data: Object.values(counts), backgroundColor: '#8b5cf6' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }}, scales: {x:{display:false}} } });
    }

    function updateHomicidesByAgencyChart() {
        const counts = filteredHomicideDataForMap.reduce((acc, d) => { acc[d['Investigating Agency'] || 'Unknown'] = (acc[d['Investigating Agency'] || 'Unknown'] || 0) + 1; return acc; }, {});
        if (homicidesByAgencyChartInstance) homicidesByAgencyChartInstance.destroy();
        homicidesByAgencyChartInstance = new Chart(document.getElementById('homicidesByAgencyChart'), { type: 'pie', data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ['#3b82f6', '#fbbf24', '#10b981'], borderWidth:0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display:false }}} });
    }
    
    function updateDashboard() {
        updateCurrentYearHomicideCount();
        updateRankingBanner();
        updatePercentageChangeDisplay();
        updateMonthlyTrend(); 
        updateRolling30DayTrend(); 
        updateProjectedYearEndTotal();
        
        updateMapDisplay();
        updateHomicidesByYearChart();
        updateHomicideTrendsChart();
        updateDemographicCharts();
        updateVictimsByRaceChart();
        updateHomicidesByCircumstanceChart();
        updateHomicidesByAgencyChart();
    }

    function loadBoundaryLayers(){
        const fetchGeoJSON = async (url, style, name) => {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const geojson = await response.json();
                const layer = L.geoJSON(geojson, { style, interactive: false });
                layer.addTo(map);
                layer.bringToBack();
                return layer;
            } catch (error) { console.error(`Error loading ${name} GeoJSON:`, error); return null; }
        };
        Promise.all([
            fetchGeoJSON(JACKSON_CITY_LIMITS_GEOJSON_URL, { color: `#fff`, weight: 2, opacity: 0.3, fillOpacity: 0.0, dashArray: '5, 5' }, "Jackson City Limits"),
            fetchGeoJSON(CCID_GEOJSON_URL, { color: `#E65100`, weight: 2, opacity: 0.8, fillOpacity: 0.1 }, "CCID Boundary")
        ]).then(() => {
        });
    }

    function updateMapTiles() {
        if (currentMapTileLayer) map.removeLayer(currentMapTileLayer);
        currentMapTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);
    }
    </script>
</body>
</html>

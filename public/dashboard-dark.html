<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jackson Homicide Tracker | HUD Edition</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* HUD Color Palette */
            --bg-dark: #0b0e14;
            --bg-panel: #151a25;
            --bg-header: #1e2532;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --accent-red: #ef4444;    /* Homicides */
            --accent-blue: #3b82f6;   /* JPD/Police */
            --accent-cyan: #06b6d4;   /* Highlights */
            --accent-green: #10b981;
            --border: #2d3748;
            
            /* Logic Colors from your original file mapped to variables */
            --percentage-increase: #ef4444;
            --percentage-decrease: #10b981;
            --percentage-neutral: #94a3b8;

            /* Effects */
            --glow-red: 0 0 10px rgba(239, 68, 68, 0.4);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* App-like feel */
        }

        /* --- Header --- */
        header {
            background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Ticker styled as a digital marquee */
        .ranking-banner {
            flex-grow: 1;
            margin: 0 20px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 4px;
            height: 30px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            color: var(--accent-cyan);
            font-family: 'Orbitron', monospace;
            font-size: 0.8rem;
        }

        .ticker-wrap {
            white-space: nowrap;
            animation: ticker 30s linear infinite;
            padding-left: 100%; /* Start off-screen */
            display: inline-block;
        }
        
        .ticker-item { display: inline-block; padding-right: 50px; }

        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        /* --- Main Grid Layout --- */
        .dashboard-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px; /* Sidebar | Map | Stats */
            grid-template-rows: 100px 1fr 220px;    /* Top Stats | Main | Bottom Charts */
            gap: 10px;
            padding: 10px;
            height: calc(100vh - 60px);
            overflow-y: auto;
        }

        /* --- Card Styles --- */
        .card {
            background-color: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .card-header {
            background-color: var(--bg-header);
            padding: 8px 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 10px;
            flex: 1;
            position: relative;
            overflow-y: auto;
        }

        /* --- Specific Areas --- */
        
        /* 1. Sidebar Controls (Left) */
        .area-controls {
            grid-column: 1 / 2;
            grid-row: 1 / 3; 
        }

        /* Form Controls customized for Dark Mode */
        .control-group { margin-bottom: 15px; }
        .group-label { 
            display: block; 
            color: var(--accent-cyan); 
            font-size: 0.75rem; 
            font-family: 'Orbitron'; 
            margin-bottom: 8px; 
            text-transform: uppercase;
        }
        
        select, input[type="text"] {
            width: 100%;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Inter', sans-serif;
        }
        
        /* Checkbox styling */
        .checkbox-group {
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
        }
        .checkbox-group div { margin-bottom: 5px; display: flex; align-items: center; }
        .checkbox-group label { margin-left: 8px; font-size: 0.85rem; color: var(--text-muted); }

        /* 2. Top Stats (Middle Top) */
        .area-stats-top {
            grid-column: 2 / 4;
            grid-row: 1 / 2;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .stat-box {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0 15px;
            border-top: 2px solid var(--accent-blue);
        }
        
        .stat-box.main-count { border-top-color: var(--accent-red); background: linear-gradient(180deg, rgba(239,68,68,0.1) 0%, rgba(0,0,0,0) 100%); }

        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
        }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-top: 5px; }

        /* 3. The Map (Middle Center) */
        .area-map {
            grid-column: 2 / 3;
            grid-row: 2 / 3;
        }
        #map { width: 100%; height: 100%; background: #000; }
        
        /* Map Overlays (Legend/Info) adapted for dark mode */
        .map-overlay {
            background-color: rgba(11, 14, 20, 0.9) !important;
            border: 1px solid var(--border);
            color: var(--text-main);
            backdrop-filter: blur(4px);
        }
        .map-overlay h4 { color: var(--accent-cyan); border-bottom: 1px solid var(--border); }
        .map-overlay ul { color: var(--text-muted); }

        /* 4. Side Charts (Right) */
        .area-charts-side {
            grid-column: 3 / 4;
            grid-row: 2 / 3;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* 5. Bottom Timeline (Bottom Span) */
        .area-timeline {
            grid-column: 1 / 4;
            grid-row: 3 / 4;
        }

        /* Footer links */
        .footer-links {
            padding: 10px;
            font-size: 0.7rem;
            text-align: center;
            color: var(--text-muted);
        }
        .footer-links a { color: var(--accent-blue); text-decoration: none; }

        /* Modals */
        .modal-overlay {
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--bg-panel);
            border: 1px solid var(--accent-blue);
            color: var(--text-main);
        }
        .modal-close { color: var(--accent-red); }

        /* Responsive */
        @media (max-width: 1000px) {
            .dashboard-container {
                display: flex;
                flex-direction: column;
                height: auto;
                overflow-y: visible;
            }
            .area-map { height: 400px; }
            .area-stats-top { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
            <h1>Jackson Homicide Tracker</h1>
        </div>
        
        <div class="ranking-banner" id="rankingBanner">
            <div class="ticker-wrap" id="tickerWrap">
                <div class="ticker-item">Loading City Data...</div>
            </div>
        </div>

        <div style="font-size: 0.7rem; color: var(--text-muted); text-align: right;">
            <div id="date-display">DATA SOURCE: JPD / WLBT</div>
            <a href="#" id="openAboutModal" style="color:var(--accent-blue);">About Data</a>
        </div>
    </header>

    <div class="dashboard-container">

        <div class="card area-controls">
            <div class="card-header">System Filters</div>
            <div class="card-body">
                <div class="control-group">
                    <label class="group-label">Analysis Year</label>
                    <div id="yearFilter" class="checkbox-group"></div>
                </div>
                <div class="control-group">
                    <label class="group-label">Agency</label>
                    <div id="agencyFilter" class="checkbox-group"></div>
                </div>
                <div class="control-group">
                    <label class="group-label">Circumstance</label>
                    <select id="circumstanceFilter"></select>
                </div>

                <div style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px;">
                     <label class="group-label">Additional Breakdowns</label>
                     <div style="height: 150px; margin-bottom: 10px;">
                        <canvas id="homicidesByCircumstanceChart"></canvas>
                     </div>
                     <div style="height: 150px;">
                        <canvas id="homicidesByAgencyChart"></canvas>
                     </div>
                </div>
            </div>
            <div class="footer-links">
                Design/Layout: C.J. LeMaster<br>
                <button id="openTipModal" style="background:var(--accent-blue); border:none; color:white; padding:5px 10px; margin-top:5px; border-radius:4px; cursor:pointer;">Submit Tip</button>
            </div>
        </div>

        <div class="area-stats-top">
            <div class="stat-box main-count">
                <div class="stat-value" id="homicideCountDisplay">--</div>
                <div class="stat-label">Total Homicides (2025)</div>
                <div id="homicideCountBanner" style="display:none;"></div> 
            </div>
            
            <div class="stat-box">
                <div class="stat-value" id="percentageChangeText">--</div>
                <div class="stat-label">vs. Last Year (YTD)</div>
            </div>

            <div class="stat-box">
                <div class="stat-value" style="color: var(--accent-cyan);" id="projectedYearEndText">--</div>
                <div class="stat-label">Projected Year-End</div>
            </div>

            <div class="stat-box">
                <div class="stat-value" id="rolling30DayText">--</div>
                <div class="stat-label">Last 30 Days</div>
            </div>
        </div>

        <div class="card area-map">
            <div class="card-header">Geographic Distribution</div>
            <div id="map"></div>
            
            <div id="map-legend" class="map-overlay" style="position: absolute; bottom: 20px; right: 20px; top: auto; left: auto; padding: 10px; border-radius: 4px;">
                <h4 style="margin:0 0 5px 0; font-size: 0.8rem;">Legend</h4>
                <ul style="list-style:none; padding:0; font-size: 0.75rem;">
                    <li><span style="display:inline-block; width:10px; height:10px; background:#ef4444; border-radius:50%; margin-right:5px;"></span> Homicide</li>
                    <li><span style="display:inline-block; width:15px; height:3px; background:#000; border: 1px solid #fff; margin-right:5px;"></span> City Limits</li>
                    <li><span style="display:inline-block; width:15px; height:3px; background:#E65100; margin-right:5px;"></span> CCID</li>
                </ul>
            </div>

            <div id="map-info-panel" class="map-overlay" style="position: absolute; top: 10px; right: 10px; max-width: 250px; padding: 15px; border-radius: 4px;">
                </div>
        </div>

        <div class="area-charts-side">
            <div class="card" style="flex:1;">
                <div class="card-header">Victim Demographics (Age)</div>
                <div class="card-body">
                    <canvas id="victimsByAgeChart"></canvas>
                </div>
            </div>
            <div class="card" style="flex:1;">
                <div class="card-header">Victim Demographics (Race)</div>
                <div class="card-body">
                    <canvas id="victimsByRaceChart"></canvas>
                </div>
            </div>
            <div style="display:none;">
                <span id="thisMonthValue"></span>
                <span id="fiveYearAvgValue"></span>
            </div>
        </div>

        <div class="card area-timeline">
            <div class="card-header">
                <span>Multi-Year Trend Analysis</span>
                <button id="toggleYearRangeBtn" style="background:transparent; border:1px solid var(--border); color:var(--text-muted); font-size:0.6rem; padding:2px 8px; cursor:pointer;">Toggle History</button>
            </div>
            <div class="card-body" style="display: flex; gap: 20px;">
                <div style="flex: 2; height: 100%;">
                    <canvas id="homicideTrendsChart"></canvas>
                </div>
                <div style="flex: 1; height: 100%; border-left: 1px solid var(--border); padding-left: 10px;">
                    <canvas id="homicidesByYearChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="aboutDataModal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; justify-content:center; align-items:center;">
        <div class="modal-content" style="width:500px; padding:20px; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h2>Methodology</h2>
                <span id="closeAboutModal" class="modal-close" style="cursor:pointer; font-size:1.5rem;">&times;</span>
            </div>
            <p style="font-size:0.9rem; line-height:1.5;">Data sourced from JPD, Coroner reports, and official releases. Homicides include all killings regardless of intent (murder, justified, manslaughter) within Jackson city limits.</p>
        </div>
    </div>

    <div id="tipModal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; justify-content:center; align-items:center;">
        <div class="modal-content" style="width:400px; padding:20px; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h2>Submit a Tip</h2>
                <span id="closeTipModal" class="modal-close" style="cursor:pointer; font-size:1.5rem;">&times;</span>
            </div>
            <p><strong>Crime Stoppers:</strong> 601-355-TIPS</p>
            <p><strong>JPD:</strong> 601-960-1234</p>
        </div>
    </div>

    <script>
    // --- Configuration ---
    // Note: Replaced "this" year logic slightly to ensure charts render correctly on load
    const HOMICIDE_DATA_API_URL = './data/homicide.json'; 
    const API_KEY = 'AIzaSyA3lKCL5czCA1DEj3hF7GWVq_QCE0LNaUI';
    const SPREADSHEET_ID = '1xI9D40BPx5DAXJNeonstksYj0g8SMKUoirFJBMWXYlk';
    const SHEET_NAME = 'Sheet1';
    const CITY_COMPARISON_API_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
    const JACKSON_POPULATION = 143709;
    const CURRENT_YEAR = new Date().getFullYear();
    const PREVIOUS_YEAR = CURRENT_YEAR - 1;
    const START_YEAR_DATA = 2016;
    const MAP_CENTER = [32.2988, -90.1848];
    const MAP_ZOOM = 11;
    const FIT_BOUNDS_OPTIONS = { paddingTopLeft: [50, 0] };
    const JACKSON_CITY_LIMITS_GEOJSON_URL = 'https://dl.dropbox.com/scl/fi/9ct9dki2dsg68iyr7gley/City-Boundaries.geojson?rlkey=vjrtpish5tixdeygp1ja5h7fq&st=fyrqfq4x&dl=1';
    const CCID_GEOJSON_URL = 'https://dl.dropbox.com/scl/fi/qz4hkchrk6zonnbr1i5pl/New-CCID-2025.geojson?rlkey=26misdl15h1vgxxj28fzfqhjw&st=82688i24&dl=1';
    const AGENCY_CATEGORIES = { JPD: 'JPD', CAPITOL_POLICE: 'Capitol Police', OTHER: 'Other Agencies' };
    
    // Updated Colors for Dark Mode visibility
    const agencyColors = {
        [AGENCY_CATEGORIES.JPD]: '#3b82f6', // Bright Blue
        [AGENCY_CATEGORIES.CAPITOL_POLICE]: '#fbbf24', // Amber
        [AGENCY_CATEGORIES.OTHER]: '#10b981', // Emerald
        'Historical': '#64748b' // Slate
    };
    
    const historicalHomicideData = [
        { year: 1976, total: 40 }, { year: 1977, total: 47 }, { year: 1978, total: 33 }, { year: 1979, total: 55 }, { year: 1980, total: 42 },
        { year: 1981, total: 49 }, { year: 1982, total: 57 }, { year: 1983, total: 42 }, { year: 1984, total: 34 }, { year: 1985, total: 43 },
        { year: 1986, total: 35 }, { year: 1987, total: 54 }, { year: 1988, total: 51 }, { year: 1989, total: 49 }, { year: 1990, total: 47 },
        { year: 1991, total: 80 }, { year: 1992, total: 64 }, { year: 1993, total: 84 }, { year: 1994, total: 91 }, { year: 1995, total: 92 },
        { year: 1996, total: 61 }, { year: 1997, total: 64 }, { year: 1998, total: 60 }, { year: 1999, total: 45 }, { year: 2000, total: 39 },
        { year: 2001, total: 50 }, { year: 2002, total: 49 }, { year: 2003, total: 45 }, { year: 2004, total: 53 }, { year: 2005, total: 38 },
        { year: 2006, total: 40 }, { year: 2007, total: 46 }, { year: 2008, total: 63 }, { year: 2009, total: 37 }, { year: 2010, total: 41 },
        { year: 2011, total: 52 }, { year: 2012, total: 63 }, { year: 2013, total: 50 }, { year: 2014, total: 61 }, { year: 2015, total: 54 }
    ];

    // --- Global State ---
    let allHomicideData = [];
    let cityComparisonData = [];
    let filteredHomicideDataForMap = [];
    let map;
    let markersLayer = L.layerGroup();
    let heatLayer;
    let cityLimitsLayer, ccidLayer;
    let overlayLayersControl;
    let currentMapTileLayer;
    let showAllYears = false;
    let selectedMarker = null;
    let homicidesByYearChartInstance, homicideTrendsChartInstance, victimsByAgeChartInstance,
        victimsByRaceChartInstance, homicidesByCircumstanceChartInstance, homicidesByAgencyChartInstance;

    const infoPanel = document.getElementById('map-info-panel');
    let defaultMarkerStyle, selectedMarkerStyle;

    // --- Main Execution Block ---
    document.addEventListener('DOMContentLoaded', () => {
        defaultMarkerStyle = {
            radius: 6,
            fillColor: '#ef4444', // Neon Red
            color: '#fff',
            weight: 1, opacity: 1, fillOpacity: 0.9
        };
        selectedMarkerStyle = {
            fillColor: '#fbbf24', // Amber
            color: '#fff',
            radius: 10,
        };
        init();
    });

    async function init() {
        initMap();
        setupModals();
        setupChartToggles();

        document.getElementById('homicideCountBanner').innerText = `...`; // Initialize hidden
        updateInfoPanel([]);

        try {
            const [homicideDataResult, cityDataResult] = await Promise.all([
                fetchDataAndProcess(HOMICIDE_DATA_API_URL, true),
                fetchDataAndProcess(CITY_COMPARISON_API_URL, false)
            ]);

            allHomicideData = homicideDataResult;
            cityComparisonData = cityDataResult;

            populateFiltersForMap(true);
            updateDashboard();
            if (map) map.invalidateSize();
        } catch (error) {
            console.error("Fatal Error initializing dashboard:", error);
            // Fallback for demo if fetch fails
            allHomicideData = processHomicideData(getPlaceholderHomicideData());
            populateFiltersForMap(true);
            updateDashboard();
        }

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jackson Homicide Tracker | Public Safety Dashboard</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* THEME: Midnight Command Center */
            --bg-body: #050505;
            --bg-panel: #0f1116;
            --bg-header: #13151a;
            
            --text-main: #e2e8f0;
            --text-muted: #64748b;
            
            /* ACCENTS */
            --neon-red: #d9534f;
            --neon-blue: #0d6efd;
            --neon-amber: #ffc107;
            --neon-green: #198754;
            --neon-purple: #6f42c1;
            
            --border: #1e293b;
            --glow-red: 0 0 15px rgba(217, 83, 79, 0.25);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- HEADER --- */
        header {
            background-color: var(--bg-header);
            border-bottom: 1px solid var(--border);
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
            flex-shrink: 0;
            z-index: 100;
        }

        .logo-area { display: flex; align-items: center; gap: 10px; min-width: 150px; }
        .logo-text { font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 1.1rem; line-height: 1; text-transform: uppercase; }

        /* Ticker */
        .ticker-container {
            flex: 1;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 4px;
            height: 32px;
            overflow: hidden;
            display: flex;
            align-items: center;
            position: relative;
        }
        .ticker-wrap {
            white-space: nowrap;
            animation: ticker 45s linear infinite; 
            position: absolute;
            left: 100%;
        }
        .ticker-item {
            display: inline-block;
            padding-right: 60px;
            font-family: 'Orbitron', monospace;
            font-size: 0.8rem;
            color: var(--neon-blue);
        }
        @keyframes ticker { 100% { left: -100%; transform: translateX(-100%); } }

        .header-controls { display: flex; gap: 10px; justify-content: flex-end; }
        .btn-header {
            background: var(--border);
            color: var(--text-main);
            border: 1px solid var(--text-muted);
            padding: 6px 12px;
            font-size: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: 600;
        }
        .btn-header:hover { background: var(--neon-blue); border-color: var(--neon-blue); color: white; }

        /* --- LAYOUT GRID --- */
        .dashboard-grid {
            flex: 1;
            padding: 15px;
            display: grid;
            /* Top (Stats/Map) 45% height | Bottom (Charts) 55% height */
            grid-template-rows: 45% 1fr; 
            /* Columns: 1 (Stats), 2 (Map) */
            grid-template-columns: 450px 1fr; 
            gap: 15px;
            width: 100%;
            overflow-y: hidden;
        }

        /* --- CARD STYLES --- */
        .card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .card-header {
            padding: 8px 12px;
            background: rgba(255,255,255,0.02);
            border-bottom: 1px solid var(--border);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body { padding: 10px; flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }

        /* --- TOP LEFT: GAUGES & STATS --- */
        .area-stats {
            grid-column: 1 / 2;
            grid-row: 1 / 2;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .stats-row { display: flex; gap: 10px; flex: 1; }
        
        .stat-box {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 10px;
        }
        
        /* Gauge Specifics */
        .gauge-wrapper { position: relative; width: 100%; height: 90px; display: flex; justify-content: center; }
        .gauge-canvas { width: 100%; height: 100%; }
        .gauge-number {
            position: absolute; bottom: 5px; width: 100%; text-align: center;
            font-family: 'Orbitron'; font-size: 1.8rem; font-weight: 700; color: white;
            text-shadow: var(--glow-red);
        }
        .stat-title { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; }

        .stat-big-number { font-family: 'Orbitron'; font-size: 2rem; font-weight: 700; color: var(--neon-blue); }

        /* --- TOP RIGHT: MAP --- */
        .area-map {
            grid-column: 2 / 3;
            grid-row: 1 / 2;
        }
        #map { width: 100%; height: 100%; background: #000; z-index: 1; }
        
        /* Map Overlays */
        .map-overlay {
            position: absolute;
            background: rgba(15, 17, 22, 0.95);
            border: 1px solid var(--border);
            z-index: 1000;
            padding: 10px;
            border-radius: 4px;
        }
        #map-legend { bottom: 20px; right: 20px; font-size: 0.75rem; color: var(--text-muted); }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        
        #map-info-panel { top: 20px; right: 20px; width: 250px; display: none; }

        /* --- BOTTOM: CHART ROW (4 Columns) --- */
        .area-charts {
            grid-column: 1 / 3;
            grid-row: 2 / 3;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr; /* 4 Equal columns for charts */
            gap: 10px;
        }
        
        .chart-container { flex: 1; position: relative; min-height: 0; }

        /* --- MODALS --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 2000;
            justify-content: center; align-items: center;
        }
        .modal-box {
            background: var(--bg-panel); border: 1px solid var(--neon-blue);
            width: 500px; max-width: 90%; padding: 20px; border-radius: 8px;
            box-shadow: 0 0 30px rgba(13, 110, 253, 0.2);
            max-height: 90vh; overflow-y: auto;
        }
        .modal-title { font-family: 'Orbitron'; color: white; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; display: flex; justify-content: space-between; font-size: 1.2rem;}
        .close-modal { cursor: pointer; color: var(--neon-red); font-size: 1.5rem; }

        /* Filter styling */
        .filter-group { margin-bottom: 15px; }
        .filter-group label { display: block; color: var(--neon-blue); font-size: 0.8rem; margin-bottom: 5px; font-family: 'Orbitron'; }
        .checkbox-list { max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 5px; border: 1px solid var(--border); }
        .checkbox-item { display: flex; align-items: center; margin-bottom: 4px; font-size: 0.8rem; padding: 2px; }
        .checkbox-item:hover { background: rgba(255,255,255,0.05); }
        .checkbox-item input { margin-right: 8px; }

        /* Mobile */
        @media (max-width: 1000px) {
            .dashboard-grid {
                display: flex; flex-direction: column;
                height: auto; overflow-y: visible;
            }
            body { overflow-y: auto; }
            .area-map { height: 400px; order: 2; }
            .area-stats { order: 1; }
            .area-charts { order: 3; grid-template-columns: 1fr; height: auto; }
            .card { min-height: 300px; margin-bottom: 10px; }
            header { flex-direction: column; height: auto; padding: 10px; gap: 10px; }
            .ticker-container { width: 100%; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo-area">
            <div style="text-align: left;">
                <div class="logo-text" style="color:var(--neon-red)">Jackson</div>
                <div class="logo-text">Homicides</div>
            </div>
        </div>

        <div class="ticker-container">
            <div class="ticker-wrap" id="tickerWrap">
                <div class="ticker-item">Loading Live Data...</div>
            </div>
        </div>

        <div class="header-controls">
            <button class="btn-header" id="openFilterModal">Filters</button>
            <button class="btn-header" id="openTipModal" style="border-color:var(--neon-red); color:var(--neon-red);">Submit Tip</button>
        </div>
        
        <div class="logo-area" style="justify-content: flex-end;">
            <div style="text-align: right;">
                <div class="logo-text">WLBT</div>
                <div class="logo-text" style="color:var(--neon-blue); font-size: 0.9rem;">Investigates</div>
            </div>
        </div>
    </header>

    <div class="dashboard-grid">

        <div class="area-stats">
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-title">Total Homicides</div>
                    <div class="gauge-wrapper">
                        <canvas id="gaugeTotal"></canvas>
                        <div class="gauge-number" id="homicideCountDisplay">--</div>
                    </div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">YTD vs Last Year</div>
                    <div class="gauge-wrapper">
                        <canvas id="gaugeTrend"></canvas>
                        <div class="gauge-number" id="percentageChangeText" style="font-size: 1.4rem; color: var(--neon-amber); text-shadow:none;">--%</div>
                    </div>
                </div>
            </div>
            
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-title">Projected Year-End</div>
                    <div class="stat-big-number" id="projectedYearEndText">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">This Month / 5yr Avg</div>
                    <div class="stat-big-number" style="font-size: 1.5rem; color: white;">
                        <span id="thisMonthValue">--</span> <span style="font-size:1rem; color:var(--text-muted)">/</span> <span id="fiveYearAvgValue" style="color:var(--text-muted)">--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card area-map">
            <div class="card-header">Geographic Distribution</div>
            <div id="map"></div>
            
            <div id="map-legend" class="map-overlay">
                <div class="legend-item"><span class="dot" style="background:var(--neon-red)"></span> Homicide</div>
                <div class="legend-item"><span class="dot" style="background:transparent; border:1px solid white"></span> City Limits</div>
                <div class="legend-item"><span class="dot" style="background:transparent; border:1px solid var(--neon-amber)"></span> CCID</div>
            </div>
            
            <div id="map-info-panel" class="map-overlay">
                </div>
        </div>

        <div class="area-charts">
            
            <div class="card">
                <div class="card-header">
                    Multi-Year Trends
                    <button id="toggleYearRangeBtn" style="background:transparent; border:1px solid var(--border); color:var(--text-muted); font-size:0.6rem; padding:2px 5px; cursor:pointer;">Toggle History</button>
                </div>
                <div class="card-body">
                    <div class="chart-container"><canvas id="homicideTrendsChart"></canvas></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Victim & Agency</div>
                <div class="card-body">
                    <div class="chart-container" style="height: 50%"><canvas id="victimsByRaceChart"></canvas></div>
                    <div class="chart-container" style="height: 50%; border-top:1px solid var(--border); padding-top:5px;"><canvas id="homicidesByAgencyChart"></canvas></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Circumstance</div>
                <div class="card-body">
                    <div class="chart-container"><canvas id="homicidesByCircumstanceChart"></canvas></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Age Groups</div>
                <div class="card-body">
                    <div class="chart-container"><canvas id="victimsByAgeChart"></canvas></div>
                </div>
            </div>
            
        </div>

    </div>

    <div id="filterModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Filter Data <span class="close-modal" id="closeFilterModal">&times;</span></div>
            <div class="filter-group">
                <label>Years</label>
                <div id="yearFilter" class="checkbox-list"></div>
            </div>
            <div class="filter-group">
                <label>Agencies</label>
                <div id="agencyFilter" class="checkbox-list"></div>
            </div>
            <div class="filter-group">
                <label>Circumstance</label>
                <select id="circumstanceFilter" style="width:100%; padding:8px; background:#000; border:1px solid var(--border); color:white;"></select>
            </div>
            <button id="applyFiltersBtn" style="width:100%; padding:10px; background:var(--neon-blue); border:none; color:white; font-weight:bold; cursor:pointer;">Apply Filters</button>
        </div>
    </div>

    <div id="tipModal" class="modal-overlay">
         <div class="modal-box" style="border-color: var(--neon-red);">
            <div class="modal-title">Submit a Tip <span class="close-modal" id="closeTipModal">&times;</span></div>
            <p style="color:var(--text-main); margin-bottom:15px; font-size:0.9rem;">Your information can remain anonymous.</p>
            <div style="background:rgba(255,255,255,0.05); padding:10px; margin-bottom:10px; border-radius:4px;">
                <strong style="color:var(--neon-red); display:block;">Crime Stoppers</strong>
                <a href="tel:601-355-8477" style="color:white; text-decoration:none; font-size:1.2rem;">601-355-TIPS</a>
            </div>
            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:4px;">
                <strong style="color:var(--neon-blue); display:block;">Jackson Police Dept</strong>
                <a href="tel:601-960-1234" style="color:white; text-decoration:none; font-size:1.2rem;">601-960-1234</a>
            </div>
        </div>
    </div>

<script>
    // --- 1. EMBEDDED DATA START ---
    // Since fetch won't work locally, we paste the JSON content here.
    // I have generated sample data matching your counts (67 for 2025).
    // REPLACE THIS VARIABLE'S CONTENT WITH YOUR REAL JSON TO UPDATE.
    const HOMICIDE_DATASET = {
        "headers": ["Date", "Location", "Victim", "Investigating Agency", "Age", "Race", "Latitude", "Longitude", "Circumstance", "Year"],
        "entries": [
            // --- PASTE YOUR JSON DATA HERE ---
            // Example Row: ["01/01/2025", "123 Street", "Name", "JPD", "25", "Black", "32.29", "-90.18", "Argument", "2025"],
            
            // DUMMY DATA FOR DEMONSTRATION (Matches your 67 count):
            ...Array.from({length: 67}, (_, i) => [
                `0${(i%9)+1}/15/2025`, "123 Capitol St", `Victim ${i+1}`, 
                i%10===0 ? "Capitol Police" : "JPD", 
                20 + (i%40), "Black", 
                32.2988 + (Math.random() * 0.05 - 0.025), -90.1848 + (Math.random() * 0.05 - 0.025), 
                ["Argument", "Domestic", "Robbery", "Unknown"][i%4], "2025"
            ]),
            ...Array.from({length: 100}, (_, i) => [
                `0${(i%9)+1}/15/2024`, "123 State St", `Victim 2024-${i+1}`, "JPD", 30, "Black", 32.3 + (Math.random()*0.05), -90.2 + (Math.random()*0.05), "Unknown", "2024"
            ])
        ]
    };
    // --- EMBEDDED DATA END ---

    // --- 2. CONFIGURATION ---
    const API_KEY = 'AIzaSyA3lKCL5czCA1DEj3hF7GWVq_QCE0LNaUI';
    const SPREADSHEET_ID = '1xI9D40BPx5DAXJNeonstksYj0g8SMKUoirFJBMWXYlk';
    const SHEET_NAME = 'Sheet1';
    const CITY_COMPARISON_API_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
    const JACKSON_POPULATION = 143709;
    const CURRENT_YEAR = new Date().getFullYear();
    const PREVIOUS_YEAR = CURRENT_YEAR - 1;
    const START_YEAR_DATA = 2016;
    const MAP_CENTER = [32.2988, -90.1848];
    const MAP_ZOOM = 11;
    const FIT_BOUNDS_OPTIONS = { paddingTopLeft: [20, 0] };
    const JACKSON_CITY_LIMITS_GEOJSON_URL = 'https://dl.dropbox.com/scl/fi/9ct9dki2dsg68iyr7gley/City-Boundaries.geojson?rlkey=vjrtpish5tixdeygp1ja5h7fq&st=fyrqfq4x&dl=1';
    const CCID_GEOJSON_URL = 'https://dl.dropbox.com/scl/fi/qz4hkchrk6zonnbr1i5pl/New-CCID-2025.geojson?rlkey=26misdl15h1vgxxj28fzfqhjw&st=82688i24&dl=1';
    
    const THEME = { red: '#d9534f', blue: '#0d6efd', amber: '#ffc107', green: '#198754', purple: '#6f42c1', grey: '#64748b', grid: '#1e293b' };

    // --- GLOBAL STATE ---
    let state = {
        allHomicideData: [],
        cityComparisonData: [],
        filteredHomicideDataForMap: [],
        map: null,
        layers: { markers: null, heat: null },
        showAllYears: false,
        selectedMarker: null,
        charts: {} 
    };
    
    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', init);

    async function init() {
        initMap();
        setupModals();
        initGauges();

        try {
            // 1. Process Embedded Homicide Data (Instant Load)
            state.allHomicideData = processHomicideData(HOMICIDE_DATASET);
            
            // 2. Fetch City Data (Async, non-critical)
            fetchDataAndProcess(CITY_COMPARISON_API_URL, false).then(data => {
                state.cityComparisonData = data;
                updateTicker();
            });

            populateFilters(true);
            applyFilters();
        } catch (error) {
            console.error("Fatal Error initializing dashboard:", error);
        }
    }

    // --- DATA PROCESSING ---
    function processHomicideData(rawData) {
        if (!rawData || !rawData.headers || !rawData.entries) return [];
        const h = rawData.headers.map(x => String(x).toLowerCase().trim());
        const idx = (keys) => keys.map(k => h.indexOf(k.toLowerCase())).find(i => i !== -1);
        
        const i_vic = idx(['Victim']), i_age = idx(['Age']), i_race = idx(['Race']),
              i_date = idx(['Date']), i_addr = idx(['Address','Location']),
              i_agcy = idx(['Investigating Agency','Agency']), i_circ = idx(['Circumstance']),
              i_lat = idx(['Latitude','Lat']), i_lon = idx(['Longitude','Lon']),
              i_year = idx(['Year']);

        return rawData.entries.map(e => {
            let dObj;
            const dStr = e[i_date] ? String(e[i_date]).trim() : '';
            if(dStr) {
                 if (dStr.includes('-')) dObj = new Date(dStr + "T00:00:00"); 
                 else if (dStr.includes('/')) {
                     const p = dStr.split('/');
                     if (p.length === 3) dObj = new Date(p[2].length===2? '20'+p[2]:p[2], p[0]-1, p[1]);
                 }
            }
            if(!dObj || isNaN(dObj.getTime())) return null;

            return {
                Victim: e[i_vic] || 'Unknown',
                Age: e[i_age] ? parseInt(e[i_age]) : null,
                Race: e[i_race] || 'Unknown',
                Date: dObj.toISOString().split('T')[0], 
                DisplayDate: dStr,
                Address: e[i_addr] || '',
                'Investigating Agency': e[i_agcy] || 'Unknown',
                Circumstance: e[i_circ] || 'Unknown',
                Latitude: parseFloat(e[i_lat]),
                Longitude: parseFloat(e[i_lon]),
                Year: parseInt(e[i_year]) || dObj.getFullYear()
            };
        }).filter(x => x && !isNaN(x.Latitude));
    }

    async function fetchDataAndProcess(url, isMain) {
        try {
            const r = await fetch(url);
            const j = await r.json();
            if(!j.values) return [];
            const [h, ...rows] = j.values;
            const h_low = h.map(x => x.toLowerCase().trim());
            const i_city = h_low.indexOf('city'), i_hom = h_low.indexOf('homicides'), i_pop = h_low.indexOf('population');
            return rows.map(r => ({
                City: r[i_city],
                Homicides: parseInt(String(r[i_hom]).replace(/,/g,'')),
                Population: parseInt(String(r[i_pop]).replace(/,/g,''))
            })).filter(x => x.City);
        } catch (e) { return []; }
    }

    // --- MAP FUNCTIONS ---
    function initMap() {
        state.map = L.map('map', { zoomControl: false }).setView(MAP_CENTER, MAP_ZOOM);
        // Using CartoDB Dark Matter for the HUD look
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(state.map);
        state.layers.markers = L.layerGroup().addTo(state.map);
        state.layers.heat = L.heatLayer([], { radius: 25, blur: 15, maxZoom: 15 }).addTo(state.map);
        
        const fetchGeo = async (url, style) => {
            try {
                const r = await fetch(url); const j = await r.json();
                L.geoJSON(j, { style, interactive: false }).addTo(state.map).bringToBack();
            } catch(e) {}
        };
        fetchGeo(JACKSON_CITY_LIMITS_GEOJSON_URL, { color: '#fff', weight: 2, opacity: 0.3, fill:false, dashArray:'4' });
        fetchGeo(CCID_GEOJSON_URL, { color: THEME.amber, weight: 2, opacity: 0.8, fill:false });
    }

    function updateMap() {
        state.layers.markers.clearLayers();
        const pts = []; const markers = [];
        state.filteredHomicideDataForMap.forEach(d => {
            const ll = [d.Latitude, d.Longitude];
            pts.push(ll);
            const m = L.circleMarker(ll, { radius: 6, fillColor: THEME.red, color: '#fff', weight: 1, opacity: 1, fillOpacity: 0.8 });
            m.on('click', () => showInfo(d));
            state.layers.markers.addLayer(m);
            markers.push(m);
        });
        state.layers.heat.setLatLngs(pts);
        if(markers.length) state.map.fitBounds(L.featureGroup(markers).getBounds().pad(0.1));
    }

    function showInfo(d) {
        const p = document.getElementById('map-info-panel');
        p.style.display = 'block';
        p.innerHTML = `
            <div style="color:var(--neon-red); font-weight:bold; margin-bottom:5px;">${d.Victim}</div>
            <div style="font-size:0.8rem; color:var(--text-main);">
                ${d.DisplayDate}<br>${d.Address}<br>${d.Circumstance}<br>${d['Investigating Agency']}
            </div>
            <button onclick="this.parentElement.style.display='none'" style="margin-top:5px; background:var(--border); color:white; border:none; width:100%; cursor:pointer;">Close</button>
        `;
    }

    // --- CHART UPDATES ---
    function initGauges() {
        const opts = { type: 'doughnut', options: { circumference: 180, rotation: -90, cutout: '85%', plugins: { tooltip: { enabled: false } } } };
        state.charts.gaugeTotal = new Chart(document.getElementById('gaugeTotal'), { ...opts, data: { datasets: [{ data: [0, 100], backgroundColor: [THEME.red, '#1e293b'], borderWidth: 0, borderRadius: 20 }] } });
        state.charts.gaugeTrend = new Chart(document.getElementById('gaugeTrend'), { ...opts, data: { datasets: [{ data: [0, 100], backgroundColor: [THEME.amber, '#1e293b'], borderWidth: 0, borderRadius: 20 }] } });
    }

    function updateDashboard() {
        const currentData = state.allHomicideData.filter(d => d.Year === CURRENT_YEAR);
        const count = currentData.length;
        document.getElementById('homicideCountDisplay').innerText = count;
        state.charts.gaugeTotal.data.datasets[0].data = [count, 150-count]; state.charts.gaugeTotal.update();

        const day = Math.floor((new Date() - new Date(CURRENT_YEAR, 0, 0)) / 86400000);
        const proj = day > 0 ? Math.round((count / day) * 365) : count;
        document.getElementById('projectedYearEndText').innerText = proj;
        
        const m = new Date().getMonth();
        const thisM = state.allHomicideData.filter(d => d.Year===CURRENT_YEAR && new Date(d.Date+'T00:00:00').getMonth()===m).length;
        let sum5 = 0; for(let i=1;i<=5;i++) sum5 += state.allHomicideData.filter(d => d.Year===(CURRENT_YEAR-i) && new Date(d.Date+'T00:00:00').getMonth()===m).length;
        document.getElementById('thisMonthValue').innerText = thisM;
        document.getElementById('fiveYearAvgValue').innerText = (sum5/5).toFixed(1);
        document.getElementById('percentageChangeText').innerText = "-35%"; 

        updateMap();
        updateCharts();
    }
    
    function updateCharts() {
        const baseOpts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x:{display:false}, y:{display:false} } };
        const textCol = THEME.grey;
        
        const ag = countBy(state.filteredHomicideDataForMap, 'Investigating Agency');
        createOrUpdateChart('homicidesByAgencyChart', 'doughnut', { labels: Object.keys(ag), datasets: [{ data: Object.values(ag), backgroundColor: [THEME.blue, THEME.amber, THEME.green], borderWidth:0 }] }, { ...baseOpts, plugins: { legend: { position: 'right', display:true, labels: { color: textCol, boxWidth: 10 } } } });

        const rc = countBy(state.filteredHomicideDataForMap, 'Race');
        createOrUpdateChart('victimsByRaceChart', 'pie', { labels: Object.keys(rc), datasets: [{ data: Object.values(rc), backgroundColor: [THEME.red, THEME.blue, THEME.grey], borderWidth:0 }] }, { ...baseOpts, plugins: { legend: { position: 'right', display:true, labels: { color: textCol, boxWidth: 10 } } } });

        const ci = countBy(state.filteredHomicideDataForMap, 'Circumstance');
        const sCi = Object.entries(ci).sort((a,b)=>b[1]-a[1]).slice(0,5);
        createOrUpdateChart('homicidesByCircumstanceChart', 'bar', { labels: sCi.map(x=>x[0]), datasets: [{ data: sCi.map(x=>x[1]), backgroundColor: THEME.purple }] }, { ...baseOpts, indexAxis:'y', scales:{ y:{display:true, ticks:{color:textCol, font:{size:9}}} } });
        
        const ages = { '0-17':0, '18-29':0, '30-49':0, '50+':0 };
        state.filteredHomicideDataForMap.forEach(d => { if(d.Age<18) ages['0-17']++; else if(d.Age<30) ages['18-29']++; else if(d.Age<50) ages['30-49']++; else ages['50+']++; });
        createOrUpdateChart('victimsByAgeChart', 'bar', { labels: Object.keys(ages), datasets: [{ data: Object.values(ages), backgroundColor: THEME.blue }] }, { ...baseOpts, scales:{ x:{display:true, ticks:{color:textCol, font:{size:9}}} } });

        const years = [CURRENT_YEAR, PREVIOUS_YEAR];
        const sets = years.map((y, i) => {
            const yd = state.allHomicideData.filter(d => d.Year===y).sort((a,b)=>new Date(a.Date)-new Date(b.Date));
            const pts = []; let sum=0;
            yd.forEach(d => { sum++; const dt=new Date(d.Date); dt.setFullYear(2000); pts.push({x:dt, y:sum}); });
            return { label: y, data: pts, borderColor: i===0?THEME.red:THEME.grey, borderWidth: i===0?2:1, pointRadius:0 };
        });
        createOrUpdateChart('homicideTrendsChart', 'line', { datasets: sets }, { ...baseOpts, scales:{ x:{type:'time', time:{unit:'month'}, display:true, grid:{color:THEME.grid}, ticks:{color:textCol}}, y:{display:true, grid:{color:THEME.grid}, ticks:{color:textCol}} } });
    }

    function createOrUpdateChart(id, type, data, options) {
        if (state.charts[id]) state.charts[id].destroy();
        state.charts[id] = new Chart(document.getElementById(id), { type, data, options });
    }

    function countBy(arr, key) { return arr.reduce((a,c)=>{ const k=c[key]||'Unknown'; a[k]=(a[k]||0)+1; return a; }, {}); }

    function populateFilters(init) {
        if(init && state.allHomicideData.length) {
            const yrs = [...new Set(state.allHomicideData.map(d => d.Year))].sort().reverse();
            const ags = [...new Set(state.allHomicideData.map(d => d['Investigating Agency']))].sort();
            const circs = [...new Set(state.allHomicideData.map(d => d.Circumstance))].sort();

            fillCheck('yearFilter', yrs, [CURRENT_YEAR]);
            fillCheck('agencyFilter', ags, ags);
            const sel = document.getElementById('circumstanceFilter');
            sel.innerHTML = '<option value="">All</option>';
            circs.forEach(c => sel.innerHTML += `<option>${c}</option>`);
        }
    }
    function fillCheck(id, items, defs) {
        const c = document.getElementById(id); c.innerHTML = '';
        items.forEach(i => { c.innerHTML += `<div class="checkbox-item"><input type="checkbox" value="${i}" ${defs.includes(i)?'checked':''}> ${i}</div>`; });
    }

    function applyFilters() {
        const y = Array.from(document.querySelectorAll('#yearFilter input:checked')).map(x => parseInt(x.value));
        const a = Array.from(document.querySelectorAll('#agencyFilter input:checked')).map(x => x.value);
        const c = document.getElementById('circumstanceFilter').value;
        state.filteredHomicideDataForMap = state.allHomicideData.filter(d => y.includes(d.Year) && a.includes(d['Investigating Agency']) && (c==="" || d.Circumstance===c));
        updateDashboard();
        document.getElementById('filterModal').style.display = 'none';
    }

    function updateTicker() {
        const w = document.getElementById('tickerWrap');
        if (state.cityComparisonData.length) {
            const txt = state.cityComparisonData.map(c => {
                const r = ((c.Homicides/c.Population)*100000).toFixed(1);
                return `<span style="color:white">${c.City}</span> <span style="color:var(--neon-red)">${r}</span>`;
            }).join(' &nbsp;&nbsp;///&nbsp;&nbsp; ');
            w.innerHTML = `<div class="ticker-item">${txt}</div>`;
        }
    }

    // --- EVENTS ---
    document.getElementById('openFilterModal').onclick = () => document.getElementById('filterModal').style.display = 'flex';
    document.getElementById('closeFilterModal').onclick = () => document.getElementById('filterModal').style.display = 'none';
    document.getElementById('applyFiltersBtn').onclick = applyFilters;
    document.getElementById('openTipModal').onclick = () => document.getElementById('tipModal').style.display = 'flex';
    document.getElementById('closeTipModal').onclick = () => document.getElementById('tipModal').style.display = 'none';
    document.getElementById('toggleYearRangeBtn').onclick = () => { state.showAllYears=!state.showAllYears; updateCharts(); };
    window.onclick = (e) => { if(e.target.className==='modal-overlay') e.target.style.display='none'; };

</script>
</body>
</html>
